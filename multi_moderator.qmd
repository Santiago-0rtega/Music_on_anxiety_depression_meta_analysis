---
title: "Multi_moderator"
---

```{r}
#| label: setup
#| include: false
pacman::p_load(
               DT,
               dtplyr,
               here, 
               knitr,
               tidyverse,
               patchwork,
               metafor,
               orchaRd, GoodmanKruskal
               )

#| label: load_and_clean_data
db <- readr::read_csv(here("data","db_lnRR.csv")) %>%
mutate(across(c(C_n, Ex_n, C_mean, Ex_mean, C_SE, Ex_SE, C_SD, Ex_SD), as.numeric))%>%
  mutate(across(where(is.character), as.factor))




```

| **`Control_condition`**\| Description of the control group condition. Levels: **white noise**, **ambient noise** \|
| **`Assay_type`** \| Type of behavioral test used. \|

\|\*\*`Overall_rob`

```{r}



moderators_to_check <- c(
  "Outcome_type", 
  "Lifestage_exposure", 
  "Sex", 
  "Meta_genre", 
  "Music_exposure_duration", 
  "Experimental_design", 
  "Induced behaviour", 
  "Relative_timing", 
  "Experimental_procedures", "Control_conditions", "Assay_type"
)



dat_mods <- db %>% 
  dplyr::select(all_of(moderators_to_check))


corr_cat <- GKtauDataframe(dat_mods)

plot(corr_cat)
```

```{r}
VCV <- metafor::vcalc(
  vi = lnRR_var,
  cluster = Cohort_ID, # The clustering variable (Study_ID + Ex_ID)
  obs = ES_ID,         # The unique observation/effect size ID
  rho = 0.5,           # Assumed correlation between outcomes from the same cohort
  data = db 
)
```

```{r}


moderators <- c( "Lifestage_exposure", "Sex", "Meta_genre", 
  "Music_exposure_duration", "Experimental_design", 
  "Induced behaviour", "Relative_timing", "Experimental_procedures", "Control_conditions", "Assay_type")


# Initialize the filtered dataset to the full data
db_final <- db

# Store the original row indices (to correctly subset the VCV matrix later)
original_indices <- 1:nrow(db)

# --- Apply Sequential Filtering ---
for (mod in moderators) {
  
  # Ensure the column name is correctly quoted for use with dplyr/summarise
  mod_sym <- sym(mod) 
  
  # Calculate k_es for the CURRENT filtered dataset
  k_counts <- db_final %>%
    group_by(!!mod_sym) %>%
    summarise(k_es = n(), .groups = 'drop')

  # Identify levels to keep (where k_es >= 5)
  levels_to_keep_mod <- k_counts %>%
    filter(k_es >= 5) %>%
    pull(!!mod_sym)

  # Filter the dataset
  rows_before <- nrow(db_final)
  db_final <- db_final %>%
    filter(!!mod_sym %in% levels_to_keep_mod)
    
  rows_after <- nrow(db_final)
  
  # Optional: Print filtering status
  # print(paste("Moderator:", mod, "Filtered out:", rows_before - rows_after, "ESs"))
}

# --- Final Output Preparation ---

# 1. Drop unused factor levels from the final data frame
db_final <- db_final %>% mutate(across(all_of(moderators), droplevels))

# 2. Get the row indices from the *original* 'db' data frame that are still present in db_final
# Use a unique identifier like ES_ID or a combination of identifiers for matching
indices_to_keep <- which(db$ES_ID %in% db_final$ES_ID) 

# 3. Final VCV Matrix
VCV_final <- VCV[indices_to_keep, indices_to_keep]

print("--- Final Filtered Data ---")
print(paste("Original dataset size:", nrow(db)))
print(paste("Final dataset size:", nrow(db_final), "ES_IDs"))
print(paste("Number of moderators included:", length(moderators)))
```
"Lifestage_exposure", "Sex", "Meta_genre", 
  "Music_exposure_duration", "Experimental_design", 
  "Induced behaviour", "Relative_timing", "Experimental_procedures", "Control_conditions", "Assay_type"
  
  
  
  
  
```{r}


mMULTI<- rma.mv(yi = lnRR,
                 V = VCV_final, 
                 mods = ~   Lifestage_exposure + 
                            Assay_type+
                            `Induced behaviour` +
                            Sex +  
                  Meta_genre + 
                  Music_exposure_duration +
                  Experimental_design +
                  Relative_timing +
                  Experimental_procedures +
                  Control_conditions
                  ,
                 random = list(~1 | Study_ID, 
                               ~1 | ES_ID, 
                               ~1 | Strain),
                 test = "t",      
                 method = "REML",
                 sparse = TRUE,
                 data = db_final)

summary(mMULTI)
```

```{r}
r2MULTI <- round(r2_ml(mMULTI), 4)
r2MULTI
```


## Sex

```{r}


mMULTI<- rma.mv(yi = lnRR,
                 V = VCV_final, 
                 mods = ~   Lifestage_exposure + 
                            Assay_type+
                            `Induced behaviour` +
                  Meta_genre + 
                  Music_exposure_duration +
                  Experimental_design +
                  Relative_timing +
                  Experimental_procedures +
                  Control_conditions
                  ,
                 random = list(~1 | Study_ID, 
                               ~1 | ES_ID, 
                               ~1 | Strain),
                 test = "t",      
                 method = "REML",
                 sparse = TRUE,
                 data = db_final)


r2MULTI <- round(r2_ml(mMULTI), 4)
r2MULTI
```
## Meta_genre
```{r}


mMULTI<- rma.mv(yi = lnRR,
                 V = VCV_final, 
                 mods = ~   Lifestage_exposure + 
                            Assay_type+
                            `Induced behaviour` +
                            Sex +  
                 
                  Music_exposure_duration +
                  Experimental_design +
                  Relative_timing +
                  Experimental_procedures +
                  Control_conditions
                  ,
                 random = list(~1 | Study_ID, 
                               ~1 | ES_ID, 
                               ~1 | Strain),
                 test = "t",      
                 method = "REML",
                 sparse = TRUE,
                 data = db_final)


r2MULTI <- round(r2_ml(mMULTI), 4)
r2MULTI
```

## Music_exposure_duration


  
```{r}


mMULTI<- rma.mv(yi = lnRR,
                 V = VCV_final, 
                 mods = ~   Lifestage_exposure + 
                            Assay_type+
                            `Induced behaviour` +
                            Sex +  
                  Meta_genre + 
                  Experimental_design +
                  Relative_timing +
                  Experimental_procedures +
                  Control_conditions
                  ,
                 random = list(~1 | Study_ID, 
                               ~1 | ES_ID, 
                               ~1 | Strain),
                 test = "t",      
                 method = "REML",
                 sparse = TRUE,
                 data = db_final)


r2MULTI <- round(r2_ml(mMULTI), 4)
r2MULTI
```
## Experimental_design
  
```{r}


mMULTI<- rma.mv(yi = lnRR,
                 V = VCV_final, 
                 mods = ~   Lifestage_exposure + 
                            Assay_type+
                            `Induced behaviour` +
                            Sex +  
                  Meta_genre + 
                  Music_exposure_duration +
                  Relative_timing +
                  Experimental_procedures +
                  Control_conditions
                  ,
                 random = list(~1 | Study_ID, 
                               ~1 | ES_ID, 
                               ~1 | Strain),
                 test = "t",      
                 method = "REML",
                 sparse = TRUE,
                 data = db_final)


r2MULTI <- round(r2_ml(mMULTI), 4)
r2MULTI
```

## relative_timing
```{r}


mMULTI<- rma.mv(yi = lnRR,
                 V = VCV_final, 
                 mods = ~   Lifestage_exposure + 
                            Assay_type+
                            `Induced behaviour` +
                            Sex +  
                  Meta_genre + 
                  Music_exposure_duration +
                  Experimental_design +
                  Experimental_procedures +
                  Control_conditions
                  ,
                 random = list(~1 | Study_ID, 
                               ~1 | ES_ID, 
                               ~1 | Strain),
                 test = "t",      
                 method = "REML",
                 sparse = TRUE,
                 data = db_final)


r2MULTI <- round(r2_ml(mMULTI), 4)
r2MULTI
```


## Experimental_procedures
```{r}


mMULTI<- rma.mv(yi = lnRR,
                 V = VCV_final, 
                 mods = ~   Lifestage_exposure + 
                            Assay_type+
                            `Induced behaviour` +
                            Sex +  
                  Meta_genre + 
                  Music_exposure_duration +
                  Experimental_design +
                  Relative_timing +
                  Control_conditions
                  ,
                 random = list(~1 | Study_ID, 
                               ~1 | ES_ID, 
                               ~1 | Strain),
                 test = "t",      
                 method = "REML",
                 sparse = TRUE,
                 data = db_final)


r2MULTI <- round(r2_ml(mMULTI), 4)
r2MULTI
```

## control_conditions

```{r}


mMULTI<- rma.mv(yi = lnRR,
                 V = VCV_final, 
                 mods = ~   Lifestage_exposure + 
                            Assay_type+
                            `Induced behaviour` +
                            Sex +  
                  Meta_genre + 
                  Music_exposure_duration +
                  Experimental_design +
                  Relative_timing +
                  Experimental_procedures 
                  ,
                 random = list(~1 | Study_ID, 
                               ~1 | ES_ID, 
                               ~1 | Strain),
                 test = "t",      
                 method = "REML",
                 sparse = TRUE,
                 data = db_final)


r2MULTI <- round(r2_ml(mMULTI), 4)
r2MULTI
```



## Best so far

```{r}


mMULTI<- rma.mv(yi = lnRR,
                 V = VCV_final, 
                 mods = ~   Lifestage_exposure + 
                            Assay_type+
                            `Induced behaviour` +
                            Sex +  
                  Meta_genre + 
                  Experimental_design +
                  Relative_timing +
                  Experimental_procedures +
                  Control_conditions
                  ,
                 random = list(~1 | Study_ID, 
                               ~1 | ES_ID, 
                               ~1 | Strain),
                 test = "t",      
                 method = "REML",
                 sparse = TRUE,
                 data = db_final)


summary(mMULTI)
```

```{r}
r2MULTI <- round(r2_ml(mMULTI), 4)
r2MULTI
```



## Sex


```{r}


mMULTI<- rma.mv(yi = lnRR,
                 V = VCV_final, 
                 mods = ~   Lifestage_exposure + 
                            Assay_type+
                            `Induced behaviour` +
                  Meta_genre + 
                  Experimental_design +
                  Relative_timing +
                  Experimental_procedures +
                  Control_conditions
                  ,
                 random = list(~1 | Study_ID, 
                               ~1 | ES_ID, 
                               ~1 | Strain),
                 test = "t",      
                 method = "REML",
                 sparse = TRUE,
                 data = db_final)



r2MULTI <- round(r2_ml(mMULTI), 4)
r2MULTI
```
## Meta_genre
```{r}
mMULTI<- rma.mv(yi = lnRR,
                 V = VCV_final, 
                 mods = ~   Lifestage_exposure + 
                            Assay_type+
                            `Induced behaviour` +
                            Sex +  
                  Experimental_design +
                  Relative_timing +
                  Experimental_procedures +
                  Control_conditions
                  ,
                 random = list(~1 | Study_ID, 
                               ~1 | ES_ID, 
                               ~1 | Strain),
                 test = "t",      
                 method = "REML",
                 sparse = TRUE,
                 data = db_final)



r2MULTI <- round(r2_ml(mMULTI), 4)
r2MULTI
```
## experimental_design
```{r}
mMULTI<- rma.mv(yi = lnRR,
                 V = VCV_final, 
                 mods = ~   Lifestage_exposure + 
                            Assay_type+
                            `Induced behaviour` +
                            Sex +  
                  Meta_genre + 
                  Relative_timing +
                  Experimental_procedures +
                  Control_conditions
                  ,
                 random = list(~1 | Study_ID, 
                               ~1 | ES_ID, 
                               ~1 | Strain),
                 test = "t",      
                 method = "REML",
                 sparse = TRUE,
                 data = db_final)



r2MULTI <- round(r2_ml(mMULTI), 4)
r2MULTI
```

## relative_timing

```{r}
mMULTI<- rma.mv(yi = lnRR,
                 V = VCV_final, 
                 mods = ~   Lifestage_exposure + 
                            Assay_type+
                            `Induced behaviour` +
                            Sex +  
                  Meta_genre + 
                  Experimental_design +
                  Experimental_procedures +
                  Control_conditions
                  ,
                 random = list(~1 | Study_ID, 
                               ~1 | ES_ID, 
                               ~1 | Strain),
                 test = "t",      
                 method = "REML",
                 sparse = TRUE,
                 data = db_final)



r2MULTI <- round(r2_ml(mMULTI), 4)
r2MULTI
```



## experimental_procedures
```{r}
mMULTI<- rma.mv(yi = lnRR,
                 V = VCV_final, 
                 mods = ~   Lifestage_exposure + 
                            Assay_type+
                            `Induced behaviour` +
                            Sex +  
                  Meta_genre + 
                  Experimental_design +
                  Relative_timing +
                  Control_conditions
                  ,
                 random = list(~1 | Study_ID, 
                               ~1 | ES_ID, 
                               ~1 | Strain),
                 test = "t",      
                 method = "REML",
                 sparse = TRUE,
                 data = db_final)



r2MULTI <- round(r2_ml(mMULTI), 4)
r2MULTI
```
## control_conditions

```{r}
mMULTI<- rma.mv(yi = lnRR,
                 V = VCV_final, 
                 mods = ~   Lifestage_exposure + 
                            Assay_type+
                            `Induced behaviour` +
                            Sex +  
                  Meta_genre + 
                  Experimental_design +
                  Relative_timing +
                  Experimental_procedures 
                  ,
                 random = list(~1 | Study_ID, 
                               ~1 | ES_ID, 
                               ~1 | Strain),
                 test = "t",      
                 method = "REML",
                 sparse = TRUE,
                 data = db_final)



r2MULTI <- round(r2_ml(mMULTI), 4)
r2MULTI
```


## new best 

```{r}
mMULTI<- rma.mv(yi = lnRR,
                 V = VCV_final, 
                 mods = ~   Lifestage_exposure + 
                            Assay_type+
                            `Induced behaviour` +
                            Sex +  
                  Meta_genre + 
                  Experimental_design +
                  Relative_timing +
                  Control_conditions
                  ,
                 random = list(~1 | Study_ID, 
                               ~1 | ES_ID, 
                               ~1 | Strain),
                 test = "t",      
                 method = "REML",
                 sparse = TRUE,
                 data = db_final)



r2MULTI <- round(r2_ml(mMULTI), 4)
r2MULTI
```
## meta_genre



```{r}
mMULTI<- rma.mv(yi = lnRR,
                 V = VCV_final, 
                 mods = ~   Lifestage_exposure + 
                            Assay_type+
                            `Induced behaviour` +
                            Sex +  
                  Experimental_design +
                  Relative_timing +
                  Control_conditions
                  ,
                 random = list(~1 | Study_ID, 
                               ~1 | ES_ID, 
                               ~1 | Strain),
                 test = "t",      
                 method = "REML",
                 sparse = TRUE,
                 data = db_final)



r2MULTI <- round(r2_ml(mMULTI), 4)
r2MULTI
```

```{r}
summary(mMULTI)
```


## experimental_design
```{r}
mMULTI<- rma.mv(yi = lnRR,
                 V = VCV_final, 
                 mods = ~   Lifestage_exposure + 
                            Assay_type+
                            `Induced behaviour` +
                            Sex +  
                  Meta_genre + 
                  Relative_timing +
                  Control_conditions
                  ,
                 random = list(~1 | Study_ID, 
                               ~1 | ES_ID, 
                               ~1 | Strain),
                 test = "t",      
                 method = "REML",
                 sparse = TRUE,
                 data = db_final)



r2MULTI <- round(r2_ml(mMULTI), 4)
r2MULTI
```

## relative_timing

```{r}
mMULTI<- rma.mv(yi = lnRR,
                 V = VCV_final, 
                 mods = ~   Lifestage_exposure + 
                            Assay_type+
                            `Induced behaviour` +
                            Sex +  
                  Meta_genre + 
                  Experimental_design +
                  Control_conditions
                  ,
                 random = list(~1 | Study_ID, 
                               ~1 | ES_ID, 
                               ~1 | Strain),
                 test = "t",      
                 method = "REML",
                 sparse = TRUE,
                 data = db_final)



r2MULTI <- round(r2_ml(mMULTI), 4)
r2MULTI
```




```{r}
summary(mMULTI)
```



## control_conditions

```{r}
mMULTI<- rma.mv(yi = lnRR,
                 V = VCV_final, 
                 mods = ~   Lifestage_exposure + 
                            Assay_type+
                            `Induced behaviour` +
                            Sex +  
                  Meta_genre + 
                  Experimental_design +
                  Relative_timing 
                  ,
                 random = list(~1 | Study_ID, 
                               ~1 | ES_ID, 
                               ~1 | Strain),
                 test = "t",      
                 method = "REML",
                 sparse = TRUE,
                 data = db_final)



r2MULTI <- round(r2_ml(mMULTI), 4)
r2MULTI
```





# the best

```{r}
mMULTI<- rma.mv(yi = lnRR,
                 V = VCV_final, 
                 mods = ~   Lifestage_exposure + 
                            Assay_type+
                            `Induced behaviour` +
                            Sex +  
                  Meta_genre + 
                  Experimental_design +
                  Relative_timing +
                  Control_conditions-1
                  ,
                 random = list(~1 | Study_ID, 
                               ~1 | ES_ID, 
                               ~1 | Strain),
                 test = "t",      
                 method = "REML",
                 sparse = TRUE,
                 data = db_final)

summary(mMULTI)


```







```{r}

r2MULTI <- round(r2_ml(mMULTI), 4)
r2MULTI

```


```{r}

```
















https://osf.io/fb38q/files/m8vc4

https://ayumi-495.github.io/eyespot/#meta-regressions-multi-moderator
