---
title: "lnVR"
---

Here we estimate the **log variability ratio** ($ln VR$), which quantifies whether music exposure changes the **dispersion** (standard deviation) of behavioral outcomes relative to controls.


::: callout-note
$$
\ln VR = \ln\left(\frac{SD_T}{SD_C}\right) + \frac{1}{2}\left(\frac{1}{N_T-1}-\frac{1}{N_C-1}\right)
$$

where $SD$ is the standard deviation and $N$ is the sample size for treatment ($T$) and control ($C$) groups.
:::





We exclude proportional outcomes (0–1 or 0–100 measures) from the $ln VR$ analysis because bounded variables impose a mechanical mean–variance relationship, making it difficult to interpret variability changes biologically.

A positive $ln VR$ indicates **higher variability** under music exposure (less consistent responses), whereas a negative $ln VR$ indicates **lower variability** (more consistent responses).

```{r}
#| label: setup
#| include: false

# Load necessary packages for data manipulation, meta-analysis, and table formatting
pacman::p_load(
               DT,
               dtplyr,
               here, 
               knitr,
               tidyverse,
               patchwork,
               metafor,
               orchaRd
               )
```

```{r}
#| label: load_and_clean_data
#| message: false
#| warning: false

db <- readr::read_csv(here("..","data","db251124.csv")) %>%
  
  # Convert all columns required for calculation to numeric.
  mutate(across(c(C_n, Ex_n, C_mean, Ex_mean, C_SE, Ex_SE, C_SD, Ex_SD), as.numeric)) %>%
  
  # Calculate SD where it is missing but SE is present
  # Formula: SD = SE * sqrt(n)
  mutate(
    C_SD = ifelse(
      is.na(C_SD) & !is.na(C_SE),
      C_SE * sqrt(C_n), 
      C_SD
    ),
    Ex_SD = ifelse(
      is.na(Ex_SD) & !is.na(Ex_SE),
      Ex_SE * sqrt(Ex_n), 
      Ex_SD
    )
  ) %>%
  
  # Create Cohort_ID to uniquely identify the source cohort
  mutate(
    Cohort_ID = paste(Study_ID, "Ex-ID", sep = "_")
  ) %>%
  
  # Convert all remaining character columns to factors
  mutate(across(where(is.character), as.factor))
```

```{r}
#| label: calculate_lnVR_final

calculate_lnVR <- function(dt) {

  ## 1. Filter out Proportional Data
  dt <- dt %>%
    mutate(Data_type = tolower(Data_type)) %>% 
    filter(!Data_type %in% c("percentage")) 
  
  if (nrow(dt) == 0) {
    message("No non-percentage data remaining for lnVR calculation.")
    return(dt)
  }

  ## 2. Data Cleaning and Imputation
  dt <- dt %>%
    mutate(

      # Adjust SDs that are 0 (Critical for lnVR)
      Ex_SD = ifelse(Ex_SD == 0, 0.01, Ex_SD),
      C_SD = ifelse(C_SD == 0, 0.05, C_SD)
    )

  ## 3. Setup
  dt$lnVR <- NA_real_
  dt$lnVR_var <- NA_real_

  ## 4. Calculation Loop
  for (i in seq_len(nrow(dt))) {
    
    # Extract variables
    Ex_n <- dt$Ex_n[i]
    C_n <- dt$C_n[i]
    Ex_SD <- dt$Ex_SD[i]
    C_SD <- dt$C_SD[i]
    Data_type <- dt$Data_type[i]
    Comparison_structure <- dt$Comparison_structure[i]
    
    # --- Continuous Data ---
    if (Data_type %in% c("time", "distance", "count", "latency", "index")) {
      
      # A. INDEPENDENT GROUPS
      if (Comparison_structure == "Independent") {
        
        # measure = "VR" (Variability Ratio for independent groups)
        # Requires n1i, n2i, sd1i, sd2i
        effect <- metafor::escalc(
          measure = "VR", 
          n1i = Ex_n, n2i = C_n,
          sd1i = Ex_SD, sd2i = C_SD,
          var.names = c("lnVR", "lnVR_var")
        )
        
      # B. DEPENDENT GROUPS
      } else if (Comparison_structure == "Dependent") {
        
        # measure = "VRC" (Variability Ratio for Correlated/Dependent groups)
        # Requires 'ni' (sample size of pairs) and 'ri' (correlation)
        # We assume ri = 0.5 (consistent with the lnRR approach)
        effect <- metafor::escalc(
          measure = "VRC", 
          ni = (Ex_n + C_n) / 2, # Use average N for the pair
          sd1i = Ex_SD, sd2i = C_SD,
          ri = 0.5, 
          var.names = c("lnVR", "lnVR_var")
        )
      }
      
      # Assign results
      dt$lnVR[i] <- effect$lnVR
      dt$lnVR_var[i] <- effect$lnVR_var
      
 
    }
  }
  
  return(dt)
}
```












::: callout-note
We computed $ln VR$ using `metafor::escalc()` (measures `VR` and `VRC`), which implements the same bias-corrected estimators described in the Methods.
:::

```{r}
#| label: apply_lnVR_calculation
#| eval: false

db_lnVR <- calculate_lnVR(db)

readr::write_csv(
  db_lnVR, 
  file = here("..","data", "db_lnVR.csv"),
  na = "" 
)
```

```{r}
#| label: effect_size_table
#| echo: false
#| message: false

db_lnVR <- readr::read_csv(here("..","data","db_lnVR.csv")) %>%
  mutate(across(c(C_n, Ex_n, C_mean, Ex_mean, C_SE, Ex_SE, C_SD, Ex_SD), as.numeric)) %>%
  mutate(across(where(is.character), as.factor))

display_cols <- c("ES_ID", "Study_ID",  
                  "C_n", "C_mean", "C_SD", 
                  "Ex_n", "Ex_mean", "Ex_SD", 
                  "lnVR", "lnVR_var", "Cohort_ID")

round_cols <- c("C_n", "C_mean", "C_SD", 
                "Ex_n", "Ex_mean", "Ex_SD", 
                "lnVR", "lnVR_var")

DT::datatable(
 db_lnVR %>% dplyr::select(all_of(display_cols)),
 options = list(pageLength = 10, scrollX = TRUE, dom = 'Bfrtip', buttons = c('copy', 'csv')),
 extensions = 'Buttons', rownames = FALSE
) %>%
  formatRound(columns = round_cols, digits = 3) %>%
  formatStyle(columns = display_cols, `text-align` = 'center')
```





```{r}
#| label: lnVR_histogram

hist(db_lnVR$lnVR,
     
    xlim=c(-4,10),
     breaks = seq(-4,10,1),
     main = "Distribution of lnVR",
     xlab = "lnRR")

hist(db_lnVR$lnVR_var,
     xlim=c(.05,.2),
     breaks = seq(0.05,.2,0.05),
     main = "Distribution of lnVR Variance",
     xlab = "Sampling Variance")
```



The full dataset of computed effect sizes is available in the project repository to facilitate independent replication of all meta-analytic results.




:::callout-note
```{r}
sessionInfo()
```


:::




















