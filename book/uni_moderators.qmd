---
title: "Uni-moderators"
---

```{r}
#| label: setup
#| include: false
pacman::p_load(
               DT,
               dtplyr,
               here, 
               knitr,
               tidyverse,
               patchwork,
               metafor,
               orchaRd, multcomp,
               )

#| label: load_and_clean_data
db <- readr::read_csv(here("..","data","db_lnRR.csv")) %>%
mutate(across(c(C_n, Ex_n, C_mean, Ex_mean, C_SE, Ex_SE, C_SD, Ex_SD), as.numeric))%>%
  mutate(across(where(is.character), as.factor)) 



VCV <- metafor::vcalc(
  vi = lnRR_var,
  cluster = Cohort_ID, # The clustering variable (Study_ID + Ex_ID)
  obs = ES_ID,         # The unique observation/effect size ID
  rho = 0.5,           # Assumed correlation between outcomes from the same cohort
  data = db 
)
```

::: callout-note
Variable definitions:

| Variable Name | Definition |
|:-----------------------------------|:-----------------------------------|
| **`ES_ID`** | Unique row identifier for each $\text{lnRR}$ effect size. |
| **`Study_ID`** | Identifier for the primary research paper. |
| **`Cohort_ID`** | Identifier for specific experimental groups within a study. |
| **`Outcome_type`** | The behavioral construct measured. Levels: **Anxiety**, **Depression**, **both**, **unclear**. |
| **`Lifestage_exposure`** | Animal's developmental stage during music exposure. Levels: **Adolescent**, **Juvenile**, **Young adult**, **Adult**, **Mixed**, **Unclear**. |
| **`Sex`** | Sex of the subjects. Levels: **Male**, **Female**. |
| **`Strain`** | Specific animal strain or species used. |
| **`Meta_genre`** | Categorization of the music stimulus. Levels: **Western Art Music / Orchestral**, **Popular Contemporary Music**, **Traditional Music / Folk / World**, **Mixed**, **Unclear**. |
| **`Music_exposure_duration`** | Total time subjects were exposed to music. Levels: **Acute**, **short**, **medium**, **long**. |
| **`Experimental_design`** | Study's methodological setup. Levels: **Posttest-Only Control Group**, **Randomized Block**, **Factorial**, **Repeated Measures**. |
| **`Induced behaviour`** | Whether the tested behavior was innate or experimentally induced. |
| **`Relative_timing`** | When music was administered relative to the behavioral test. Levels: **before**, **concurrent**, **both**, **not specified**. |
| **`Experimental_procedures`** | Identifies non-treatment controls for interventions. Levels: **sham**, **none**. |
| **`Control_condition`** | Description of the control group condition. Levels: **white noise**, **ambient noise** |
| **`Assay_type`** | Type of behavioral test used. |
| **`Overall_rob`** | Overall risk of bias assessment for each study. Levels: **2 (low)**, **1 (moderate)**, **0 (high)**. |
:::



## Meta-regressions

::: {.callout-note icon="true"}
## Data Filtering & Matrix Alignment

This snippet performs quality control before running your meta-analysis. It serves two critical functions:

Ensures Reliability: It removes specific levels of your moderator (groups) that have too little data to be trusted (in this case, fewer than 5 effect sizes).

Prevents Errors: Crucially, it subsets the Variance-Covariance (VCV) matrix to match your filtered data. Since the VCV matrix is a square grid where every row/column corresponds to a row in your data, filtering the data without "cropping" the matrix correspondingly will cause your model to crash due to a dimension mismatch.

```{r}
#| label: filter_low_k
#| eval: FALSE

# 1. Identify and Filter Low-K Levels
# (Replace 'Outcome_type' with the specific moderator column name)

# Calculate the count of ES_ID (k) for each level of the moderator
k_counts <- db %>%
  group_by(Outcome_type) %>%
  summarise(k_es = n())

# Identify the levels to keep (where k_es >= 5)
levels_to_keep <- k_counts %>%
  filter(k_es >= 5) %>%
  pull(Outcome_type)

# 2. Create the Filtered Data Frame
db_filtered <- db %>%
  filter(Outcome_type %in% levels_to_keep)

# 3. Subset the VCV Matrix (CRITICAL STEP)
# Assumes VCV matrix rows/columns match the original 'db' data frame indices.
indices_to_keep <- which(db$Outcome_type %in% levels_to_keep)
VCV_filtered <- VCV[indices_to_keep, indices_to_keep]
```
:::



::: panel-tabset
## 1. Outcome type: Anxiety and Depression

```{r}
#| label: filter_outcome_type
#| fold: TRUE

k_counts <- db %>%
  group_by(Outcome_type) %>%
  summarise(k_es = n())


levels_to_keep <- k_counts %>%
  filter(k_es >= 5) %>%
  pull(Outcome_type)


db_filtered <- db %>%
  filter(Outcome_type %in% levels_to_keep)

indices_to_keep <- which(db$Outcome_type %in% levels_to_keep)
VCV_filtered <- VCV[indices_to_keep, indices_to_keep]
```

```{r}
#| label: model_outcome_type

mOT <- rma.mv(yi = lnRR,
                  V = VCV_filtered, 
              mods = ~ Outcome_type,
                  random = list(~1 | Study_ID,
                                ~1 | ES_ID,
                                ~1 | Strain),
                  test = "t",
                  method = "REML", 
                  sparse = TRUE,
                  data = db_filtered)

summary(mOT)

```

```{r}
r2OT <- round(r2_ml(mOT), 4)
r2OT
```

```{r}
#| label: orchard_outcome_type
#| fig-width: 6
#| fig-height: 4
#| warning: false
orchard_outcome<-orchard_plot(mOT,legend.pos = "top.left",
             mod = "Outcome_type",
              group = "Study_ID",
              xlab = "lnRR", 
             flip = T,trunk.size = 0.3,     
              branch.size = 2,alpha=0.3) +
            scale_colour_brewer(palette = "Set1") +
            scale_fill_brewer(palette = "Dark2")+scale_y_continuous(limits = c(-8,10.5),breaks = seq(-8, 10, by = 2),
                                                                    minor_breaks = seq(-8, 10, by = 1 ))+  theme(legend.direction = "vertical")
orchard_outcome
```

```{r}
#| label: save-figure
#| eval: false

ggsave(filename = here("..","Plots", "orchard_outcome_lnRR.pdf"),
       plot = orchard_outcome,
       dpi = 300, device = cairo_pdf)

ggsave(filename = here("..","Plots", "orchard_outcome_lnRR.jpg"),
       plot = orchard_outcome,
       width = 7,  
       height = 9,  
       dpi = 300)

```



## 2. Lifestage of exposure

```{r}
#| label: model_lifestage_exp

mLE <- rma.mv(yi = lnRR,
                  V = VCV, 
              mods = ~ Lifestage_exposure-1,
                  random = list(~1 | Study_ID,
                                ~1 | ES_ID,
                                ~1 | Strain),
                  test = "t",
                  method = "REML", 
                  sparse = TRUE,
                  data = db)

summary(mLE)

```

```{r}
r2LE <- round(r2_ml(mLE), 4)
r2LE
```


```{r}
summary(glht(mLE, linfct=cbind(contrMat(rep(1,6), type="Tukey"))), test=adjusted("none"))
```



```{r}
#| label: orchard_lifestage_exp
#| fig-width: 6
#| fig-height: 4
#| warning: false
lifestage_labels <- c(
  "Adolescent"  = "Adol.",
  "Adult"       = "Adult",
  "Juvenile"    = "Juv.",
  "Young adult" = "Y. adult",
  "Mixed"       = "Mixed",
  "Unclear"     = "Unclear"
)


orchard_lifestage<-orchard_plot(mLE,legend.pos = "top.left",
             mod = "Lifestage_exposure",
              group = "Study_ID",
               xlab = expression(lnRR),trunk.size = 0.3,     
              branch.size = 2,alpha=0.3 ,
             flip = T) +
  scale_x_discrete(labels = lifestage_labels)+
            scale_colour_brewer(palette = "Set1") +
            scale_fill_brewer(palette = "Dark2")+scale_y_continuous(limits = c(-8,10.5),breaks = seq(-8, 10, by = 2),
                                                                    minor_breaks = seq(-8, 10, by = 1 ))+  theme(legend.direction = "vertical")
orchard_lifestage
```

```{r}
#| label: save-figure_lifestage
#| eval: false

ggsave(filename = here("..","Plots", "orchard_lifestage_lnRR.pdf"),
       plot = orchard_lifestage,
       dpi = 300, device = cairo_pdf)

ggsave(filename = here("..","Plots", "orchard_lifestage_lnRR.jpg"),
       plot = orchard_lifestage,
       width = 9,  
       height = 7,  
       dpi = 300)

```



## 3. Sex

```{r}
#| label: filter_sex
#| fold: TRUE
k_counts <- db %>%
  group_by(Sex) %>%
  summarise(k_es = n())

levels_to_keep <- k_counts %>%
  filter(k_es >= 5) %>%
  pull(Sex)

db_filtered <- db %>%
  filter(Sex %in% levels_to_keep)


indices_to_keep <- which(db$Sex %in% levels_to_keep)
VCV_filtered <- VCV[indices_to_keep, indices_to_keep]
```

```{r}
#| label: model_sex

mSX <- rma.mv(yi = lnRR,
                  V = VCV_filtered, 
              mods = ~ Sex,
                  random = list(~1 | Study_ID,
                                ~1 | ES_ID,
                                ~1 | Strain),
                  test = "t",
                  method = "REML", 
                  sparse = TRUE,
                  data = db_filtered)

summary(mSX)

```

```{r}
r2SX <- round(r2_ml(mSX), 4)
r2SX
```

```{r}
#| label: orchard_sex
#| fig-width: 6
#| fig-height: 4
#| warning: false
orchard_sex<-orchard_plot(mSX,
             mod = "Sex",legend.pos = "top.left",
              group = "Study_ID",
             xlab = "lnRR", 
             flip = T,trunk.size = 0.3,     
              branch.size = 2,alpha=0.3) +
            scale_colour_brewer(palette = "Set1") +
            scale_fill_brewer(palette = "Dark2")+scale_y_continuous(limits = c(-8,10.5),breaks = seq(-8, 10, by = 2),
                                                                    minor_breaks = seq(-8, 10, by = 1 ))+  theme(legend.direction = "vertical")
orchard_sex
```

```{r}
#| label: save-figure_sex
#| eval: false

ggsave(filename = here("..","Plots", "orchard_sex_lnRR.pdf"),
       plot = orchard_sex,
       dpi = 300, device = cairo_pdf)

ggsave(filename = here("..","Plots", "orchard_sex_lnRR.jpg"),
       plot = orchard_sex,
       width = 7,  
       height = 9,  
       dpi = 300)

```



## 4. Music genre

Meta_genre

```{r}
#| label: model_music_genre

mMG <- rma.mv(yi = lnRR,
                  V = VCV, 
              mods = ~ Meta_genre-1,
                  random = list(~1 | Study_ID,
                                ~1 | ES_ID,
                                ~1 | Strain),
                  test = "t",
                  method = "REML", 
                  sparse = TRUE,
                  data = db)

summary(mMG)

```

```{r}
r2MG <- round(r2_ml(mMG), 4)
r2MG
```

```{r}
#| label: orchard_music_genre
#| fig-width: 6
#| fig-height: 4
#| warning: false




genre_labels <- c(
  "Mixed"  = "Mixed",
  "Popular Contemporary Music"       = "Contemporary",
  "Traditional Music / Folk / World"    = "World",
  "Western Art Music / Orchestral" = "Orchestral"
)


orchard_genre<-orchard_plot(mMG,
             mod = "Meta_genre",legend.pos = "top.left",
              group = "Study_ID",
             xlab = expression(lnRR),trunk.size = 0.3,     
              branch.size = 2,alpha=0.3, 
             flip = T) +scale_x_discrete(labels = genre_labels)+
            scale_colour_brewer(palette = "Set1") +
            scale_fill_brewer(palette = "Dark2")+scale_y_continuous(limits = c(-8,10.5),breaks = seq(-8, 10, by = 2),
                                                                    minor_breaks = seq(-8, 10, by = 1 ))+  theme(legend.direction = "vertical")
orchard_genre
```

```{r}
#| label: save-figure_genre
#| eval: false

ggsave(filename = here("..","Plots", "orchard_genre_lnRR.pdf"),
       plot = orchard_genre,
       dpi = 300, device = cairo_pdf)

ggsave(filename = here("..","Plots", "orchard_genre_lnRR.jpg"),
       plot = orchard_genre,
       width = 9,  
       height = 7,  
       dpi = 300)

```

Contrasts between levels

```{r}
#| label: music_genre_contrasts1

summary(glht(mMG, linfct=cbind(contrMat(rep(1,4), type="Tukey"))), test=adjusted("none"))
```

## 5. Music exposure duration

Music_exposure_duration

```{r}
#| label: filter_music_exposure
#| fold: TRUE

k_counts <- db %>%
  group_by(Music_exposure_duration) %>%
  summarise(k_es = n())

levels_to_keep <- k_counts %>%
  filter(k_es >= 5) %>%
  pull(Music_exposure_duration)

db_filtered <- db %>%
  filter(Music_exposure_duration %in% levels_to_keep)

indices_to_keep <- which(db$Music_exposure_duration %in% levels_to_keep)
VCV_filtered <- VCV[indices_to_keep, indices_to_keep]
```

```{r}
#| label: model_music_exposure

mMED <- rma.mv(yi = lnRR,
                  V = VCV_filtered, 
              mods = ~ Music_exposure_duration-1,
                  random = list(~1 | Study_ID,
                                ~1 | ES_ID, 
                                ~1 | Strain),
                  test = "t",
                  method = "REML", 
                  sparse = TRUE,
                  data = db_filtered)

summary(mMED)

```

```{r}
r2MED <- round(r2_ml(mMED), 4)
r2MED
```

```{r}
#| label: orchard_music_exposure
#| fig-width: 6
#| fig-height: 4
#| warning: false
orchard_exposure<-orchard_plot(mMED,
             mod = "Music_exposure_duration",legend.pos = "top.left",
              group = "Study_ID",
              xlab = expression(lnRR), trunk.size = 0.3,     
              branch.size = 2,alpha=0.3,
              flip = T)  +
            scale_colour_brewer(palette = "Set1") +
            scale_fill_brewer(palette = "Dark2")+scale_y_continuous(limits = c(-8,10.5),breaks = seq(-8, 10, by = 2),
                                                                    minor_breaks = seq(-8, 10, by = 1 ))+  theme(legend.direction = "vertical")
orchard_exposure
```

```{r}
#| label: save-figure_exposure
#| eval: false

ggsave(filename = here("..","Plots", "orchard_exposure_lnRR.pdf"),
       plot = orchard_exposure,
       dpi = 300, device = cairo_pdf)

ggsave(filename = here("..","Plots", "orchard_exposure_lnRR.jpg"),
       plot = orchard_exposure,
       width = 9,  
       height = 7,  
       dpi = 300)

```

Contrasts between levels

```{r}
summary(glht(mMED, linfct=cbind(contrMat(rep(1,3), type="Tukey"))), test=adjusted("none"))
```


## 6. Experimental design

```{r}
#| label: model_experimental_design

mEXD <- rma.mv(yi = lnRR,
                  V = VCV, 
              mods = ~ Experimental_design-1,
                  random = list(~1 | Study_ID,
                                ~1 | ES_ID, 
                                ~1 | Strain),
                  test = "t",
                  method = "REML", 
                  sparse = TRUE,
                  data = db)

summary(mEXD)

```

```{r}
r2EXD <- round(r2_ml(mEXD), 4)
r2EXD
```

```{r}
#| label: orchard_experimental_design
#| fig-width: 6
#| fig-height: 4
#| warning: false
orchard_design<-orchard_plot(mEXD,
             mod = "Experimental_design",legend.pos = "top.left",
              group = "Study_ID",
              xlab = expression(lnRR), trunk.size = 0.3,     
              branch.size = 2,alpha=0.3,
              flip=T) +
            scale_colour_brewer(palette = "Set1") +
            scale_fill_brewer(palette = "Dark2")+scale_y_continuous(limits = c(-8,10.5),breaks = seq(-8, 10, by = 2),
                                                                    minor_breaks = seq(-8, 10, by = 1 ))+  theme(legend.direction = "vertical")
orchard_design
```

```{r}
#| label: save-figure_design
#| eval: false

ggsave(filename = here("..","Plots", "orchard_design_lnRR.pdf"),
       plot = orchard_design,
       dpi = 300, device = cairo_pdf)

ggsave(filename = here("..","Plots", "orchard_design_lnRR.jpg"),
       plot = orchard_design,
       width = 9,  
       height = 7,  
       dpi = 300)

```

Contrasts between levels

```{r}
#| label: music_genre_contrasts


summary(glht(mEXD, linfct=cbind(contrMat(rep(1,3), type="Tukey"))), test=adjusted("none"))
```

## 7. Induced behaviour

```{r}
#| label: model_induced_behaviour

mIB <- rma.mv(yi = lnRR,
                  V = VCV, 
              mods = ~ `Induced behaviour`,
                  random = list(~1 | Study_ID,
                                ~1 | ES_ID, 
                                ~1 | Strain),
                  test = "t",
                  method = "REML", 
                  sparse = TRUE,
                  data = db)

summary(mIB)

```

```{r}
r2IB <- round(r2_ml(mIB), 4)
r2IB
```

```{r}
#| label: orchard_INDUCED_BEHAVIOUR
#| fig-width: 6
#| fig-height: 4
#| warning: false
orchard_behaviour<-orchard_plot(mIB,
             mod = "Induced behaviour",legend.pos = "top.left",
              group = "Study_ID",
              xlab = expression(lnRR), trunk.size = 0.3,     
              branch.size = 2,alpha=0.3,
              flip = T)+
            scale_colour_brewer(palette = "Set1") +
            scale_fill_brewer(palette = "Dark2")+scale_y_continuous(limits = c(-8,10.5),breaks = seq(-8, 10, by = 2),
                                                                    minor_breaks = seq(-8, 10, by = 1 ))+  theme(legend.direction = "vertical")
orchard_behaviour
```

```{r}
#| label: save-figure_behaviour
#| eval: false

ggsave(filename = here("..","Plots", "orchard_behaviour_lnRR.pdf"),
       plot = orchard_behaviour,
       dpi = 300, device = cairo_pdf)

ggsave(filename = here("..","Plots", "orchard_behaviour_lnRR.jpg"),
       plot = orchard_behaviour,
       width = 9,  
       height = 7,  
       dpi = 300)

```



## 8. Relative timing

```{r}
#| label: model+_relative_timing

mRT <- rma.mv(yi = lnRR,
                  V = VCV, 
              mods = ~ Relative_timing-1,
                  random = list(~1 | Study_ID,
                                ~1 | ES_ID, 
                                ~1 | Strain),
                  test = "t",
                  method = "REML", 
                  sparse = TRUE,
                  data = db)

summary(mRT)

```

```{r}
r2RT <- round(r2_ml(mRT), 4)
r2RT
```

```{r}
#| label: orchard_relative_timing
#| fig-width: 6
#| fig-height: 4
#| warning: false
orchard_timing<-orchard_plot(mRT,
             mod = "Relative_timing",legend.pos = "top.left",
              group = "Study_ID",
              xlab = expression(lnRR),trunk.size = 0.3,     
              branch.size = 2,alpha=0.3) +
            scale_colour_brewer(palette = "Set1") +
            scale_fill_brewer(palette = "Dark2")+scale_y_continuous(limits = c(-8,10.5),breaks = seq(-8, 10, by = 2),
                                                                    minor_breaks = seq(-8, 10, by = 1 ))+  theme(legend.direction = "vertical")
orchard_timing

```

```{r}
summary(glht(mRT, linfct=cbind(contrMat(rep(1,3), type="Tukey"))), test=adjusted("none"))
```

## 9. Experimental procedures

```{r}
#| label: model_Experimental_procedures

mEXP <- rma.mv(yi = lnRR,
                  V = VCV, 
              mods = ~ Experimental_procedures,
                  random = list(~1 | Study_ID,
                                ~1 | ES_ID, 
                                ~1 | Strain),
                  test = "t",
                  method = "REML", 
                  sparse = TRUE,
                  data = db)

summary(mEXP)

```

```{r}
r2EXP <- round(r2_ml(mEXP), 4)
r2EXP
```

```{r}
#| label: orchard_experimental_procedures
#| fig-width: 6
#| fig-height: 4
#| warning: false
orchard_exp<-orchard_plot(mEXP,
             mod = "Experimental_procedures",legend.pos = "top.left",
              group = "Study_ID",
              xlab = expression(lnRR),trunk.size = 0.3,     
              branch.size = 2,alpha=0.3) +
            scale_colour_brewer(palette = "Set1") +
            scale_fill_brewer(palette = "Dark2")+scale_y_continuous(limits = c(-8,10.5),breaks = seq(-8, 10, by = 2),
                                                                    minor_breaks = seq(-8, 10, by = 1 ))+  theme(legend.direction = "vertical")
orchard_exp
```



## 10. Control condition

```{r}
#| label: model_control_condition

mCC <- rma.mv(yi = lnRR,
                  V = VCV, 
              mods = ~ Control_conditions,
                  random = list(~1 | Study_ID,
                                ~1 | ES_ID, 
                                ~1 | Strain),
                  test = "t",
                  method = "REML", 
                  sparse = TRUE,
                  data = db)

summary(mCC)

```

```{r}
r2CC <- round(r2_ml(mCC), 4)
r2CC
```

```{r}
#| label: orchard_control_condition
#| fig-width: 6
#| fig-height: 4
#| warning: false

control_labels <- c(
  "ambiet sound" = "Ambient sound",
  "Ambiet sound" = "Ambient sound",  # optional safeguard if both exist
  "White noise"   = "White noise"
)
orchard_control<-orchard_plot(mCC,
             mod = "Control_conditions",legend.pos = "top.left",
              group = "Study_ID",
              xlab = expression(lnRR),trunk.size = 0.3,     
              branch.size = 2,alpha=0.3) +
  scale_x_discrete(labels = control_labels) +
            scale_colour_brewer(palette = "Set1") +
            scale_fill_brewer(palette = "Dark2")+scale_y_continuous(limits = c(-8,10.5),breaks = seq(-8, 10, by = 2),
                                                                    minor_breaks = seq(-8, 10, by = 1 ))+  theme(legend.direction = "vertical")
orchard_control
```

```{r}
mCC <- rma.mv(yi = lnRR,
                  V = VCV, 
              mods = ~ Control_conditions,
                  random = list(~1 | Study_ID,
                                ~1 | ES_ID, 
                                ~1 | Strain),
                  test = "t",
                  method = "REML", 
                  sparse = TRUE,
                  data = db)

summary(mCC)
```

## 11. Assay type

```{r}
# 1. Identify and Filter Low-K Levels


k_counts <- db %>%
  group_by(Assay_type) %>%
  summarise(k_es = n())

# Identify the levels to keep (where k_es >= 5)
levels_to_keep <- k_counts %>%
  filter(k_es >= 5) %>%
  pull(Assay_type)

# 2. Create the Filtered Data Frame
db_filtered <- db %>%
  filter(Assay_type %in% levels_to_keep)

# 3. Subset the VCV Matrix (CRITICAL STEP)
# Assumes VCV matrix rows/columns match the original 'db' data frame indices.
indices_to_keep <- which(db$Assay_type %in% levels_to_keep)
VCV_filtered <- VCV[indices_to_keep, indices_to_keep]
```

```{r}
#| label: model_assay_type

mAT <- rma.mv(yi = lnRR,
                  V = VCV_filtered, 
              mods = ~ Assay_type-1,
                  random = list(~1 | Study_ID,
                                ~1 | ES_ID, 
                                ~1 | Strain),
                  test = "t",
                  method = "REML", 
                  sparse = TRUE,
                  data = db_filtered)

summary(mAT)

```

```{r}
r2AT <- round(r2_ml(mAT), 4)
r2AT
```

```{r}
#| label: orchard_assay_type
#| fig-width: 6
#| fig-height: 4
#| warning: false
assay_labels <- c(
  "Elevated Plus Maze" = "EPM",
  "Open Field Test" = "OFT",
  "Light-Dark Box" = "LDB",
  "Forced Swim Test (FST)" = "FST",
  "Tail Suspension Test (TST)" = "TST",
  "Sucrose Preference Test (SPT)" = "SPT"
)

orchard_assay <- orchard_plot(
  mAT,legend.pos = "top.left",
  mod   = "Assay_type",
  group = "Study_ID",
  xlab  = expression(lnRR),trunk.size = 0.3,     
              branch.size = 2, alpha = 0.3
) +
  scale_colour_brewer(palette = "Set1") +
  scale_fill_brewer(palette = "Dark2") +
  scale_x_discrete(labels = assay_labels) +scale_y_continuous(limits = c(-8,10.5),breaks = seq(-8, 10, by = 2),
                                                                    minor_breaks = seq(-8, 10, by = 1 ))+
  labs(
    x = NULL,
    y = expression(lnRR),
    subtitle = "Behavioural assay"
  ) +
  theme(
    plot.subtitle = element_text(size = 10, face = "bold"),
    axis.title.y = element_text(face = "bold"),legend.direction = "vertical"
  )

orchard_assay


```

```{r}
summary(glht(mAT, linfct=cbind(contrMat(rep(1,6), type="Tukey"))), test=adjusted("none"))
```
:::


# Patched figure


```{r}
#| label: patched_figure

orchard_lifestage <- orchard_lifestage + labs(subtitle = "Age at exposure")
orchard_assay     <- orchard_assay     + labs(subtitle = "Behavioral assay")
orchard_control   <- orchard_control   + labs(subtitle = "Control condition")
orchard_behaviour <- orchard_behaviour + labs(subtitle = "Behavioral mechanism")

# 2) Hide legends on all but ONE panel (choose bottom-right here)
orchard_lifestage <- orchard_lifestage + theme(legend.position = "none")
orchard_assay     <- orchard_assay     + theme(legend.position = "none")
orchard_control   <- orchard_control   + theme(legend.position = "none")
# orchard_behaviour keeps the legend

# 3) Patch with your layout
patched_figure <- (orchard_lifestage + orchard_assay) /
                 (orchard_control   + orchard_behaviour) +
  plot_annotation(tag_levels = "A") &
  theme(
    plot.tag = element_text(size = 12, face = "bold"),
    plot.subtitle = element_text(size = 10, face = "bold")
  )

# 4) Enforce identical lnRR scale and a single y-axis label across ALL panels
patched_figure <- patched_figure &
  scale_y_continuous(
    limits = c(-8, 10),                       
    breaks = seq(-8, 10, by = 2),
    minor_breaks = seq(-8, 10, by = 1)
  ) &
  labs(y = expression(lnRR), x = NULL)

patched_figure

```

```{r}
#| label: save-figure_behaviour
#| eval: false

ggsave(filename = here("..","Plots", "patched_lnRR.pdf"),
       plot = patched_figure,
       dpi = 300, device = cairo_pdf,width = 10,  
       height = 10)

ggsave(filename = here("..","Plots", "patched_lnRR.jpg"),
       plot = patched_figure,
       width = 10,  
       height = 10,  
       dpi = 300)

```

```{r}
sessionInfo()
```













