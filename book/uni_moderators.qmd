---
title: "Uni-moderators"
---


We fit uni-moderator multilevel meta-regressions to test whether study characteristics predict differences in:

- the mean response (lnRR),

- absolute variability (lnVR),

- relative variability (lnCVR).

Each moderator is analysed separately (uni-moderator), using the same random-effects structure (`Study_ID`, `ES_ID`, Strain`) and a cohort-level VCV matrix (rho = 0.5). For categorical moderators, we drop levels with fewer than five effect sizes (k < 5) within each effect size metric, and subset the corresponding VCV matrix accordingly.





```{r}
#| label: setup_unimoderators

pacman::p_load(
  DT, dtplyr, here, knitr, tidyverse, patchwork, metafor, orchaRd, multcomp
)

db_all <- readr::read_csv(here("..","data","db_effect_sizes.csv")) %>%
  mutate(across(where(is.character), as.factor)) %>%
  mutate(across(c(lnRR, lnRR_var, lnVR, lnVR_var, lnCVR, lnCVR_var), as.numeric))%>%
  mutate(
    Control_conditions = as.character(Control_conditions),
    Control_conditions = dplyr::recode(
      Control_conditions,
      "ambiet sound" = "Ambient sound",
      "white noise"  = "White noise"
    ),
    Control_conditions = factor(Control_conditions)
  )

# Per-metric datasets
db_rr  <- db_all %>% filter(!is.na(lnRR),  !is.na(lnRR_var))
db_vr  <- db_all %>% filter(!is.na(lnVR),  !is.na(lnVR_var))
db_cvr <- db_all %>% filter(!is.na(lnCVR), !is.na(lnCVR_var))

# Per-metric VCV matrices (rho = 0.5)
VCV_rr <- metafor::vcalc(vi = lnRR_var,  cluster = Cohort_ID, obs = ES_ID, rho = 0.5, data = db_rr)
VCV_vr <- metafor::vcalc(vi = lnVR_var,  cluster = Cohort_ID, obs = ES_ID, rho = 0.5, data = db_vr)
VCV_cvr<- metafor::vcalc(vi = lnCVR_var, cluster = Cohort_ID, obs = ES_ID, rho = 0.5, data = db_cvr)


```




::: callout-note
## Helper functions
Filter to common moderator levels (k â‰¥ 5 in each metric)
```{r}
#| label: filter_common_levels
#| code-fold: true

filter_low_k_single <- function(dat, V, moderator, min_k = 5) {
  mod_chr <- moderator
  # If moderator is not a factor, just return as-is
  if (!is.factor(dat[[mod_chr]])) {
    return(list(data = dat, V = V, keep_levels = NULL, k = NULL))
  }

  k_counts <- dat %>%
    count(.data[[mod_chr]], name = "k_es")

  keep_levels <- k_counts %>%
    filter(k_es >= min_k) %>%
    pull(.data[[mod_chr]])

  dat_f <- dat %>% filter(.data[[mod_chr]] %in% keep_levels)
  idx   <- which(dat[[mod_chr]] %in% keep_levels)
  V_f   <- V[idx, idx, drop = FALSE]

  list(data = dat_f, V = V_f, keep_levels = keep_levels, k = k_counts)
}


```


Fit one uni-moderator model + plot 

```{r}
#| label: fit_one_unimod
#| code-fold: true

fit_unimod <- function(dat, V, yi, mods_formula, mod_name, xlab_expr) {

  # Guard: if nothing left after filtering
  if (nrow(dat) < 2) return(NULL)

  mod <- metafor::rma.mv(
    yi = dat[[yi]],
    V  = V,
    mods = as.formula(mods_formula),
    random = list(~1 | Study_ID, ~1 | ES_ID, ~1 | Strain),
    test = "t",
    method = "REML",
    sparse = TRUE,
    data = dat
  )

  list(
    data  = dat,
    model = mod,
    r2    = round(orchaRd::r2_ml(mod), 4),
    i2    = orchaRd::i2_ml(mod),
    plot  = orchard_plot(
      mod,
      mod   = mod_name,       
      group = "Study_ID",
      xlab  = xlab_expr,
      flip  = TRUE,
      legend.pos  = "top.left",
      trunk.size  = 0.3,
      branch.size = 2,
      alpha       = 0.3
    ) +
      scale_colour_brewer(palette = "Set1") +
      scale_fill_brewer(palette = "Dark2") +
      theme(legend.direction = "vertical")
  )
}


```

Optional Tukey contrasts 

```{r}
#| label: tukey_if_no_intercept
#| code-fold: true

maybe_tukey <- function(dat, V, yi, moderator, min_k = 3) {

  dat <- dat %>%
    mutate("{moderator}" := droplevels(as.factor(.data[[moderator]])))

  k <- nlevels(dat[[moderator]])
  if (is.na(k) || k < min_k) return(NULL)

  # Fit without intercept so coef = one per level
  mods_formula <- as.formula(paste0("~ ", moderator, " - 1"))

  m <- metafor::rma.mv(
    yi = dat[[yi]],
    V  = V,
    mods = mods_formula,
    random = list(~1 | Study_ID,
                  ~1 | ES_ID,
                  ~1 | Strain),
    test = "t",
    method = "REML",
    sparse = TRUE,
    data = dat
  )

  cn <- names(coef(m))
  K <- multcomp::contrMat(rep(1, k), type = "Tukey")
  colnames(K) <- cn

  g <- multcomp::glht(m, linfct = K)

 
  base::summary(g, test = multcomp::adjusted("none"))
}
```


:::


## Outcome type

```{r}
#| label: run_outcome_type
MOD  <- "Outcome_type"
MODS <- "~ Outcome_type"

f_rr  <- filter_low_k_single(db_rr,  VCV_rr,  MOD, min_k = 5)
f_vr  <- filter_low_k_single(db_vr,  VCV_vr,  MOD, min_k = 5)
f_cvr <- filter_low_k_single(db_cvr, VCV_cvr, MOD, min_k = 5)

res_rr  <- fit_unimod(f_rr$data,  f_rr$V,  "lnRR",  MODS, MOD, expression(lnRR))
res_vr  <- fit_unimod(f_vr$data,  f_vr$V,  "lnVR",  MODS, MOD, expression(lnVR))
res_cvr <- fit_unimod(f_cvr$data, f_cvr$V, "lnCVR", MODS, MOD, expression(lnCVR))


```




:::: columns

:::: {.column width="49%"}
### lnRR
```{r}
summary(res_rr$model)
```
```{r}
#| label: outcome_type_lnRR_r2
res_rr$r2
```

::: card
```{r}
#| label: outcome_type_lnRR_plot
res_rr$plot
```
:::

:::

:::: {.column width="2%"} ::::
:::


:::: {.column width="49%"}

### lnVR

```{r}
#| label: outcome_type_lnVR_summary
summary(res_vr$model)
```


```{r}
#| label: outcome_type_lnVR_r2
res_vr$r2
```

::: card
```{r}
#| label: outcome_type_lnVR_plot
res_vr$plot
```
:::

:::

:::


:::: {.column width="25%"} 
::::
:::: {.column width="50%"}
### lnCVR
```{r}
#| label: outcome_type_lnCVR_summary
summary(res_cvr$model)
```

```{r}
#| label: outcome_type_lnCVR_r2
res_cvr$r2
```

::: card
```{r}
#| label: outcome_type_lnCVR_plot
res_cvr$plot
```
:::
:::
:::: {.column width="25%"}
:::







## Behavioral assay

```{r}
#| label: run_Assay_type
MOD  <- "Assay_type"
MODS <- "~ Assay_type - 1"


assay_labels <- c(
  "Elevated Plus Maze" = "EPM",
  "Open Field Test" = "OFT",
  "Light-Dark Box" = "LDB",
  "Forced Swim Test (FST)" = "FST",
  "Tail Suspension Test (TST)" = "TST",
  "Sucrose Preference Test (SPT)" = "SPT"
)


# 1) Filter each effect-size dataset (and subset the VCV accordingly)
f_rr  <- filter_low_k_single(db_rr,  VCV_rr,  MOD, min_k = 5)
f_vr  <- filter_low_k_single(db_vr,  VCV_vr,  MOD, min_k = 5)
f_cvr <- filter_low_k_single(db_cvr, VCV_cvr, MOD, min_k = 5)
# 2) Fit the three unimoderator models (same moderator, different yi/vi)
res_rr  <- fit_unimod(f_rr$data,  f_rr$V,  "lnRR",  MODS, MOD, expression(lnRR))
res_vr  <- fit_unimod(f_vr$data,  f_vr$V,  "lnVR",  MODS, MOD, expression(lnVR))
res_cvr <- fit_unimod(f_cvr$data, f_cvr$V, "lnCVR", MODS, MOD, expression(lnCVR))

# 2b) Relabel x-axis in the orchard plots (so EPM/OFT/etc. show)
res_rr$plot  <- res_rr$plot  + scale_x_discrete(labels = assay_labels)
res_vr$plot  <- res_vr$plot  + scale_x_discrete(labels = assay_labels)
res_cvr$plot <- res_cvr$plot + scale_x_discrete(labels = assay_labels)

# 3) Tukey contrasts (use the filtered data + matched VCV for each dataset)

tuk_rr  <- maybe_tukey(dat = f_rr$data,  V = f_rr$V,  yi = "lnRR",  moderator = MOD)
tuk_vr  <- maybe_tukey(dat = f_vr$data,  V = f_vr$V,  yi = "lnVR",  moderator = MOD)
tuk_cvr <- maybe_tukey(dat = f_cvr$data, V = f_cvr$V, yi = "lnCVR", moderator = MOD)

```






:::: columns

:::: {.column width="49%"}
### lnRR
```{r}
summary(res_rr$model)
```
```{r}
#| label: Assay_type_lnRR_r2
res_rr$r2
```

::: card
```{r}
#| label: Assay_type_lnRR_plot
res_rr$plot
```
:::
```{r}
#| label: assay_lnRR_tukey
tuk_rr
```

:::

:::: {.column width="2%"} ::::
:::


:::: {.column width="49%"}

### lnVR

```{r}
#| label: assay_lnVR_summary
summary(res_vr$model)
```


```{r}
#| label: assay_lnVR_r2
res_vr$r2
```

::: card
```{r}
#| label: assay_lnVR_plot
res_vr$plot
```
:::
```{r}
#| label: assay_lnVR_tukey
tuk_vr
```
:::

:::


:::: {.column width="25%"} 
::::
:::: {.column width="50%"}
### lnCVR
```{r}
#| label: assay_lnCVR_summary
summary(res_cvr$model)
```

```{r}
#| label: assay_lnCVR_r2
res_cvr$r2
```

::: card
```{r}
#| label: assay_lnCVR_plot
res_cvr$plot
```
:::

```{r}
#| label: assay_lnCVR_tukey
tuk_cvr

```

:::
:::: {.column width="25%"}
:::




## Behavioral mechanism

```{r}
#| label: run_mechanism
MOD  <- "Induced behaviour"
MODS <- "~ `Induced behaviour`"

f_rr  <- filter_low_k_single(db_rr,  VCV_rr,  MOD, min_k = 5)
f_vr  <- filter_low_k_single(db_vr,  VCV_vr,  MOD, min_k = 5)
f_cvr <- filter_low_k_single(db_cvr, VCV_cvr, MOD, min_k = 5)

res_rr  <- fit_unimod(f_rr$data,  f_rr$V,  "lnRR",  MODS, MOD, expression(lnRR))
res_vr  <- fit_unimod(f_vr$data,  f_vr$V,  "lnVR",  MODS, MOD, expression(lnVR))
res_cvr <- fit_unimod(f_cvr$data, f_cvr$V, "lnCVR", MODS, MOD, expression(lnCVR))


```




:::: columns

:::: {.column width="49%"}
### lnRR
```{r}
summary(res_rr$model)
```
```{r}
#| label: mechanism_lnRR_r2
res_rr$r2
```

::: card
```{r}
#| label: mechanism_lnRR_plot
res_rr$plot
```
:::

:::

:::: {.column width="2%"} ::::
:::


:::: {.column width="49%"}

### lnVR

```{r}
#| label: mechanism_lnVR_summary
summary(res_vr$model)
```


```{r}
#| label: mechanism_lnVR_r2
res_vr$r2
```

::: card
```{r}
#| label: mechanism_lnVR_plot
res_vr$plot
```
:::

:::

:::


:::: {.column width="25%"} 
::::
:::: {.column width="50%"}
### lnCVR
```{r}
#| label: mechanism_lnCVR_summary
summary(res_cvr$model)
```

```{r}
#| label: mechanism_lnCVR_r2
res_cvr$r2
```

::: card
```{r}
#| label: mechanism_lnCVR_plot
res_cvr$plot
```
:::
:::
:::: {.column width="25%"}
:::





## Lifestage of exposure


```{r}
#| label: run_Lifestage
MOD  <- "Lifestage_exposure"
MODS <- "~ Lifestage_exposure -1"


lifestage_labels <- c(
  "Adolescent"  = "Adol.",
  "Adult"       = "Adult",
  "Juvenile"    = "Juv.",
  "Young adult" = "Y. adult",
  "Mixed"       = "Mixed",
  "Unclear"     = "Unclear"
)



# 1) Filter each effect-size dataset (and subset the VCV accordingly)
f_rr  <- filter_low_k_single(db_rr,  VCV_rr,  MOD, min_k = 5)
f_vr  <- filter_low_k_single(db_vr,  VCV_vr,  MOD, min_k = 5)
f_cvr <- filter_low_k_single(db_cvr, VCV_cvr, MOD, min_k = 5)



# 2) Fit the three unimoderator models (same moderator, different yi/vi)
res_rr  <- fit_unimod(f_rr$data,  f_rr$V,  "lnRR",  MODS, MOD, expression(lnRR))
res_vr  <- fit_unimod(f_vr$data,  f_vr$V,  "lnVR",  MODS, MOD, expression(lnVR))
res_cvr <- fit_unimod(f_cvr$data, f_cvr$V, "lnCVR", MODS, MOD, expression(lnCVR))

# 2b) Relabel x-axis in the orchard plots (so EPM/OFT/etc. show)
res_rr$plot  <- res_rr$plot  + scale_x_discrete(labels = lifestage_labels)
res_vr$plot  <- res_vr$plot  + scale_x_discrete(labels = lifestage_labels)
res_cvr$plot <- res_cvr$plot + scale_x_discrete(labels = lifestage_labels)

# 3) Tukey contrasts (use the filtered data + matched VCV for each dataset)

tuk_rr  <- maybe_tukey(dat = f_rr$data,  V = f_rr$V,  yi = "lnRR",  moderator = MOD)
tuk_vr  <- maybe_tukey(dat = f_vr$data,  V = f_vr$V,  yi = "lnVR",  moderator = MOD)
tuk_cvr <- maybe_tukey(dat = f_cvr$data, V = f_cvr$V, yi = "lnCVR", moderator = MOD)

```






:::: columns

:::: {.column width="49%"}
### lnRR
```{r}
summary(res_rr$model)
```
```{r}
#| label: Lifestage_lnRR_r2
res_rr$r2
```

::: card
```{r}
#| label: Lifestage_lnRR_plot
res_rr$plot
```
:::
```{r}
#| label: Lifestage_lnRR_tukey
tuk_rr
```

:::

:::: {.column width="2%"} ::::
:::


:::: {.column width="49%"}

### lnVR

```{r}
#| label: Lifestage_lnVR_summary
summary(res_vr$model)
```


```{r}
#| label: Lifestage_lnVR_r2
res_vr$r2
```

::: card
```{r}
#| label: Lifestage_lnVR_plot
res_vr$plot
```
:::
```{r}
#| label: Lifestage_lnVR_tukey
tuk_vr
```
:::

:::


:::: {.column width="25%"} 
::::
:::: {.column width="50%"}
### lnCVR
```{r}
#| label: Lifestage_lnCVR_summary
summary(res_cvr$model)
```

```{r}
#| label: Lifestage_lnCVR_r2
res_cvr$r2
```

::: card
```{r}
#| label: Lifestage_lnCVR_plot
res_cvr$plot
```
:::

```{r}
#| label: Lifestage_lnCVR_tukey
tuk_cvr

```

:::
:::: {.column width="25%"}
:::


## Control conditions

```{r}
#| label: run_Control_conditions
MOD  <- "Control_conditions"
MODS <- "~ `Control_conditions`"

f_rr  <- filter_low_k_single(db_rr,  VCV_rr,  MOD, min_k = 5)
f_vr  <- filter_low_k_single(db_vr,  VCV_vr,  MOD, min_k = 5)
f_cvr <- filter_low_k_single(db_cvr, VCV_cvr, MOD, min_k = 5)

res_rr  <- fit_unimod(f_rr$data,  f_rr$V,  "lnRR",  MODS, MOD, expression(lnRR))
res_vr  <- fit_unimod(f_vr$data,  f_vr$V,  "lnVR",  MODS, MOD, expression(lnVR))
res_cvr <- fit_unimod(f_cvr$data, f_cvr$V, "lnCVR", MODS, MOD, expression(lnCVR))


```




:::: columns

:::: {.column width="49%"}
### lnRR
```{r}
summary(res_rr$model)
```
```{r}
#| label: Control_conditions_lnRR_r2
res_rr$r2
```

::: card
```{r}
#| label: Control_conditions_lnRR_plot
res_rr$plot
```
:::

:::

:::: {.column width="2%"} ::::
:::


:::: {.column width="49%"}

### lnVR

```{r}
#| label: Control_conditions_lnVR_summary
summary(res_vr$model)
```


```{r}
#| label: Control_conditions_lnVR_r2
res_vr$r2
```

::: card
```{r}
#| label: Control_conditions_lnVR_plot
res_vr$plot
```
:::

:::

:::


:::: {.column width="25%"} 
::::
:::: {.column width="50%"}
### lnCVR
```{r}
#| label: Control_conditions_lnCVR_summary
summary(res_cvr$model)
```

```{r}
#| label: Control_conditions_lnCVR_r2
res_cvr$r2
```

::: card
```{r}
#| label: Control_conditions_lnCVR_plot
res_cvr$plot
```
:::
:::




## Relative timing


```{r}
#| label: run_relative
MOD  <- "Relative_timing"
MODS <- "~ Relative_timing -1"





# 1) Filter each effect-size dataset (and subset the VCV accordingly)
f_rr  <- filter_low_k_single(db_rr,  VCV_rr,  MOD, min_k = 5)
f_vr  <- filter_low_k_single(db_vr,  VCV_vr,  MOD, min_k = 5)
f_cvr <- filter_low_k_single(db_cvr, VCV_cvr, MOD, min_k = 5)



# 2) Fit the three unimoderator models (same moderator, different yi/vi)
res_rr  <- fit_unimod(f_rr$data,  f_rr$V,  "lnRR",  MODS, MOD, expression(lnRR))
res_vr  <- fit_unimod(f_vr$data,  f_vr$V,  "lnVR",  MODS, MOD, expression(lnVR))
res_cvr <- fit_unimod(f_cvr$data, f_cvr$V, "lnCVR", MODS, MOD, expression(lnCVR))



# 3) Tukey contrasts (use the filtered data + matched VCV for each dataset)

tuk_rr  <- maybe_tukey(dat = f_rr$data,  V = f_rr$V,  yi = "lnRR",  moderator = MOD)
tuk_vr  <- maybe_tukey(dat = f_vr$data,  V = f_vr$V,  yi = "lnVR",  moderator = MOD)
tuk_cvr <- maybe_tukey(dat = f_cvr$data, V = f_cvr$V, yi = "lnCVR", moderator = MOD)

```






:::: columns

:::: {.column width="49%"}
### lnRR
```{r}
summary(res_rr$model)
```
```{r}
#| label: Relative_timing_lnRR_r2
res_rr$r2
```

::: card
```{r}
#| label: Relative_timing_lnRR_plot
res_rr$plot
```
:::
```{r}
#| label: Relative_timing_lnRR_tukey
tuk_rr
```
:::

:::: {.column width="2%"} 
::::


:::: {.column width="49%"}

### lnVR

```{r}
#| label: Relative_timing_lnVR_summary
summary(res_vr$model)
```


```{r}
#| label: Relative_timing_lnVR_r2
res_vr$r2
```

::: card
```{r}
#| label: Relative_timing_lnVR_plot
res_vr$plot
```
:::
```{r}
#| label: Relative_timing_lnVR_tukey
tuk_vr
```
:::




:::: {.column width="25%"} 
::::

:::: {.column width="50%"}
### lnCVR
```{r}
#| label: Relative_timing_lnCVR_summary
summary(res_cvr$model)
```

```{r}
#| label: Relative_timing_lnCVR_r2
res_cvr$r2
```

::: card
```{r}
#| label: Relative_timing_lnCVR_plot
res_cvr$plot
```
:::

```{r}
#| label: Relative_timing_lnCVR_tukey
tuk_cvr

```

:::
:::: {.column width="25%"}
:::


## Music genre









```{r}
#| label: run_genre
MOD  <- "Meta_genre"
MODS <- "~ Meta_genre -1"


genre_labels <- c(
  "Mixed"  = "Mixed",
  "Popular Contemporary Music"       = "Contemporary",
  "Traditional Music / Folk / World"    = "World",
  "Western Art Music / Orchestral" = "Orchestral"
)



# 1) Filter each effect-size dataset (and subset the VCV accordingly)
f_rr  <- filter_low_k_single(db_rr,  VCV_rr,  MOD, min_k = 5)
f_vr  <- filter_low_k_single(db_vr,  VCV_vr,  MOD, min_k = 5)
f_cvr <- filter_low_k_single(db_cvr, VCV_cvr, MOD, min_k = 5)



# 2) Fit the three unimoderator models (same moderator, different yi/vi)
res_rr  <- fit_unimod(f_rr$data,  f_rr$V,  "lnRR",  MODS, MOD, expression(lnRR))
res_vr  <- fit_unimod(f_vr$data,  f_vr$V,  "lnVR",  MODS, MOD, expression(lnVR))
res_cvr <- fit_unimod(f_cvr$data, f_cvr$V, "lnCVR", MODS, MOD, expression(lnCVR))



# 2b) Relabel x-axis in the orchard plots (so EPM/OFT/etc. show)
res_rr$plot  <- res_rr$plot  + scale_x_discrete(labels = genre_labels)
res_vr$plot  <- res_vr$plot  + scale_x_discrete(labels = genre_labels)
res_cvr$plot <- res_cvr$plot + scale_x_discrete(labels = genre_labels)





# 3) Tukey contrasts (use the filtered data + matched VCV for each dataset)

tuk_rr  <- maybe_tukey(dat = f_rr$data,  V = f_rr$V,  yi = "lnRR",  moderator = MOD)
tuk_vr  <- maybe_tukey(dat = f_vr$data,  V = f_vr$V,  yi = "lnVR",  moderator = MOD)
tuk_cvr <- maybe_tukey(dat = f_cvr$data, V = f_cvr$V, yi = "lnCVR", moderator = MOD)

```






:::: columns

:::: {.column width="49%"}
### lnRR
```{r}
summary(res_rr$model)
```
```{r}
#| label: Meta_genre_lnRR_r2
res_rr$r2
```

::: card
```{r}
#| label: Meta_genre_lnRR_plot
res_rr$plot
```
:::
```{r}
#| label: Meta_genre_lnRR_tukey
tuk_rr
```

:::

:::: {.column width="2%"} ::::
:::


:::: {.column width="49%"}

### lnVR

```{r}
#| label: Meta_genre_lnVR_summary
summary(res_vr$model)
```


```{r}
#| label: Meta_genre_lnVR_r2
res_vr$r2
```

::: card
```{r}
#| label: Meta_genre_lnVR_plot
res_vr$plot
```
:::
```{r}
#| label: Meta_genre_lnVR_tukey
tuk_vr
```
:::

:::


:::: {.column width="25%"} 
::::
:::: {.column width="50%"}
### lnCVR
```{r}
#| label: Meta_genre_lnCVR_summary
summary(res_cvr$model)
```

```{r}
#| label: Meta_genre_lnCVR_r2
res_cvr$r2
```

::: card
```{r}
#| label: Meta_genre_lnCVR_plot
res_cvr$plot
```
:::

```{r}
#| label: Meta_genre_lnCVR_tukey
tuk_cvr

```

:::
:::: {.column width="25%"}
:::




## Experimental design






```{r}
#| label: run_Experimental_design
MOD  <- "Experimental_design"
MODS <- "~ Experimental_design -1"


design_labels<-c(
  "Factorial"="Factorial",
  "Posttest-Only Control Group"="Posttest",
  "Repeated Measures"="Repeated"
  
)



# 1) Filter each effect-size dataset (and subset the VCV accordingly)
f_rr  <- filter_low_k_single(db_rr,  VCV_rr,  MOD, min_k = 5)
f_vr  <- filter_low_k_single(db_vr,  VCV_vr,  MOD, min_k = 5)
f_cvr <- filter_low_k_single(db_cvr, VCV_cvr, MOD, min_k = 5)



# 2) Fit the three unimoderator models (same moderator, different yi/vi)
res_rr  <- fit_unimod(f_rr$data,  f_rr$V,  "lnRR",  MODS, MOD, expression(lnRR))
res_vr  <- fit_unimod(f_vr$data,  f_vr$V,  "lnVR",  MODS, MOD, expression(lnVR))
res_cvr <- fit_unimod(f_cvr$data, f_cvr$V, "lnCVR", MODS, MOD, expression(lnCVR))



# 2b) Relabel x-axis in the orchard plots (so EPM/OFT/etc. show)
res_rr$plot  <- res_rr$plot  + scale_x_discrete(labels = design_labels)
res_vr$plot  <- res_vr$plot  + scale_x_discrete(labels = design_labels)
res_cvr$plot <- res_cvr$plot + scale_x_discrete(labels = design_labels)





# 3) Tukey contrasts (use the filtered data + matched VCV for each dataset)

tuk_rr  <- maybe_tukey(dat = f_rr$data,  V = f_rr$V,  yi = "lnRR",  moderator = MOD)
tuk_vr  <- maybe_tukey(dat = f_vr$data,  V = f_vr$V,  yi = "lnVR",  moderator = MOD)
tuk_cvr <- maybe_tukey(dat = f_cvr$data, V = f_cvr$V, yi = "lnCVR", moderator = MOD)

```






:::: columns

:::: {.column width="49%"}
### lnRR
```{r}
summary(res_rr$model)
```
```{r}
#| label: Experimental_design_lnRR_r2
res_rr$r2
```

::: card
```{r}
#| label: Experimental_design_lnRR_plot
res_rr$plot
```
:::
```{r}
#| label: Experimental_design_lnRR_tukey
tuk_rr
```

:::

:::: {.column width="2%"} ::::
:::


:::: {.column width="49%"}

### lnVR

```{r}
#| label: Experimental_design_lnVR_summary
summary(res_vr$model)
```


```{r}
#| label: Experimental_design_lnVR_r2
res_vr$r2
```

::: card
```{r}
#| label: Experimental_design_lnVR_plot
res_vr$plot
```
:::
```{r}
#| label: Experimental_design_lnVR_tukey
tuk_vr
```
:::

:::


:::: {.column width="25%"} 
::::
:::: {.column width="50%"}
### lnCVR
```{r}
#| label: Experimental_design_lnCVR_summary
summary(res_cvr$model)
```

```{r}
#| label: Experimental_design_lnCVR_r2
res_cvr$r2
```

::: card
```{r}
#| label: Experimental_design_lnCVR_plot
res_cvr$plot
```
:::

```{r}
#| label: Experimental_design_lnCVR_tukey
tuk_cvr

```

:::
:::: {.column width="25%"}
:::




## Sex 




```{r}
#| label: run_Sex
MOD  <- "Sex"
MODS <- "~ Sex"

f_rr  <- filter_low_k_single(db_rr,  VCV_rr,  MOD, min_k = 5)
f_vr  <- filter_low_k_single(db_vr,  VCV_vr,  MOD, min_k = 5)
f_cvr <- filter_low_k_single(db_cvr, VCV_cvr, MOD, min_k = 5)

res_rr  <- fit_unimod(f_rr$data,  f_rr$V,  "lnRR",  MODS, MOD, expression(lnRR))
res_vr  <- fit_unimod(f_vr$data,  f_vr$V,  "lnVR",  MODS, MOD, expression(lnVR))
res_cvr <- fit_unimod(f_cvr$data, f_cvr$V, "lnCVR", MODS, MOD, expression(lnCVR))


```




:::: columns

:::: {.column width="49%"}
### lnRR
```{r}
summary(res_rr$model)
```
```{r}
#| label: Sex_lnRR_r2
res_rr$r2
```

::: card
```{r}
#| label: Sex_lnRR_plot
res_rr$plot
```
:::

:::

:::: {.column width="2%"} ::::
:::


:::: {.column width="49%"}

### lnVR

```{r}
#| label: Sex_lnVR_summary
summary(res_vr$model)
```


```{r}
#| label: Sex_lnVR_r2
res_vr$r2
```

::: card
```{r}
#| label: Sex_lnVR_plot
res_vr$plot
```
:::

:::

:::


:::: {.column width="25%"} 
::::
:::: {.column width="50%"}
### lnCVR
```{r}
#| label: Sex_lnCVR_summary
summary(res_cvr$model)
```

```{r}
#| label: Sex_lnCVR_r2
res_cvr$r2
```

::: card
```{r}
#| label: Sex_lnCVR_plot
res_cvr$plot
```
:::
:::
:::: {.column width="25%"}
:::




## Exposure duration



Music_exposure_duration



```{r}
#| label: run_Exposure
MOD  <- "Music_exposure_duration"
MODS <- "~ Music_exposure_duration -1"





# 1) Filter each effect-size dataset (and subset the VCV accordingly)
f_rr  <- filter_low_k_single(db_rr,  VCV_rr,  MOD, min_k = 5)
f_vr  <- filter_low_k_single(db_vr,  VCV_vr,  MOD, min_k = 5)
f_cvr <- filter_low_k_single(db_cvr, VCV_cvr, MOD, min_k = 5)



# 2) Fit the three unimoderator models (same moderator, different yi/vi)
res_rr  <- fit_unimod(f_rr$data,  f_rr$V,  "lnRR",  MODS, MOD, expression(lnRR))
res_vr  <- fit_unimod(f_vr$data,  f_vr$V,  "lnVR",  MODS, MOD, expression(lnVR))
res_cvr <- fit_unimod(f_cvr$data, f_cvr$V, "lnCVR", MODS, MOD, expression(lnCVR))







# 3) Tukey contrasts (use the filtered data + matched VCV for each dataset)

tuk_rr  <- maybe_tukey(dat = f_rr$data,  V = f_rr$V,  yi = "lnRR",  moderator = MOD)
tuk_vr  <- maybe_tukey(dat = f_vr$data,  V = f_vr$V,  yi = "lnVR",  moderator = MOD)
tuk_cvr <- maybe_tukey(dat = f_cvr$data, V = f_cvr$V, yi = "lnCVR", moderator = MOD)

```






:::: columns

:::: {.column width="49%"}
### lnRR
```{r}
summary(res_rr$model)
```
```{r}
#| label: Music_exposure_duration_lnRR_r2
res_rr$r2
```

::: card
```{r}
#| label: Music_exposure_duration_lnRR_plot
res_rr$plot
```
:::
```{r}
#| label: Music_exposure_duration_lnRR_tukey
tuk_rr
```

:::

:::: {.column width="2%"} ::::
:::


:::: {.column width="49%"}

### lnVR

```{r}
#| label: Music_exposure_duration_lnVR_summary
summary(res_vr$model)
```


```{r}
#| label: Music_exposure_duration_lnVR_r2
res_vr$r2
```

::: card
```{r}
#| label: Music_exposure_duration_lnVR_plot
res_vr$plot
```
:::
```{r}
#| label: Music_exposure_duration_lnVR_tukey
tuk_vr
```
:::

:::


:::: {.column width="25%"} 
::::
:::: {.column width="50%"}
### lnCVR
```{r}
#| label: Music_exposure_duration_lnCVR_summary
summary(res_cvr$model)
```

```{r}
#| label: Music_exposure_duration_lnCVR_r2
res_cvr$r2
```

::: card
```{r}
#| label: Music_exposure_duration_lnCVR_plot
res_cvr$plot
```
:::

```{r}
#| label: Music_exposure_duration_lnCVR_tukey
tuk_cvr

```

:::
:::: {.column width="25%"}
:::



## Experimental procedure







```{r}
#| label: run_Experimental_procedures
MOD  <- "Experimental_procedures"
MODS <- "~ Experimental_procedures"

f_rr  <- filter_low_k_single(db_rr,  VCV_rr,  MOD, min_k = 5)
f_vr  <- filter_low_k_single(db_vr,  VCV_vr,  MOD, min_k = 5)
f_cvr <- filter_low_k_single(db_cvr, VCV_cvr, MOD, min_k = 5)

res_rr  <- fit_unimod(f_rr$data,  f_rr$V,  "lnRR",  MODS, MOD, expression(lnRR))
res_vr  <- fit_unimod(f_vr$data,  f_vr$V,  "lnVR",  MODS, MOD, expression(lnVR))
res_cvr <- fit_unimod(f_cvr$data, f_cvr$V, "lnCVR", MODS, MOD, expression(lnCVR))


```




:::: columns

:::: {.column width="49%"}
### lnRR
```{r}
summary(res_rr$model)
```
```{r}
#| label: Experimental_procedures_lnRR_r2
res_rr$r2
```

::: card
```{r}
#| label: Experimental_procedures_lnRR_plot
res_rr$plot
```
:::

:::

:::: {.column width="2%"} ::::
:::


:::: {.column width="49%"}

### lnVR

```{r}
#| label: Experimental_procedures_lnVR_summary
summary(res_vr$model)
```


```{r}
#| label: Experimental_procedures_lnVR_r2
res_vr$r2
```

::: card
```{r}
#| label: Experimental_procedures_lnVR_plot
res_vr$plot
```
:::

:::

:::


:::: {.column width="25%"} 
::::
:::: {.column width="50%"}
### lnCVR
```{r}
#| label: Experimental_procedures_lnCVR_summary
summary(res_cvr$model)
```

```{r}
#| label: Experimental_procedures_lnCVR_r2
res_cvr$r2
```

::: card
```{r}
#| label: Experimental_procedures_lnCVR_plot
res_cvr$plot
```
:::
:::
:::: {.column width="25%"}
:::









::: callout-note
```{r}
sessionInfo()
```
:::