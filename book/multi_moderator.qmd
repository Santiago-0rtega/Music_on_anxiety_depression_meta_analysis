---
title: "Multi_moderator"
---

In this chapter, we move from single-variable analysis to a Multi-Moderator Meta-Regression. This allows us to determine which factors drive the effect size when controlling for others, helping us disentangle overlapping influences


## Setup and Collinearity Check

First, we check if our moderators are too similar to each other (multicollinearity). Since our variables are categorical, we use Goodman-Kruskal's Tau instead of standard correlations.

```{r}
#| label: setup_and_collinearity
#| message: false
#| warning: false

# Load libraries and data
pacman::p_load(DT, dtplyr, here, knitr, tidyverse, patchwork, metafor, orchaRd, GoodmanKruskal)

db <- readr::read_csv(here("..","data","db_lnRR.csv")) %>%
  mutate(across(c(C_n, Ex_n, C_mean, Ex_mean, C_SE, Ex_SE, C_SD, Ex_SD), as.numeric)) %>%
  mutate(across(where(is.character), as.factor))

# Define the list of moderators we want to test
moderators_to_check <- c(
  "Outcome_type", "Lifestage_exposure", "Sex", "Meta_genre", 
  "Music_exposure_duration", "Experimental_design", "Induced behaviour", 
  "Relative_timing", "Experimental_procedures", "Control_conditions", "Assay_type"
)

# Subset data to just these columns
dat_mods <- db %>% dplyr::select(all_of(moderators_to_check))

# Calculate categorical association (GK Tau)
corr_cat <- GKtauDataframe(dat_mods)

# Plot the association heatmap
plot(corr_cat)
```


## Matrix Calculation & Sequential Filtering

::: {.callout-important}
Running a multi-moderator model requires a dataset where every included study has valid data for every moderator in the model.The code below performs a strict filter:It iterates through all intended moderators.It removes any level with $k < 5$.It updates the dataset, meaning a study is only kept if it survives the filter for all variables simultaneously.Finally, it subsets the VCV matrix to match this reduced dataset perfectly.
:::




```{r}
#| label: sequential_filtering
#| fold: true

# 1. Calculate the initial Variance-Covariance Matrix
VCV <- metafor::vcalc(
  vi = lnRR_var,
  cluster = Cohort_ID, 
  obs = ES_ID,         
  rho = 0.5,            
  data = db 
)

# Moderators to include in the final model
moderators <- c("Lifestage_exposure", "Sex", "Meta_genre", 
  "Music_exposure_duration", "Experimental_design", 
  "Induced behaviour", "Relative_timing", "Experimental_procedures", 
  "Control_conditions", "Assay_type")

# Initialize filtered dataset
db_final <- db

# --- Strict Sequential Filtering Loop ---
for (mod in moderators) {
  
  mod_sym <- sym(mod) 
  
  # Count k per level in the CURRENTLY filtered dataframe
  k_counts <- db_final %>%
    group_by(!!mod_sym) %>%
    summarise(k_es = n(), .groups = 'drop')

  # Keep levels with sufficient data (k >= 5)
  levels_to_keep_mod <- k_counts %>%
    filter(k_es >= 5) %>%
    pull(!!mod_sym)

  # Update the dataframe
  db_final <- db_final %>%
    filter(!!mod_sym %in% levels_to_keep_mod)
}

# --- Final Cleanup ---

# Drop unused factor levels
db_final <- db_final %>% mutate(across(all_of(moderators), droplevels))

# Match the VCV matrix to the new data indices
indices_to_keep <- which(db$ES_ID %in% db_final$ES_ID) 
VCV_final <- VCV[indices_to_keep, indices_to_keep]

print(paste("Final dataset size:", nrow(db_final), "ES_IDs"))
```

## Model Selection (Backward Elimination)


::: {.callout-tip}
The code below follows a manual Backward Elimination process:

- Full Model: We run the model with all predictors.

- Assess: We check the results (AIC, $R^2$, p-values).

- Drop Weakest: We identify the variable contributing the least (highest p-value or negligible $R^2$ contribution) and remove it.

- Repeat: We re-run the model and repeat until we have the "Best" parsimonious model.
:::


### Step 1: the full model
```{r}

#| label: model_full

mMULTI <- rma.mv(yi = lnRR, V = VCV_final, 
                 mods = ~ Lifestage_exposure + Assay_type + `Induced behaviour` +
                          Sex + Meta_genre + Music_exposure_duration +
                          Experimental_design + Relative_timing +
                          Experimental_procedures + Control_conditions,
                 random = list(~1 | Study_ID, ~1 | ES_ID, ~1 | Strain),
                 test = "t", method = "REML", sparse = TRUE, data = db_final)

summary(mMULTI)

```

```{r}
round(r2_ml(mMULTI), 4)
```

### Step 2: Testing Removals
We now re-run the model removing one variable at a time to see how it affects model fit.



```{r}
#| label: model_minus_sex
#| code-fold: true
#| code-summary: "Test: Removing Sex"

# Removed: Sex
mMULTI <- rma.mv(yi = lnRR, V = VCV_final, 
                 mods = ~ Lifestage_exposure + 
                   Assay_type + 
                   `Induced behaviour` +
                          # Sex +  <-- REMOVED
                          Meta_genre +
                   Music_exposure_duration +
                          Experimental_design +
                   Relative_timing +
                          Experimental_procedures +
                   Control_conditions,
                 random = list(~1 | Study_ID, ~1 | ES_ID, ~1 | Strain),
                 test = "t", method = "REML", sparse = TRUE, data = db_final)

round(r2_ml(mMULTI), 4)
```

```{r}
#| label: model_minus_genre
#| code-fold: true
#| code-summary: "Test: Removing Meta_genre"

# Removed:  Meta_genre
mMULTI <- rma.mv(yi = lnRR, V = VCV_final, 
                 mods = ~ Lifestage_exposure + 
                   Assay_type + 
                   `Induced behaviour` +
                          Sex +
                          # Meta_genre + <-- REMOVED
                          Music_exposure_duration +
                          Experimental_design +
                   Relative_timing +
                          Experimental_procedures + 
                   Control_conditions,
                 random = list(~1 | Study_ID, ~1 | ES_ID, ~1 | Strain),
                 test = "t", method = "REML", sparse = TRUE, data = db_final)

round(r2_ml(mMULTI), 4)
```



```{r}
#| label: model_minus_duration
#| code-fold: true
#| code-summary: "Test: Removing Music Duration"

# Removed: Music_exposure_duration
mMULTI <- rma.mv(yi = lnRR, V = VCV_final, 
                 mods = ~ Lifestage_exposure +
                   Assay_type +
                   `Induced behaviour` +
                          Sex +
                   Meta_genre + 
                          # Music_exposure_duration + <-- REMOVED
                          Experimental_design + 
                   Relative_timing +
                          Experimental_procedures + 
                   Control_conditions,
                 random = list(~1 | Study_ID, ~1 | ES_ID, ~1 | Strain),
                 test = "t", method = "REML", sparse = TRUE, data = db_final)

round(r2_ml(mMULTI), 4)
```




```{r}
#| label: model_minus_Experimental_design
#| code-fold: true
#| code-summary: "Test: Removing Experimental_design"

# Removed: Experimental_design
mMULTI <- rma.mv(yi = lnRR, V = VCV_final, 
                 mods = ~ Lifestage_exposure +
                   Assay_type +
                   `Induced behaviour` +
                          Sex +
                   Meta_genre + 
                           Music_exposure_duration + 
                          #Experimental_design + <-- REMOVED
                   Relative_timing +
                          Experimental_procedures + 
                   Control_conditions,
                 random = list(~1 | Study_ID, ~1 | ES_ID, ~1 | Strain),
                 test = "t", method = "REML", sparse = TRUE, data = db_final)

round(r2_ml(mMULTI), 4)
```



```{r}
#| label: model_minus_Experimental_relative_timing
#| code-fold: true
#| code-summary: "Test: Removing relative_timing"

# Removed: relative_timing
mMULTI <- rma.mv(yi = lnRR, V = VCV_final, 
                 mods = ~ Lifestage_exposure +
                   Assay_type +
                   `Induced behaviour` +
                          Sex +
                   Meta_genre + 
                           Music_exposure_duration + 
                          Experimental_design + 
                   #Relative_timing + <-- REMOVED
                          Experimental_procedures + 
                   Control_conditions,
                 random = list(~1 | Study_ID, ~1 | ES_ID, ~1 | Strain),
                 test = "t", method = "REML", sparse = TRUE, data = db_final)

round(r2_ml(mMULTI), 4)
```



```{r}
#| label: model_minus_Experimental_procedures
#| code-fold: true
#| code-summary: "Test: Removing Experimental_procedures"

# Removed: Experimental_procedures
mMULTI <- rma.mv(yi = lnRR, V = VCV_final, 
                 mods = ~ Lifestage_exposure +
                   Assay_type +
                   `Induced behaviour` +
                          Sex +
                   Meta_genre + 
                           Music_exposure_duration + 
                          Experimental_design + 
                   Relative_timing + 
                          #Experimental_procedures + <-- REMOVED
                   Control_conditions,
                 random = list(~1 | Study_ID, ~1 | ES_ID, ~1 | Strain),
                 test = "t", method = "REML", sparse = TRUE, data = db_final)

round(r2_ml(mMULTI), 4)
```



```{r}
#| label: model_minus_control_conditions
#| code-fold: true
#| code-summary: "Test: Removing control_conditions"

# Removed: control_conditions
mMULTI <- rma.mv(yi = lnRR, V = VCV_final, 
                 mods = ~ Lifestage_exposure +
                   Assay_type +
                   `Induced behaviour` +
                          Sex +
                   Meta_genre + 
                           Music_exposure_duration + 
                          Experimental_design + 
                   Relative_timing + 
                          Experimental_procedures, 
                   #Control_conditions<-- REMOVED,
                 random = list(~1 | Study_ID, ~1 | ES_ID, ~1 | Strain),
                 test = "t", method = "REML", sparse = TRUE, data = db_final)

round(r2_ml(mMULTI), 4)

```


## Round 2
First, let's establish our new "Current Best" model and record its $R^2$ and AIC

```{r}
#| label: round2_baseline

# BASELINE ROUND 2: Everything EXCEPT Music_exposure_duration
mMULTI_R2 <- rma.mv(yi = lnRR, V = VCV_final, 
                 mods = ~ Lifestage_exposure + 
                   Assay_type + 
                   `Induced behaviour` +
                          Sex + Meta_genre + 
                          # Music_exposure_duration +  <-- CONFIRMED REMOVED
                          Experimental_design +
                   Relative_timing +
                          Experimental_procedures + 
                   Control_conditions,
                 random = list(~1 | Study_ID, ~1 | ES_ID, ~1 | Strain),
                 test = "t", method = "REML", sparse = TRUE, data = db_final)

print("--- Baseline Round 2 Stats ---")
round(r2_ml(mMULTI_R2), 4)

```

## Test 2.1: Remove Sex
Does removing Sex improve the model further?
```{r}
#| label: test_remove_sex

model_no_sex <- rma.mv(yi = lnRR, V = VCV_final, 
                 mods = ~ Lifestage_exposure + Assay_type + `Induced behaviour` +
                          # Sex +  <-- REMOVING THIS
                          Meta_genre + 
                          Experimental_design + Relative_timing +
                          Experimental_procedures + Control_conditions,
                 random = list(~1 | Study_ID, ~1 | ES_ID, ~1 | Strain),
                 test = "t", method = "REML", sparse = TRUE, data = db_final)

# Compare to Baseline Round 2
round(r2_ml(model_no_sex), 4)

```


## Test 2.2: Remove Meta_genre

```{r}
#| label: test_remove_genre

model_no_genre <- rma.mv(yi = lnRR, V = VCV_final, 
                 mods = ~ Lifestage_exposure + Assay_type + `Induced behaviour` +
                          Sex + 
                          # Meta_genre + <-- REMOVING THIS
                          Experimental_design + Relative_timing +
                          Experimental_procedures + Control_conditions,
                 random = list(~1 | Study_ID, ~1 | ES_ID, ~1 | Strain),
                 test = "t", method = "REML", sparse = TRUE, data = db_final)

round(r2_ml(model_no_genre), 4)
```
## Test 2.3: Remove Experimental_design
```{r}
#| label: test_remove_design

model_no_design <- rma.mv(yi = lnRR, V = VCV_final, 
                 mods = ~ Lifestage_exposure + Assay_type + `Induced behaviour` +
                          Sex + Meta_genre + 
                          # Experimental_design + <-- REMOVING THIS
                          Relative_timing +
                          Experimental_procedures + Control_conditions,
                 random = list(~1 | Study_ID, ~1 | ES_ID, ~1 | Strain),
                 test = "t", method = "REML", sparse = TRUE, data = db_final)

round(r2_ml(model_no_design), 4)
```

## Test 2.4: Remove Relative_timing

```{r}
#| label: test_remove_timing

model_no_timing <- rma.mv(yi = lnRR, V = VCV_final, 
                 mods = ~ Lifestage_exposure + Assay_type + `Induced behaviour` +
                          Sex + Meta_genre + 
                          Experimental_design + 
                          # Relative_timing + <-- REMOVING THIS
                          Experimental_procedures + Control_conditions,
                 random = list(~1 | Study_ID, ~1 | ES_ID, ~1 | Strain),
                 test = "t", method = "REML", sparse = TRUE, data = db_final)

round(r2_ml(model_no_timing), 4)
```
## Test 2.5: Remove Control_conditions

```{r}
#| label: test_remove_control

model_no_control <- rma.mv(yi = lnRR, V = VCV_final, 
                 mods = ~ Lifestage_exposure + Assay_type + `Induced behaviour` +
                          Sex + Meta_genre + 
                          Experimental_design + Relative_timing +
                          Experimental_procedures, 
                          # Control_conditions + <-- REMOVING THIS
                 random = list(~1 | Study_ID, ~1 | ES_ID, ~1 | Strain),
                 test = "t", method = "REML", sparse = TRUE, data = db_final)

round(r2_ml(model_no_control), 4)
```



## Step 3: The "Best" Model

After comparing the models above, we settle on this final specification.

```{r}


#| label: best_model_minus_duration
#| code-fold: true
#| code-summary: "Test: Removing Music Duration"

# Removed: Music_exposure_duration
mMULTI <- rma.mv(yi = lnRR, V = VCV_final, 
                 mods = ~ Lifestage_exposure +
                   Assay_type +
                   `Induced behaviour` +
                          Sex +
                   Meta_genre + 
                          # Music_exposure_duration + <-- REMOVED
                          Experimental_design + 
                   Relative_timing +
                          Experimental_procedures + 
                   Control_conditions,
                 random = list(~1 | Study_ID, ~1 | ES_ID, ~1 | Strain),
                 test = "t", method = "REML", sparse = TRUE, data = db_final)

round(r2_ml(mMULTI), 4)
```

```{r}
summary(mMULTI)
```

