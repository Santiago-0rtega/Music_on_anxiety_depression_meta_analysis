tidyverse,
patchwork,
metafor,
orchaRd, emmeans
)
db <- readr::read_csv(here("..","data","db_lnRR.csv")) %>%
mutate(across(c(C_n, Ex_n, C_mean, Ex_mean, C_SE, Ex_SE, C_SD, Ex_SD), as.numeric))%>%
mutate(across(where(is.character), as.factor))
VCV <- metafor::vcalc(
vi = lnRR_var,
cluster = Cohort_ID, # The clustering variable (Study_ID + Ex_ID)
obs = ES_ID,         # The unique observation/effect size ID
rho = 0.5,           # Assumed correlation between outcomes from the same cohort
data = db
)
ma_all <- rma.mv(yi = lnRR,
V = VCV,
random = list(~1 | Study_ID,
~1 | ES_ID,
~1 | Strain),
test = "t",
method = "REML",
sparse = TRUE,
data = db)
summary(ma_all)
# funnel plot - standard error
funnel(ma_all, yaxis = "sei",
xlab = "Standarised residuals",
ylab = "Precision (inverse of SE)" )
# funnel plot - inverse of standard error
funnel_plot<-funnel(ma_all, yaxis = "seinv",
las = 1,                   # Rotates Y-axis text to be horizontal
digits = c(2, 1),
xlab = "Standarised residuals (lnRR)",
ylab = "Precision (inverse of SE)",  pch = 21,                  #
bg = alpha("black", 0.2),
col = "black",
cex = 1.2,ylim = c(0.01, 40),
xlim = c(-6, 10)
)
funnel_plot
#| label: eggers_test
# 1. Calculate the effective sample size term (sqrt_inv_e_n)
# Formula: sqrt(2/Ex_n + 2/C_n) approximates the standard error based on N
dt_egger_full <- db %>%
mutate(sqrt_inv_e_n = sqrt((2 / Ex_n) + (2 / C_n)))
# 2. Run the Meta-Regression
# If 'sqrt_inv_e_n' is significant (p < 0.05), we have evidence of small-study effects.
egger_model_full <- rma.mv(yi = lnRR,
V = VCV,
mods = ~ 1 + sqrt_inv_e_n, # The 'Egger' predictor
random = list(~1 | Study_ID, ~1 | ES_ID),
test = "z",
method = "REML",
sparse = TRUE,
data = dt_egger_full)
summary(egger_model_full)
#| label: egger_bubble_plot
egger<-bubble_plot(egger_model_full,
mod = "sqrt_inv_e_n",
group = "Study_ID",
xlab = "Square root of inverse of effective sample size", ylab="Effect size (lnRR)")
egger
#| label: time_lag_analysis
# 1. Mean-Center the Year (Interpretation: Intercept = Effect in average year)
db_decline <- dt_egger_full %>%
mutate(Year_c = Year - mean(Year, na.rm = TRUE))
# 2. Run model: Controlling for Precision (Egger) AND Year simultaneously
year_lag_model <- rma.mv(yi = lnRR,
V = VCV,
mods = ~ 1 + Year_c + sqrt_inv_e_n,
random = list(~1 | Study_ID, ~1 | ES_ID),
test = "t",
method = "REML",
sparse = TRUE,
data = db_decline)
summary(year_lag_model)
#| label: time_lag_bubble_plot
time_lag<-bubble_plot(year_lag_model,
mod = "Year_c",
group = "Study_ID",
xlab = "Year of publication",ylab="Effect size (lnRR)")
mean_year <- mean(dt_egger_full$Year, na.rm = TRUE)
# Define the years you want to see on the axis
target_years <- seq(2007, 2025, by = 3)
lag2<-time_lag +
scale_x_continuous(
name = "Year of publication",
breaks = target_years - mean_year,
labels = target_years
)
lag2
library(patchwork)
library(gridGraphics) # Required for capturing Base R plots
# --- Plot 1: Funnel Plot (Wrapped for Patchwork) ---
# We use 'wrap_elements(panel = ~function())' to capture the Base R drawing
p_funnel <- wrap_elements(panel = ~funnel(ma_all,
yaxis = "seinv",
las = 1,
digits = c(2, 1),
xlab = "Standardised residuals (lnRR)",
ylab = "Precision (1/SE)",
pch = 21,
bg = alpha("black", 0.2),
col = "black",
cex = 1.2,
ylim = c(0.01, 40),
xlim = c(-6, 10)
))
p_funnel <- wrap_elements(panel = ~{
par(mar = c(4, 4, 1, 1)) # Reduce margins: Bottom, Left, Top, Right
funnel(ma_all, yaxis = "seinv", ...) # Your funnel code here
})
final_dashboard <- (p_funnel+plot_spacer()) / (egger+plot_spacer()) / (lag2+plot_spacer()) +
plot_annotation(tag_levels = "A") +
# Adjust heights: Funnel often needs to be taller or square,
# while regression strips can be shorter. Adjust these numbers as needed.
plot_layout(heights = c(1.2, 1, 1)) &
theme(
plot.tag = element_text(size = 12, face = "bold"),
plot.subtitle = element_text(size = 10, face = "bold")
)
final_dashboard
final_dashboard <- (p_funnel+egger) / (lag2) +
plot_annotation(tag_levels = "A") +
# Adjust heights: Funnel often needs to be taller or square,
# while regression strips can be shorter. Adjust these numbers as needed.
plot_layout(heights = c(1.2, 1, 1)) &
theme(
plot.tag = element_text(size = 12, face = "bold"),
plot.subtitle = element_text(size = 10, face = "bold")
)
final_dashboard
final_dashboard <- (p_funnel+egger + lag2) +
plot_annotation(tag_levels = "A") +
# Adjust heights: Funnel often needs to be taller or square,
# while regression strips can be shorter. Adjust these numbers as needed.
plot_layout(heights = c(1.2, 1, 1)) &
theme(
plot.tag = element_text(size = 12, face = "bold"),
plot.subtitle = element_text(size = 10, face = "bold")
)
final_dashboard
final_dashboard <- p_funnel+egger + lag2 +
plot_annotation(tag_levels = "A") +
# Adjust heights: Funnel often needs to be taller or square,
# while regression strips can be shorter. Adjust these numbers as needed.
plot_layout(heights = c(1.2, 1, 1)) &
theme(
plot.tag = element_text(size = 12, face = "bold"),
plot.subtitle = element_text(size = 10, face = "bold")
)
final_dashboard
library(patchwork)
library(gridGraphics) # Required for capturing Base R plots
# --- Plot 1: Funnel Plot (Wrapped for Patchwork) ---
# We use 'wrap_elements(panel = ~function())' to capture the Base R drawing
p_funnel <- wrap_elements(panel = ~funnel(ma_all,
yaxis = "seinv",
las = 1,
digits = c(2, 1),
xlab = "Standardised residuals (lnRR)",
ylab = "Precision (1/SE)",
pch = 21,
bg = alpha("black", 0.2),
col = "black",
cex = 1.2,
ylim = c(0.01, 40),
xlim = c(-6, 10)
))
final_dashboard <- p_funnel +egger + lag2 +
plot_annotation(tag_levels = "A") +
# Adjust heights: Funnel often needs to be taller or square,
# while regression strips can be shorter. Adjust these numbers as needed.
plot_layout(heights = c(1.2, 1, 1)) &
theme(
plot.tag = element_text(size = 12, face = "bold"),
plot.subtitle = element_text(size = 10, face = "bold")
)
final_dashboard
final_dashboard <- p_funnel +egger + lag2
final_dashboard
final_dashboard <- p_funnel /egger / lag2 +
plot_annotation(tag_levels = "A")  &
theme(
plot.tag = element_text(size = 12, face = "bold"),
plot.subtitle = element_text(size = 10, face = "bold")
)
final_dashboard
final_dashboard <- p_funnel +egger / lag2 +
plot_annotation(tag_levels = "A")  &
theme(
plot.tag = element_text(size = 12, face = "bold"),
plot.subtitle = element_text(size = 10, face = "bold")
)
final_dashboard
final_dashboard <- p_funnel /egger / lag2 +
plot_annotation(tag_levels = "A")  &
theme(
plot.tag = element_text(size = 12, face = "bold"),
plot.subtitle = element_text(size = 10, face = "bold")
)
final_dashboard
final_dashboard <- funnel_plot /egger / lag2 +
plot_annotation(tag_levels = "A")  &
theme(
plot.tag = element_text(size = 12, face = "bold"),
plot.subtitle = element_text(size = 10, face = "bold")
)
library(patchwork)
library(gridGraphics) # Required for capturing Base R plots
p_funnel <- wrap_elements(panel = ~{
# 1. Force smaller margins (Bottom, Left, Top, Right)
# Standard is c(5, 4, 4, 2); we reduce them to fit tight spaces
par(mar = c(4, 5, 1, 1))
# 2. Run the funnel code
funnel(ma_all,
yaxis = "seinv",
las = 1,
digits = c(2, 1),
xlab = "Standardised residuals (lnRR)",
ylab = "Precision (1/SE)",
pch = 21,
bg = alpha("black", 0.2),
col = "black",
cex = 1.2,
ylim = c(0.01, 40),
xlim = c(-6, 10))
})
final_dashboard <- p_funnel /egger / lag2 +
plot_annotation(tag_levels = "A")  &
theme(
plot.tag = element_text(size = 12, face = "bold"),
plot.subtitle = element_text(size = 10, face = "bold")
)
final_dashboard
final_dashboard <- p_funnel +egger / lag2 +
plot_annotation(tag_levels = "A")  &
theme(
plot.tag = element_text(size = 12, face = "bold"),
plot.subtitle = element_text(size = 10, face = "bold")
)
final_dashboard
final_dashboard <- (p_funnel + egger) / lag2 +
plot_annotation(tag_levels = "A") +
# Adjust heights: Give the top row (Funnel/Egger) slightly more space
plot_layout(heights = c(1.2, 1)) &
theme(
plot.tag = element_text(size = 12, face = "bold"),
plot.subtitle = element_text(size = 10, face = "bold")
)
# Print to screen (This should work now!)
final_dashboard
final_dashboard <- (p_funnel) / (egger+ lag2) +
plot_annotation(tag_levels = "A") +
# Adjust heights: Give the top row (Funnel/Egger) slightly more space
plot_layout(heights = c(1.2, 1)) &
theme(
plot.tag = element_text(size = 12, face = "bold"),
plot.subtitle = element_text(size = 10, face = "bold")
)
# Print to screen (This should work now!)
final_dashboard
final_dashboard <- (p_funnel+plot_spacer()) / (egger+ lag2) +
plot_annotation(tag_levels = "A") +
# Adjust heights: Give the top row (Funnel/Egger) slightly more space
plot_layout(heights = c(1.2, 1)) &
theme(
plot.tag = element_text(size = 12, face = "bold"),
plot.subtitle = element_text(size = 10, face = "bold")
)
# Print to screen (This should work now!)
final_dashboard
final_dashboard <- (p_funnel+plot_spacer()) / (egger)/ lag2) +
final_dashboard <- (p_funnel+plot_spacer()) / (egger)/ (lag2) +
plot_annotation(tag_levels = "A") +
# Adjust heights: Give the top row (Funnel/Egger) slightly more space
plot_layout(heights = c(1.2, 1)) &
theme(
plot.tag = element_text(size = 12, face = "bold"),
plot.subtitle = element_text(size = 10, face = "bold")
)
# Print to screen (This should work now!)
final_dashboard
final_dashboard <- (p_funnel+plot_spacer()) / (egger+plot_spacer())/ (lag2+plot_spacer()) +
plot_annotation(tag_levels = "A") +
# Adjust heights: Give the top row (Funnel/Egger) slightly more space
plot_layout(heights = c(1.2, 1)) &
theme(
plot.tag = element_text(size = 12, face = "bold"),
plot.subtitle = element_text(size = 10, face = "bold")
)
# Print to screen (This should work now!)
final_dashboard
final_dashboard <- p_funnel +egger / lag2 +
plot_annotation(tag_levels = "A")  &
theme(
plot.tag = element_text(size = 12, face = "bold"),
plot.subtitle = element_text(size = 10, face = "bold")
)
final_dashboard
#| label: save-figure_behaviour
#| eval: false
ggsave(filename = here("..","Plots", "bias_lnRR.pdf"),
plot = final_dashboard,
dpi = 300, device = cairo_pdf,width = 7,
height = 10)
ggsave(filename = here("..","Plots", "bias_lnRR.jpg"),
plot = final_dashboard,
width = 7,
height = 10,
dpi = 300)
# Define the vertical stack
vertical_stack <- p_funnel / egger / lag2 +
plot_annotation(tag_levels = "A")
# SAVE DIRECTLY - Do not type 'vertical_stack' in the console
pdf(here("..", "Plots", "vertical_stack.pdf"), width = 8, height = 15)
print(vertical_stack)
dev.off()
#| label: eggers_test
# 1. Calculate the effective sample size term (sqrt_inv_e_n)
# Formula: sqrt(2/Ex_n + 2/C_n) approximates the standard error based on N
dt_egger_full <- db %>%
mutate(sqrt_inv_e_n = sqrt((2 / Ex_n) + (2 / C_n)))
# 2. Run the Meta-Regression
# If 'sqrt_inv_e_n' is significant (p < 0.05), we have evidence of small-study effects.
egger_model_full <- rma.mv(yi = lnRR,
V = VCV,
mods = ~ 1 + sqrt_inv_e_n, # The 'Egger' predictor
random = list(~1 | Study_ID, ~1 | ES_ID),
test = "z",
method = "REML",
sparse = TRUE,
data = dt_egger_full)
summary(egger_model_full)
#| label: time_lag_analysis
# 1. Mean-Center the Year (Interpretation: Intercept = Effect in average year)
db_decline <- dt_egger_full %>%
mutate(Year_c = Year - mean(Year, na.rm = TRUE))
# 2. Run model: Controlling for Precision (Egger) AND Year simultaneously
year_lag_model <- rma.mv(yi = lnRR,
V = VCV,
mods = ~ 1 + Year_c + sqrt_inv_e_n,
random = list(~1 | Study_ID, ~1 | ES_ID),
test = "t",
method = "REML",
sparse = TRUE,
data = db_decline)
summary(year_lag_model)
#| label: eggers_test
# 1. Calculate the effective sample size term (sqrt_inv_e_n)
# Formula: sqrt(2/Ex_n + 2/C_n) approximates the standard error based on N
dt_egger_full <- db %>%
mutate(sqrt_inv_e_n = sqrt((2 / Ex_n) + (2 / C_n)))
# 2. Run the Meta-Regression
# If 'sqrt_inv_e_n' is significant (p < 0.05), we have evidence of small-study effects.
egger_model_full <- rma.mv(yi = lnRR,
V = VCV,
mods = ~ 1 + sqrt_inv_e_n, # The 'Egger' predictor
random = list(~1 | Study_ID, ~1 | ES_ID),
test = "t",
method = "REML",
data = dt_egger_full)
summary(egger_model_full)
#| label: egger_bubble_plot
egger<-bubble_plot(egger_model_full,
mod = "sqrt_inv_e_n",
group = "Study_ID",
xlab = "Square root of inverse of effective sample size", ylab="Effect size (lnRR)")
egger
#| label: eggers_test
# 1. Calculate the effective sample size term (sqrt_inv_e_n)
# Formula: sqrt(2/Ex_n + 2/C_n) approximates the standard error based on N
dt_egger_full <- db %>%
mutate(sqrt_inv_e_n = sqrt((2 / Ex_n) + (2 / C_n)))
# 2. Run the Meta-Regression
# If 'sqrt_inv_e_n' is significant (p < 0.05), we have evidence of small-study effects.
egger_model_full <- rma.mv(yi = lnRR,
V = VCV,
mods = ~ 1 + sqrt_inv_e_n, # The 'Egger' predictor
random = list(~1 | Study_ID, ~1|Strain, ~1 | ES_ID),
test = "t",
method = "REML",
data = dt_egger_full)
summary(egger_model_full)
#| label: egger_bubble_plot
egger<-bubble_plot(egger_model_full,
mod = "sqrt_inv_e_n",
group = "Study_ID",
xlab = "Square root of inverse of effective sample size", ylab="Effect size (lnRR)")
egger
#| label: time_lag_analysis
# 1. Mean-Center the Year (Interpretation: Intercept = Effect in average year)
db_decline <- dt_egger_full %>%
mutate(Year_c = Year - mean(Year, na.rm = TRUE))
# 2. Run model: Controlling for Precision (Egger) AND Year simultaneously
year_lag_model <- rma.mv(yi = lnRR,
V = VCV,
mods = ~ 1 + Year_c + sqrt_inv_e_n,
random = list(~1 | Study_ID, ~1|Strain,~1 | ES_ID),
test = "t",
method = "REML",
sparse = TRUE,
data = db_decline)
summary(year_lag_model)
#| label: time_lag_bubble_plot
time_lag<-bubble_plot(year_lag_model,
mod = "Year_c",
group = "Study_ID",
xlab = "Year of publication",ylab="Effect size (lnRR)")
mean_year <- mean(dt_egger_full$Year, na.rm = TRUE)
# Define the years you want to see on the axis
target_years <- seq(2007, 2025, by = 3)
lag2<-time_lag +
scale_x_continuous(
name = "Year of publication",
breaks = target_years - mean_year,
labels = target_years
)
lag2
# Define the vertical stack
vertical_stack <- p_funnel / egger / lag2 +
plot_annotation(tag_levels = "A")
# SAVE DIRECTLY - Do not type 'vertical_stack' in the console
pdf(here("..", "Plots", "vertical_stack.pdf"), width = 8, height = 15)
print(vertical_stack)
dev.off()
# Define the vertical stack
vertical_stack <- p_funnel / egger / lag2 +
plot_annotation(tag_levels = "A")
# SAVE DIRECTLY - Do not type 'vertical_stack' in the console
pdf(here("..", "Plots", "vertical_stack.pdf"), width = 8, height = 10)
print(vertical_stack)
dev.off()
# Define the vertical stack
vertical_stack <- p_funnel / egger / lag2 +
plot_annotation(tag_levels = "A")
# SAVE DIRECTLY - Do not type 'vertical_stack' in the console
pdf(here("..", "Plots", "vertical_stack.pdf"), width = 6, height = 8)
print(vertical_stack)
dev.off()
library(dplyr)
library(here)
db <- readr::read_csv(here("..","data","db251124.csv"))
# 1. Define the columns you want to analyze
reporting_columns <- c(
"Stimulus_reporting",
"Control_stimulus_reporting",
"Timing_reporting",
"ROB_guideline",
"ROB_guideline_name",
"ROB_blinding",
"ROB_randomization",
"ROB_attrition",
"ROB_selective_reporting"
)
# 2. Calculate the proportions
# This checks if the value is 1, "1", or "Yes" (case-insensitive)
reporting_stats <- db %>%
summarise(
across(
all_of(reporting_columns),
~ mean(as.character(.x) %in% c("1", "Yes", "yes", "YES"), na.rm = TRUE)
)
) %>%
# Optional: Pivot to make it easier to read (long format)
tidyr::pivot_longer(everything(), names_to = "Variable", values_to = "Proportion") %>%
mutate(Percentage = scales::percent(Proportion, accuracy = 0.1))
# 3. View the results
print(reporting_stats)
library(dplyr)
library(here)
db <- readr::read_csv(here("..","data","db251124.csv"))
# 1. Define the columns to check
reporting_cols <- c("Stimulus_reporting", "Control_stimulus_reporting", "Timing_reporting",
"ROB_guideline", "ROB_guideline_name", "ROB_blinding",
"ROB_randomization", "ROB_attrition", "ROB_selective_reporting")
# 2. Calculate reporting per study
study_level_stats <- db251124 %>%
group_by(Study_ID) %>%
summarise(
across(
all_of(reporting_cols),
# Returns 1 if ANY row for this study contains "1" or "Yes", otherwise 0
~ if_else(any(as.character(.x) %in% c("1", "Yes", "yes", "YES"), na.rm = TRUE), 1, 0)
)
)
library(dplyr)
library(here)
db <- readr::read_csv(here("..","data","db251124.csv"))
# 1. Define the columns to check
reporting_cols <- c("Stimulus_reporting", "Control_stimulus_reporting", "Timing_reporting",
"ROB_guideline", "ROB_guideline_name", "ROB_blinding",
"ROB_randomization", "ROB_attrition", "ROB_selective_reporting")
# 2. Calculate reporting per study
study_level_stats <- db %>%
group_by(Study_ID) %>%
summarise(
across(
all_of(reporting_cols),
# Returns 1 if ANY row for this study contains "1" or "Yes", otherwise 0
~ if_else(any(as.character(.x) %in% c("1", "Yes", "yes", "YES"), na.rm = TRUE), 1, 0)
)
)
# 3. Calculate the final proportion across unique studies
final_proportions <- study_level_stats %>%
summarise(across(all_of(reporting_cols), mean)) %>%
tidyr::pivot_longer(everything(), names_to = "Variable", values_to = "Proportion") %>%
mutate(Percentage = scales::percent(Proportion, accuracy = 0.1))
print(final_proportions)
exp(-0.317)
exp(-0.187)
