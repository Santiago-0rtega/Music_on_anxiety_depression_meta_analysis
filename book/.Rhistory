data = db)
summary(mIB)
#| label: setup_and_collinearity
#| message: false
#| warning: false
# Load libraries and data
pacman::p_load(DT, dtplyr, here, knitr, tidyverse, patchwork, metafor, orchaRd, GoodmanKruskal)
db <- readr::read_csv(here("data","db_lnRR.csv")) %>%
mutate(across(c(C_n, Ex_n, C_mean, Ex_mean, C_SE, Ex_SE, C_SD, Ex_SD), as.numeric)) %>%
mutate(across(where(is.character), as.factor))
#| label: setup_and_collinearity
#| message: false
#| warning: false
# Load libraries and data
pacman::p_load(DT, dtplyr, here, knitr, tidyverse, patchwork, metafor, orchaRd, GoodmanKruskal)
db <- readr::read_csv(here("..","data","db_lnRR.csv")) %>%
mutate(across(c(C_n, Ex_n, C_mean, Ex_mean, C_SE, Ex_SE, C_SD, Ex_SD), as.numeric)) %>%
mutate(across(where(is.character), as.factor))
# Define the list of moderators we want to test
moderators_to_check <- c(
"Outcome_type", "Lifestage_exposure", "Sex", "Meta_genre",
"Music_exposure_duration", "Experimental_design", "Induced behaviour",
"Relative_timing", "Experimental_procedures", "Control_conditions", "Assay_type"
)
# Subset data to just these columns
dat_mods <- db %>% dplyr::select(all_of(moderators_to_check))
# Calculate categorical association (GK Tau)
corr_cat <- GKtauDataframe(dat_mods)
# Plot the association heatmap
plot(corr_cat)
#| label: sequential_filtering
#| fold: true
# 1. Calculate the initial Variance-Covariance Matrix
VCV <- metafor::vcalc(
vi = lnRR_var,
cluster = Cohort_ID,
obs = ES_ID,
rho = 0.5,
data = db
)
# Moderators to include in the final model
moderators <- c("Lifestage_exposure", "Sex", "Meta_genre",
"Music_exposure_duration", "Experimental_design",
"Induced behaviour", "Relative_timing", "Experimental_procedures",
"Control_conditions", "Assay_type")
# Initialize filtered dataset
db_final <- db
# --- Strict Sequential Filtering Loop ---
for (mod in moderators) {
mod_sym <- sym(mod)
# Count k per level in the CURRENTLY filtered dataframe
k_counts <- db_final %>%
group_by(!!mod_sym) %>%
summarise(k_es = n(), .groups = 'drop')
# Keep levels with sufficient data (k >= 5)
levels_to_keep_mod <- k_counts %>%
filter(k_es >= 5) %>%
pull(!!mod_sym)
# Update the dataframe
db_final <- db_final %>%
filter(!!mod_sym %in% levels_to_keep_mod)
}
# --- Final Cleanup ---
# Drop unused factor levels
db_final <- db_final %>% mutate(across(all_of(moderators), droplevels))
# Match the VCV matrix to the new data indices
indices_to_keep <- which(db$ES_ID %in% db_final$ES_ID)
VCV_final <- VCV[indices_to_keep, indices_to_keep]
print(paste("Final dataset size:", nrow(db_final), "ES_IDs"))
#| label: model_full
mMULTI <- rma.mv(yi = lnRR, V = VCV_final,
mods = ~ Lifestage_exposure + Assay_type + `Induced behaviour` +
Sex + Meta_genre + Music_exposure_duration +
Experimental_design + Relative_timing +
Experimental_procedures + Control_conditions,
random = list(~1 | Study_ID, ~1 | ES_ID, ~1 | Strain),
test = "t", method = "REML", sparse = TRUE, data = db_final)
summary(mMULTI)
round(r2_ml(mMULTI), 4)
#| label: model_minus_sex
#| code-fold: true
#| code-summary: "Test: Removing Sex"
# Removed: Sex
mMULTI <- rma.mv(yi = lnRR, V = VCV_final,
mods = ~ Lifestage_exposure +
Assay_type +
`Induced behaviour` +
# Sex +  <-- REMOVED
Meta_genre +
Music_exposure_duration +
Experimental_design +
Relative_timing +
Experimental_procedures +
Control_conditions,
random = list(~1 | Study_ID, ~1 | ES_ID, ~1 | Strain),
test = "t", method = "REML", sparse = TRUE, data = db_final)
round(r2_ml(mMULTI), 4)
#| label: model_minus_genre
#| code-fold: true
#| code-summary: "Test: Removing Meta_genre"
# Removed:  Meta_genre
mMULTI <- rma.mv(yi = lnRR, V = VCV_final,
mods = ~ Lifestage_exposure +
Assay_type +
`Induced behaviour` +
Sex +
# Meta_genre + <-- REMOVED
Music_exposure_duration +
Experimental_design +
Relative_timing +
Experimental_procedures +
Control_conditions,
random = list(~1 | Study_ID, ~1 | ES_ID, ~1 | Strain),
test = "t", method = "REML", sparse = TRUE, data = db_final)
round(r2_ml(mMULTI), 4)
#| label: model_minus_duration
#| code-fold: true
#| code-summary: "Test: Removing Music Duration"
# Removed: Music_exposure_duration
mMULTI <- rma.mv(yi = lnRR, V = VCV_final,
mods = ~ Lifestage_exposure +
Assay_type +
`Induced behaviour` +
Sex +
Meta_genre +
# Music_exposure_duration + <-- REMOVED
Experimental_design +
Relative_timing +
Experimental_procedures +
Control_conditions,
random = list(~1 | Study_ID, ~1 | ES_ID, ~1 | Strain),
test = "t", method = "REML", sparse = TRUE, data = db_final)
round(r2_ml(mMULTI), 4)
#| label: model_minus_Experimental_design
#| code-fold: true
#| code-summary: "Test: Removing Experimental_design"
# Removed: Experimental_design
mMULTI <- rma.mv(yi = lnRR, V = VCV_final,
mods = ~ Lifestage_exposure +
Assay_type +
`Induced behaviour` +
Sex +
Meta_genre +
Music_exposure_duration +
#Experimental_design + <-- REMOVED
Relative_timing +
Experimental_procedures +
Control_conditions,
random = list(~1 | Study_ID, ~1 | ES_ID, ~1 | Strain),
test = "t", method = "REML", sparse = TRUE, data = db_final)
round(r2_ml(mMULTI), 4)
#| label: model_minus_Experimental_relative_timing
#| code-fold: true
#| code-summary: "Test: Removing relative_timing"
# Removed: relative_timing
mMULTI <- rma.mv(yi = lnRR, V = VCV_final,
mods = ~ Lifestage_exposure +
Assay_type +
`Induced behaviour` +
Sex +
Meta_genre +
Music_exposure_duration +
Experimental_design +
#Relative_timing + <-- REMOVED
Experimental_procedures +
Control_conditions,
random = list(~1 | Study_ID, ~1 | ES_ID, ~1 | Strain),
test = "t", method = "REML", sparse = TRUE, data = db_final)
round(r2_ml(mMULTI), 4)
#| label: model_minus_Experimental_procedures
#| code-fold: true
#| code-summary: "Test: Removing Experimental_procedures"
# Removed: Experimental_procedures
mMULTI <- rma.mv(yi = lnRR, V = VCV_final,
mods = ~ Lifestage_exposure +
Assay_type +
`Induced behaviour` +
Sex +
Meta_genre +
Music_exposure_duration +
Experimental_design +
Relative_timing +
#Experimental_procedures + <-- REMOVED
Control_conditions,
random = list(~1 | Study_ID, ~1 | ES_ID, ~1 | Strain),
test = "t", method = "REML", sparse = TRUE, data = db_final)
round(r2_ml(mMULTI), 4)
#| label: model_minus_control_conditions
#| code-fold: true
#| code-summary: "Test: Removing control_conditions"
# Removed: control_conditions
mMULTI <- rma.mv(yi = lnRR, V = VCV_final,
mods = ~ Lifestage_exposure +
Assay_type +
`Induced behaviour` +
Sex +
Meta_genre +
Music_exposure_duration +
Experimental_design +
Relative_timing +
Experimental_procedures +
#Control_conditions<-- REMOVED
,
#| label: model_minus_control_conditions
#| code-fold: true
#| code-summary: "Test: Removing control_conditions"
# Removed: control_conditions
mMULTI <- rma.mv(yi = lnRR, V = VCV_final,
mods = ~ Lifestage_exposure +
Assay_type +
`Induced behaviour` +
Sex +
Meta_genre +
Music_exposure_duration +
Experimental_design +
Relative_timing +
Experimental_procedures,
#Control_conditions<-- REMOVED,
random = list(~1 | Study_ID, ~1 | ES_ID, ~1 | Strain),
test = "t", method = "REML", sparse = TRUE, data = db_final)
round(r2_ml(mMULTI), 4)
round(r2_ml(mMULTI), 4)
round(r2_ml(mMULTI), 4)
#| label: round2_baseline
# BASELINE ROUND 2: Everything EXCEPT Music_exposure_duration
mMULTI_R2 <- rma.mv(yi = lnRR, V = VCV_final,
mods = ~ Lifestage_exposure +
Assay_type +
`Induced behaviour` +
Sex + Meta_genre +
# Music_exposure_duration +  <-- CONFIRMED REMOVED
Experimental_design +
Relative_timing +
Experimental_procedures +
Control_conditions,
random = list(~1 | Study_ID, ~1 | ES_ID, ~1 | Strain),
test = "t", method = "REML", sparse = TRUE, data = db_final)
print("--- Baseline Round 2 Stats ---")
round(r2_ml(mMULTI_R2), 4)
AIC(mMULTI_R2)
print("--- Baseline Round 2 Stats ---")
round(r2_ml(mMULTI_R2), 4)
#| label: test_remove_sex
model_no_sex <- rma.mv(yi = lnRR, V = VCV_final,
mods = ~ Lifestage_exposure + Assay_type + `Induced behaviour` +
# Sex +  <-- REMOVING THIS
Meta_genre +
Experimental_design + Relative_timing +
Experimental_procedures + Control_conditions,
random = list(~1 | Study_ID, ~1 | ES_ID, ~1 | Strain),
test = "t", method = "REML", sparse = TRUE, data = db_final)
# Compare to Baseline Round 2
round(r2_ml(model_no_sex), 4)
#| label: test_remove_genre
model_no_genre <- rma.mv(yi = lnRR, V = VCV_final,
mods = ~ Lifestage_exposure + Assay_type + `Induced behaviour` +
Sex +
# Meta_genre + <-- REMOVING THIS
Experimental_design + Relative_timing +
Experimental_procedures + Control_conditions,
random = list(~1 | Study_ID, ~1 | ES_ID, ~1 | Strain),
test = "t", method = "REML", sparse = TRUE, data = db_final)
round(r2_ml(model_no_genre), 4)
#| label: test_remove_design
model_no_design <- rma.mv(yi = lnRR, V = VCV_final,
mods = ~ Lifestage_exposure + Assay_type + `Induced behaviour` +
Sex + Meta_genre +
# Experimental_design + <-- REMOVING THIS
Relative_timing +
Experimental_procedures + Control_conditions,
random = list(~1 | Study_ID, ~1 | ES_ID, ~1 | Strain),
test = "t", method = "REML", sparse = TRUE, data = db_final)
round(r2_ml(model_no_design), 4)
AIC(model_no_design)
round(r2_ml(model_no_design), 4)
#| label: test_remove_timing
model_no_timing <- rma.mv(yi = lnRR, V = VCV_final,
mods = ~ Lifestage_exposure + Assay_type + `Induced behaviour` +
Sex + Meta_genre +
Experimental_design +
# Relative_timing + <-- REMOVING THIS
Experimental_procedures + Control_conditions,
random = list(~1 | Study_ID, ~1 | ES_ID, ~1 | Strain),
test = "t", method = "REML", sparse = TRUE, data = db_final)
round(r2_ml(model_no_timing), 4)
#| label: test_remove_control
model_no_control <- rma.mv(yi = lnRR, V = VCV_final,
mods = ~ Lifestage_exposure + Assay_type + `Induced behaviour` +
Sex + Meta_genre +
Experimental_design + Relative_timing +
Experimental_procedures,
# Control_conditions + <-- REMOVING THIS
random = list(~1 | Study_ID, ~1 | ES_ID, ~1 | Strain),
test = "t", method = "REML", sparse = TRUE, data = db_final)
round(r2_ml(model_no_control), 4)
AIC(model_no_control)
#| label: test_remove_control
model_no_control <- rma.mv(yi = lnRR, V = VCV_final,
mods = ~ Lifestage_exposure + Assay_type + `Induced behaviour` +
Sex + Meta_genre +
Experimental_design + Relative_timing +
Experimental_procedures,
# Control_conditions + <-- REMOVING THIS
random = list(~1 | Study_ID, ~1 | ES_ID, ~1 | Strain),
test = "t", method = "REML", sparse = TRUE, data = db_final)
round(r2_ml(model_no_control), 4)
#| label: best_model_minus_duration
#| code-fold: true
#| code-summary: "Test: Removing Music Duration"
# Removed: Music_exposure_duration
mMULTI <- rma.mv(yi = lnRR, V = VCV_final,
mods = ~ Lifestage_exposure +
Assay_type +
`Induced behaviour` +
Sex +
Meta_genre +
# Music_exposure_duration + <-- REMOVED
Experimental_design +
Relative_timing +
Experimental_procedures +
Control_conditions,
random = list(~1 | Study_ID, ~1 | ES_ID, ~1 | Strain),
test = "t", method = "REML", sparse = TRUE, data = db_final)
round(r2_ml(mMULTI), 4)
suummary(mMULTI)
summary(mMULTI)
#| label: coef_plot
#| fig-height: 10
# forest() on the model object plots the coefficients
metafor::forest(mMULTI,
header = TRUE,
top = 2,
digits = 2,
cex = 0.8,
main = "Multi-Moderator Model Coefficients")
#| label: plot_results
#| fig-height: 8
#| fig-width: 8
#| warning: false
library(orchaRd)
library(patchwork) # Ensure patchwork is loaded for combining plots
# Example 1: Visualize 'Assay_type' (controlling for all other factors)
p1 <- orchard_plot(mMULTI,
mod = "Assay_type",
group = "Study_ID",
xlab = "Log Response Ratio (lnRR)",
display = "means",    # "means" shows the estimated group mean
trunk.size = 2) +
ggtitle("Adjusted Effect by Assay Type") +
theme(legend.position = "none") # Hide legend if redundant
#| label: plot_results
#| fig-height: 8
#| fig-width: 8
#| warning: false
library(orchaRd)
library(patchwork) # Ensure patchwork is loaded for combining plots
# Example 1: Visualize 'Assay_type' (controlling for all other factors)
p1 <- orchard_plot(mMULTI,
mod = "Assay_type",
group = "Study_ID",
xlab = "Log Response Ratio (lnRR)",
trunk.size = 2) +
ggtitle("Adjusted Effect by Assay Type") +
theme(legend.position = "none") # Hide legend if redundant
#| label: setup
#| include: false
pacman::p_load(
DT,
dtplyr,
here,
knitr,
tidyverse,
patchwork,
metafor,
orchaRd, emmeans
)
#| label: load_and_clean_data
db <- readr::read_csv(here("data","db_lnRR.csv")) %>%
mutate(across(c(C_n, Ex_n, C_mean, Ex_mean, C_SE, Ex_SE, C_SD, Ex_SD), as.numeric))%>%
mutate(across(where(is.character), as.factor))
#| label: setup
#| include: false
pacman::p_load(
DT,
dtplyr,
here,
knitr,
tidyverse,
patchwork,
metafor,
orchaRd, emmeans
)
#| label: load_and_clean_data
db <- readr::read_csv(here("..","data","db_lnRR.csv")) %>%
mutate(across(c(C_n, Ex_n, C_mean, Ex_mean, C_SE, Ex_SE, C_SD, Ex_SD), as.numeric))%>%
mutate(across(where(is.character), as.factor))
VCV <- metafor::vcalc(
vi = lnRR_var,
cluster = Cohort_ID, # The clustering variable (Study_ID + Ex_ID)
obs = ES_ID,         # The unique observation/effect size ID
rho = 0.5,           # Assumed correlation between outcomes from the same cohort
data = db
)
ma_all <- rma.mv(yi = lnRR,
V = VCV,
random = list(~1 | Study_ID,
~1 | ES_ID,
~1 | Strain),
test = "t",
method = "REML",
sparse = TRUE,
data = db)
summary(ma_all)
summary(ma_all)
#| label: setup
#|
pacman::p_load(
DT,
dtplyr,
here,
knitr,
tidyverse,
patchwork,
metafor,
orchaRd, emmeans
)
db <- readr::read_csv(here("..","data","db_lnRR.csv")) %>%
mutate(across(c(C_n, Ex_n, C_mean, Ex_mean, C_SE, Ex_SE, C_SD, Ex_SD), as.numeric))%>%
mutate(across(where(is.character), as.factor))
VCV <- metafor::vcalc(
vi = lnRR_var,
cluster = Cohort_ID, # The clustering variable (Study_ID + Ex_ID)
obs = ES_ID,         # The unique observation/effect size ID
rho = 0.5,           # Assumed correlation between outcomes from the same cohort
data = db
)
ma_all <- rma.mv(yi = lnRR,
V = VCV,
random = list(~1 | Study_ID,
~1 | ES_ID,
~1 | Strain),
test = "t",
method = "REML",
sparse = TRUE,
data = db)
summary(ma_all)
# funnel plot - standard error
funnel(ma_all, yaxis = "sei",
xlab = "Standarised residuals",
ylab = "Precision (inverse of SE)" )
# funnel plot - inverse of standard error
funnel(ma_all, yaxis = "seinv",
xlab = "Standarised residuals",
ylab = "Precision (inverse of SE)",  col = c(alpha("orange", 0.5)))
#| label: eggers_test
# 1. Calculate the effective sample size term (sqrt_inv_e_n)
# Formula: sqrt(2/Ex_n + 2/C_n) approximates the standard error based on N
dt_egger_full <- db %>%
mutate(sqrt_inv_e_n = sqrt((2 / Ex_n) + (2 / C_n)))
# 2. Run the Meta-Regression
# If 'sqrt_inv_e_n' is significant (p < 0.05), we have evidence of small-study effects.
egger_model_full <- rma.mv(yi = lnRR,
V = VCV,
mods = ~ 1 + sqrt_inv_e_n, # The 'Egger' predictor
random = list(~1 | Study_ID, ~1 | ES_ID),
test = "z",
method = "REML",
sparse = TRUE,
data = dt_egger_full)
summary(egger_model_full)
bubble_plot(egger_model_full,
mod = "sqrt_inv_e_n",
group = "Study_ID",
xlab = "Square root of inverse of effective sample size")
#| label: time_lag_analysis
# 1. Mean-Center the Year (Interpretation: Intercept = Effect in average year)
db_decline <- dt_egger_full %>%
mutate(Year_c = Year - mean(Year, na.rm = TRUE))
# 2. Run model: Controlling for Precision (Egger) AND Year simultaneously
year_lag_model <- rma.mv(yi = lnRR,
V = VCV,
mods = ~ 1 + Year_c + sqrt_inv_e_n,
random = list(~1 | Study_ID, ~1 | ES_ID),
test = "t",
method = "REML",
sparse = TRUE,
data = db_decline)
summary(year_lag_model)
#| label: time_lag_bubble_plot
bubble_plot(year_lag_model,
mod = "Year_c",
group = "Study_ID",
xlab = "Year of publication")
#| label: quality_analysis
# 1. Center the Quality Score
db_decline <- db_decline %>%
mutate(quality_c = Reporting_quality - mean(Reporting_quality, na.rm = TRUE))
# 2. Run the comprehensive bias model
# Controls for: Precision (Egger), Time (Year), and Quality all at once.
reporting_model <- rma.mv(yi = lnRR,
V = VCV,
mods = ~ 1 + quality_c + sqrt_inv_e_n + Year_c,
random = list(~1 | Study_ID, ~1 | ES_ID),
test = "t",
method = "REML",
sparse = TRUE,
data = db_decline)
summary(reporting_model)
bubble_plot(reporting_model,
mod = "quality_c",
group = "Study_ID",
xlab = "Reporting quality")
