V = VCV,
random = list(~1 | Study_ID,
~1 | ES_ID,
~1 | Strain),
test = "t",
method = "REML",
sparse = TRUE,
data = db )
overall_lnRR<-orchard_plot(ma_all,
group = "Study_ID",
xlab = "lnRR",
flip=T,trunk.size = 0.3,
branch.size = 2,alpha = 0.3) +
scale_x_discrete(labels = c("Overall effect")) +
scale_colour_brewer(palette = "Paired") +
scale_fill_brewer(palette = "Dark2")+
scale_y_continuous(breaks = seq(-4, 2, by = 1),
minor_breaks = seq(-4, 2, by = 0.5 ))
overall_lnRR
#| label: filter_assay_type
f <- filter_low_k(db, VCV,Assay_type, min_k = 5)
db_filtered <- f$data
VCV_filtered <- f$V
mAT <- rma.mv(yi = lnRR,
V = VCV_filtered,
mods = ~ Assay_type-1,
random = list(~1 | Study_ID,
~1 | ES_ID,
~1 | Strain),
test = "t",
method = "REML",
sparse = TRUE,
data = db_filtered)
assay_labels <- c(
"Elevated Plus Maze" = "EPM",
"Open Field Test" = "OFT",
"Light-Dark Box" = "LDB",
"Forced Swim Test (FST)" = "FST",
"Tail Suspension Test (TST)" = "TST",
"Sucrose Preference Test (SPT)" = "SPT"
)
orchard_assay <- orchard_plot(
mAT,legend.pos = "top.left",
mod   = "Assay_type",
group = "Study_ID",
xlab  = expression(lnRR),trunk.size = 0.3,
branch.size = 2, alpha = 0.3
) +
scale_colour_brewer(palette = "Set1") +
scale_fill_brewer(palette = "Dark2") +
scale_x_discrete(labels = assay_labels) +scale_y_continuous(limits = c(-4,2),breaks = seq(-4, 2, by = 1),
minor_breaks = seq(-4, 2, by = 0.5 ))+
labs(
x = NULL,
y = expression(lnRR),
subtitle = "Behavioural assay"
) +
theme(
plot.subtitle = element_text(size = 10, face = "bold"),
axis.title.y = element_text(face = "bold"),legend.direction = "vertical"
)
orchard_assay
#| label: model_lifestage_exp
mLE <- rma.mv(yi = lnRR,
V = VCV,
mods = ~ Lifestage_exposure-1,
random = list(~1 | Study_ID,
~1 | ES_ID,
~1 | Strain),
test = "t",
method = "REML",
sparse = TRUE,
data = db)
lifestage_labels <- c(
"Adolescent"  = "Adol.",
"Adult"       = "Adult",
"Juvenile"    = "Juv.",
"Young adult" = "Y. adult",
"Mixed"       = "Mixed",
"Unclear"     = "Unclear"
)
orchard_lifestage<-orchard_plot(mLE,legend.pos = "top.left",
mod = "Lifestage_exposure",
group = "Study_ID",
xlab = expression(lnRR),trunk.size = 0.3,
branch.size = 2,alpha=0.3 ,
flip = T) +
scale_x_discrete(labels = lifestage_labels)+
scale_colour_brewer(palette = "Set1") +
scale_fill_brewer(palette = "Dark2")+scale_x_discrete(labels = assay_labels) +scale_y_continuous(limits = c(-4,2),breaks = seq(-4, 2, by = 1),
minor_breaks = seq(-4, 2, by = 0.5 ))+  theme(legend.direction = "vertical")
orchard_lifestage
#| label: model_control_condition
mCC <- rma.mv(yi = lnRR,
V = VCV,
mods = ~ Control_conditions,
random = list(~1 | Study_ID,
~1 | ES_ID,
~1 | Strain),
test = "t",
method = "REML",
sparse = TRUE,
data = db)
control_labels <- c(
"ambiet sound" = "Ambient sound",
"Ambient noise" = "Ambient noise",
"Ambiet sound" = "Ambient sound",
"White noise"   = "White noise"
)
orchard_control<-orchard_plot(mCC,
mod = "Control_conditions",legend.pos = "top.left",
group = "Study_ID",
xlab = expression(lnRR),trunk.size = 0.3,
branch.size = 2,alpha=0.3) +
scale_x_discrete(labels = control_labels) +
scale_colour_brewer(palette = "Set1") +
scale_fill_brewer(palette = "Dark2")+scale_x_discrete(labels = assay_labels) +scale_y_continuous(limits = c(-4,2),breaks = seq(-4, 2, by = 1),
minor_breaks = seq(-4, 2, by = 0.5 ))+  theme(legend.direction = "vertical")
orchard_control
#| label: model_control_condition
mCC <- rma.mv(yi = lnRR,
V = VCV,
mods = ~ Control_conditions,
random = list(~1 | Study_ID,
~1 | ES_ID,
~1 | Strain),
test = "t",
method = "REML",
sparse = TRUE,
data = db)
control_labels <- c(
"Ambiet sound" = "Ambient sound",
"White noise"   = "White noise"
)
orchard_control<-orchard_plot(mCC,
mod = "Control_conditions",legend.pos = "top.left",
group = "Study_ID",
xlab = expression(lnRR),trunk.size = 0.3,
branch.size = 2,alpha=0.3) +
scale_x_discrete(labels = control_labels) +
scale_colour_brewer(palette = "Set1") +
scale_fill_brewer(palette = "Dark2")+scale_x_discrete(labels = assay_labels) +scale_y_continuous(limits = c(-4,2),breaks = seq(-4, 2, by = 1),
minor_breaks = seq(-4, 2, by = 0.5 ))+  theme(legend.direction = "vertical")
orchard_control
View(db)
#| label: model_control_condition
mCC <- rma.mv(yi = lnRR,
V = VCV,
mods = ~ Control_conditions,
random = list(~1 | Study_ID,
~1 | ES_ID,
~1 | Strain),
test = "t",
method = "REML",
sparse = TRUE,
data = db)
control_labels <- c(
"ambiet sound" = "Ambient sound",
"White noise"   = "White noise"
)
orchard_control<-orchard_plot(mCC,
mod = "Control_conditions",legend.pos = "top.left",
group = "Study_ID",
xlab = expression(lnRR),trunk.size = 0.3,
branch.size = 2,alpha=0.3) +
scale_x_discrete(labels = control_labels) +
scale_colour_brewer(palette = "Set1") +
scale_fill_brewer(palette = "Dark2")+scale_x_discrete(labels = assay_labels) +scale_y_continuous(limits = c(-4,2),breaks = seq(-4, 2, by = 1),
minor_breaks = seq(-4, 2, by = 0.5 ))+  theme(legend.direction = "vertical")
orchard_control
#| label: model_control_condition
mCC <- rma.mv(yi = lnRR,
V = VCV,
mods = ~ Control_conditions,
random = list(~1 | Study_ID,
~1 | ES_ID,
~1 | Strain),
test = "t",
method = "REML",
sparse = TRUE,
data = db)
control_labels <- c(
"Ambiet sound" = "Ambient sound",
"ambiet sound" = "Ambient sound",
"White noise"   = "White noise"
)
orchard_control<-orchard_plot(mCC,
mod = "Control_conditions",legend.pos = "top.left",
group = "Study_ID",
xlab = expression(lnRR),trunk.size = 0.3,
branch.size = 2,alpha=0.3) +
scale_x_discrete(labels = control_labels) +
scale_colour_brewer(palette = "Set1") +
scale_fill_brewer(palette = "Dark2")+scale_x_discrete(labels = assay_labels) +scale_y_continuous(limits = c(-4,2),breaks = seq(-4, 2, by = 1),
minor_breaks = seq(-4, 2, by = 0.5 ))+  theme(legend.direction = "vertical")
orchard_control
unique(db$Control_conditions)
#| label: model_control_condition
mCC <- rma.mv(yi = lnRR,
V = VCV,
mods = ~ Control_conditions,
random = list(~1 | Study_ID,
~1 | ES_ID,
~1 | Strain),
test = "t",
method = "REML",
sparse = TRUE,
data = db)
control_labels <- c(
"ambiet sound" = "Ambient sound",
"white noise"  = "White noise"
)
orchard_control<-orchard_plot(mCC,
mod = "Control_conditions",legend.pos = "top.left",
group = "Study_ID",
xlab = expression(lnRR),trunk.size = 0.3,
branch.size = 2,alpha=0.3) +
scale_x_discrete(labels = control_labels) +
scale_colour_brewer(palette = "Set1") +
scale_fill_brewer(palette = "Dark2")+scale_x_discrete(labels = assay_labels) +scale_y_continuous(limits = c(-4,2),breaks = seq(-4, 2, by = 1),
minor_breaks = seq(-4, 2, by = 0.5 ))+  theme(legend.direction = "vertical")
orchard_control
#| label: setup
#| include: false
pacman::p_load(
DT,
dtplyr,
here,
knitr,
tidyverse,
patchwork,
metafor,
orchaRd, multcomp
)
db <- readr::read_csv(here("..","data","db_effect_sizes.csv")) %>%
mutate(across(c(C_n, Ex_n, C_mean, Ex_mean, C_SE, Ex_SE, C_SD, Ex_SD, lnRR, lnRR_var), as.numeric))%>%
mutate(across(where(is.character), as.factor)) %>%
mutate(
Control_conditions = as.character(Control_conditions),
Control_conditions = dplyr::recode(
Control_conditions,
"ambiet sound" = "Ambient sound",
"white noise"  = "White noise"
),
Control_conditions = factor(Control_conditions)
)
VCV <- metafor::vcalc(
vi = lnRR_var,
cluster = Cohort_ID, # The clustering variable (Study_ID + Ex_ID)
obs = ES_ID,         # The unique observation/effect size ID
rho = 0.5,           # Assumed correlation between outcomes from the same cohort
data = db
)
#| label: model_control_condition
mCC <- rma.mv(yi = lnRR,
V = VCV,
mods = ~ Control_conditions,
random = list(~1 | Study_ID,
~1 | ES_ID,
~1 | Strain),
test = "t",
method = "REML",
sparse = TRUE,
data = db)
control_labels <- c(
"ambiet sound" = "Ambient sound",
"white noise"  = "White noise"
)
orchard_control<-orchard_plot(mCC,
mod = "Control_conditions",legend.pos = "top.left",
group = "Study_ID",
xlab = expression(lnRR),trunk.size = 0.3,
branch.size = 2,alpha=0.3) +
scale_x_discrete(labels = control_labels) +
scale_colour_brewer(palette = "Set1") +
scale_fill_brewer(palette = "Dark2")+scale_x_discrete(labels = assay_labels) +scale_y_continuous(limits = c(-4,2),breaks = seq(-4, 2, by = 1),
minor_breaks = seq(-4, 2, by = 0.5 ))+  theme(legend.direction = "vertical")
orchard_control
#| label: model_induced_behaviour
mIB <- rma.mv(yi = lnRR,
V = VCV,
mods = ~ `Induced behaviour`,
random = list(~1 | Study_ID,
~1 | ES_ID,
~1 | Strain),
test = "t",
method = "REML",
sparse = TRUE,
data = db)
orchard_behaviour<-orchard_plot(mIB,
mod = "Induced behaviour",legend.pos = "top.left",
group = "Study_ID",
xlab = expression(lnRR), trunk.size = 0.3,
branch.size = 2,alpha=0.3,
flip = T)+
scale_colour_brewer(palette = "Set1") +
scale_fill_brewer(palette = "Dark2")+scale_y_continuous(limits = c(-4,2),breaks = seq(-4, 2, by = 1),
minor_breaks = seq(-4, 2, by = 0.5 ))+  theme(legend.direction = "vertical")
orchard_behaviour
#| label: patched_figure
#| fold: TRUE
orchard_assay     <- orchard_assay     + labs(subtitle = "Behavioral assay")
orchard_lifestage <- orchard_lifestage + labs(subtitle = "Age at exposure")
orchard_control   <- orchard_control   + labs(subtitle = "Control condition")
orchard_behaviour <- orchard_behaviour + labs(subtitle = "Behavioral mechanism")
# 2) Hide legends on all but ONE panel (choose bottom-right here)
orchard_assay     <- orchard_assay     + theme(legend.position = "none")
orchard_lifestage <- orchard_lifestage + theme(legend.position = "none")
orchard_control   <- orchard_control   + theme(legend.position = "none")
# orchard_behaviour keeps the legend
# 3) Patch with your layout
patched_figure <- (orchard_assay + orchard_lifestage  ) /
(orchard_control   + orchard_behaviour) +
plot_annotation(tag_levels = "A") &
theme(
plot.tag = element_text(size = 12, face = "bold"),
plot.subtitle = element_text(size = 10, face = "bold")
)
# 4) Enforce identical lnRR scale and a single y-axis label across ALL panels
patched_figure <- patched_figure &
scale_y_continuous(
limits = c(-4, 2),
breaks = seq(-4, 2, by = 1),
minor_breaks = seq(-4, 2, by = 0.5)
) &
labs(y = expression(lnRR), x = NULL)
patched_figure
#| label: save-figure_behaviour
#| eval: false
#| fold: TRUE
ggsave(filename = here("..","Plots", "patched_lnRR.pdf"),
plot = patched_figure,
dpi = 300, device = cairo_pdf,width = 10,
height = 10)
ggsave(filename = here("..","Plots", "patched_lnRR.jpg"),
plot = patched_figure,
width = 10,
height = 10,
dpi = 300)
#| label: setup
#| include: true
pacman::p_load(
DT,
dtplyr,
here,
knitr,
tidyverse,
patchwork,
metafor,
orchaRd, ggalluvial, patchwork
)
ggsave(filename = here("..","Plots", "alluvial.pdf"),
plot = plot1,
dpi = 300, device = cairo_pdf, width = 12,
height = 15)
#| label: setup
#| include: true
pacman::p_load(
DT,
dtplyr,
here,
knitr,
tidyverse,
patchwork,
metafor,
orchaRd, ggalluvial, patchwork
)
db <- readr::read_csv(here(
"..","data","db_effect_sizes.csv")) %>%
mutate(across(c(C_n, Ex_n, C_mean, Ex_mean, C_SE, Ex_SE, C_SD, Ex_SD), as.numeric))%>%
mutate(across(where(is.character), as.factor))
db_freq <- db %>%
# Group by all variables that define a unique flow path and the frequency count
group_by(Study_ID, Outcome_type, Species_latin, Strain, Sex) %>%
# Count the number of rows (observations) in each group
summarise(Freq = n(), .groups = 'drop')
custom_colors <- c(
"Female" = "#1F78B4",   # Deep Blue
"Male" = "#FF7F00",     # Bright Orange (strong contrast to blue)
"Mixed" = "#A6A6A6"     # Neutral Gray
)
# --- Plotting the Aggregated Data (db_freq) ---
Out_spp_strain<-ggplot(db_freq,
# Explicitly use the calculated Freq column for the flow height
aes(y = Freq,
axis1 = Outcome_type, axis2 = Species_latin, axis3 = Strain)) +
# 1. Flow and Transparency
geom_flow(color = "black",
aes(fill = as.factor(Sex)),
alpha = 0.3) +
# Add the strata boxes
geom_stratum() +
# 2. Adjust Strata Text (Labels)
geom_text(stat = "stratum",
aes(label = after_stat(stratum)),
size = 3,
discern = TRUE,
color = "black",
fontface = "bold",
vjust = 0.5) +
# 3. Apply Custom Color Palette
scale_fill_manual(
name = "Sex",
values = custom_colors
) +
labs(
title = "Study subjects")+
# 4. Axis Headings at the BOTTOM
annotate("text", x = 1, y = min(db_freq$Freq) * -0.1, label = "Outcome Type", fontface = "bold", vjust = 1) +
annotate("text", x = 2, y = min(db_freq$Freq) * -0.1, label = "Species", fontface = "bold", vjust = 1) +
annotate("text", x = 3, y = min(db_freq$Freq) * -0.1, label = "Strain", fontface = "bold", vjust = 1) +
# 5. Hide Axes and Clean Theme
scale_y_continuous(labels = NULL) +
theme(
plot.margin = margin(t = 5, r = 5, b = 25, l = 5, unit = "pt"),
axis.line.x = element_blank(),
axis.ticks.x = element_blank(),
axis.text.x = element_blank(),
axis.title.y = element_blank(),
axis.text.y = element_blank(),
axis.ticks.y = element_blank(),
panel.grid.major = element_blank(),
panel.grid.minor = element_blank(),
panel.background = element_blank()
)
Out_spp_strain
db_fixed_assay <- db %>%
# Filter the data to ensure we only rename the categories we listed
mutate(
# Create a new, shortened column for the Assay Type labels
Assay_initials = case_when(
Assay_type == "Elevated Plus Maze" ~ "EPM",
Assay_type == "Open Field Test" ~ "OFT",
Assay_type == "Light-Dark Box" ~ "LDB",
Assay_type == "Novelty Suppressed Feeding (NSF)" ~ "NSF",
Assay_type == "Sucrose Preference Test (SPT)" ~ "SPT",
Assay_type == "Forced Swim Test (FST)" ~ "FST",
Assay_type == "Tail Suspension Test (TST)" ~ "TST",
Assay_type == "Nest building" ~ "Nest",
Assay_type == "Marble burying" ~ "MB",
TRUE ~ Assay_type # Keep any other unlisted Assay_type names as they are
)
) %>%
# Group by the new axis variables and the flow variable (`Induced behaviour`)
group_by(Study_ID, Lifestage_exposure, Music_exposure_duration, Assay_initials, `Induced behaviour`) %>%
# Count the number of observations (Freq)
summarise(Freq = n(), .groups = 'drop')
# --- 2. PLOTTING STEP ---
custom_colors <- c(
"Innate" = "blue",
"Induced" = "red"
)
assay_plot <- ggplot(db_fixed_assay,
# Use Freq for flow height
# Axis 3 is now Assay_initials
aes(y = Freq,
axis1 = Lifestage_exposure, axis2 = Music_exposure_duration, axis3 = Assay_initials)) +
# 1. Flow and Transparency (alpha = 0.3)
geom_flow(color = "black",
aes(fill = as.factor(`Induced behaviour`)),
alpha = 0.3) +
# Add the strata boxes
geom_stratum() +
# 2. Adjust Strata Text (Labels) - Will now show the initials (EPM, SPT, etc.)
geom_text(stat = "stratum",
aes(label = after_stat(stratum)),
size = 3,
discern = TRUE,
color = "black",
fontface = "bold",
vjust = 0.5) +
# 3. Apply Custom Color Palette and Legend Title
scale_fill_manual(
name = "Behavioral Mechanisms",
values = custom_colors
) +
labs(
title = "Music exposure"
) +
# 4. Axis Headings at the BOTTOM
# Axis 3 heading is changed to 'Assay Type'
annotate("text", x = 1, y = min(db_fixed_assay$Freq) * -0.1, label = "Age", fontface = "bold", vjust = 1) +
annotate("text", x = 2, y = min(db_fixed_assay$Freq) * -0.1, label = "Duration", fontface = "bold", vjust = 1) +
annotate("text", x = 3, y = min(db_fixed_assay$Freq) * -0.1, label = "Assay Type", fontface = "bold", vjust = 1) +
# 5. Hide Axes and Clean Theme
scale_y_continuous(labels = NULL) +
theme(
plot.margin = margin(t = 5, r = 5, b = 25, l = 5, unit = "pt"),
axis.line.x = element_blank(),
axis.ticks.x = element_blank(),
axis.text.x = element_blank(),
axis.title.y = element_blank(),
axis.text.y = element_blank(),
axis.ticks.y = element_blank(),
panel.grid.major = element_blank(),
panel.grid.minor = element_blank(),
panel.background = element_blank()
)
assay_plot
plot1<-(Out_spp_strain/assay_plot)+ plot_annotation(
tag_levels = 'A'
)
plot1
ggsave(filename = here("..","Plots", "alluvial.pdf"),
plot = plot1,
dpi = 300, device = cairo_pdf, width = 12,
height = 15)
ggsave(filename = here("..","Plots", "alluvial.jpg"),
plot = plot1,
width = 12,
height = 15,
dpi = 300)
