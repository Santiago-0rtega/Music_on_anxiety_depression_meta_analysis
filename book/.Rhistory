level_names <- as.character(res1$name)
new_contrast_names <- get_ordered_contrast_names(level_names)
tibble::tibble(
Levels = c(level_names, new_contrast_names),
Estimate = c(res1$estimate, res2$estimate),
Lower_CI = c(res1$lowerCL, res2$lowerCL),
Upper_CI = c(res1$upperCL, res2$upperCL),
P_value = c(res1$pval, res2$pval),
Lower_PI = c(res1$lowerPR, res2$lowerPR),
Upper_PI = c(res1$upperPR, res2$upperPR)
)
}
# --- MAIN EXECUTION FLOW ---
# 1. Calculate Group Means (Base Model)
res1 <- get_pred1(model, mod = mod)
# 2. Calculate Contrasts (Re-leveled Models)
estimates <- purrr::map(contra, ~ get_pred2(.x))
# 3. Drop intercepts from contrast models (we only want the differences)
res2 <- purrr::map_dfr(estimates, ~.x[-1, ])
# 4. Final Polish
results <- mr_results(res1, res2)
return(results)
}
#| label: clean_unique_contrasts_function
#| fold: TRUE
clean_unique_contrasts <- function(full_results_table, level_count = 6) {
# --- 1. Split Data ---
# Keep the single group means safe at the top
level_estimates <- full_results_table[1:level_count, ]
# Isolate the pairwise comparisons
contrast_estimates <- full_results_table[-(1:level_count), ]
# --- 2. Clean Names ---
# Parse "GroupA-GroupB" into separate columns
contrast_estimates <- contrast_estimates %>%
mutate(
Level1 = str_extract(Levels, "^(.*?)-"),
Level2 = str_extract(Levels, "-(.*?)$")
) %>%
mutate(
Level1 = str_replace_all(Level1, "-", ""),
Level2 = str_replace_all(Level2, "-", "")
)
# --- 3. Deduplicate ---
# Create a sorted key so "A_B" and "B_A" are treated as identical
contrast_estimates <- contrast_estimates %>%
mutate(
Unique_Pair_Key = paste(pmin(Level1, Level2), pmax(Level1, Level2), sep = "_")
) %>%
# Keep only the first instance of each unique pair
distinct(Unique_Pair_Key, .keep_all = TRUE) %>%
select(-Level1, -Level2, -Unique_Pair_Key)
# --- 4. Recombine ---
final_table <- bind_rows(level_estimates, unique_contrasts)
return(final_table)
}
#| label: filter_outcome_type
#| fold: TRUE
k_counts <- db %>%
group_by(Outcome_type) %>%
summarise(k_es = n())
levels_to_keep <- k_counts %>%
filter(k_es >= 5) %>%
pull(Outcome_type)
db_filtered <- db %>%
filter(Outcome_type %in% levels_to_keep)
indices_to_keep <- which(db$Outcome_type %in% levels_to_keep)
VCV_filtered <- VCV[indices_to_keep, indices_to_keep]
#| label: model_outcome_type
mOT <- rma.mv(yi = lnRR,
V = VCV_filtered,
mods = ~ Outcome_type-1,
random = list(~1 | Study_ID,
~1 | ES_ID,
~1 | Strain),
test = "t",
method = "REML",
sparse = TRUE,
data = db_filtered)
summary(mOT)
r2OT <- round(r2_ml(mOT), 4)
r2OT
#| label: orchard_outcome_type
#| fig-width: 6
#| fig-height: 4
#| warning: false
orchard_outcome<-orchard_plot(mOT,
mod = "Outcome_type",
group = "Study_ID",
xlab = "lnRR",
flip = FALSE) +
scale_colour_brewer(palette = "Set1") +
scale_fill_brewer(palette = "Dark2")+scale_y_continuous(breaks = seq(-8, 10, by = 2),
minor_breaks = seq(-8, 10, by = 1 ))
orchard_outcome
#| label: save-figure
#| eval: false
ggsave(filename = here("..","Plots", "orchard_outcome_lnRR.pdf"),
plot = orchard_outcome,
dpi = 300, device = cairo_pdf)
ggsave(filename = here("..","Plots", "orchard_outcome_lnRR.jpg"),
plot = orchard_outcome,
width = 7,
height = 9,
dpi = 300)
mOT <- rma.mv(yi = lnRR,
V = VCV_filtered,
mods = ~ Outcome_type,
random = list(~1 | Study_ID,
~1 | ES_ID,
~1 | Strain),
test = "t",
method = "REML",
sparse = TRUE,
data = db_filtered)
summary(mOT)
#| label: model_lifestage_exp
mLE <- rma.mv(yi = lnRR,
V = VCV,
mods = ~ Lifestage_exposure-1,
random = list(~1 | Study_ID,
~1 | ES_ID,
~1 | Strain),
test = "t",
method = "REML",
sparse = TRUE,
data = db)
summary(mLE)
r2LE <- round(r2_ml(mLE), 4)
r2LE
#| label: orchard_lifestage_exp
#| fig-width: 6
#| fig-height: 4
#| warning: false
orchard_lifestage<-orchard_plot(mLE,
mod = "Lifestage_exposure",
group = "Study_ID",
xlab = "lnRR",
flip = FALSE) +
scale_colour_brewer(palette = "Set1") +
scale_fill_brewer(palette = "Dark2")+scale_y_continuous(breaks = seq(-8, 10, by = 2),
minor_breaks = seq(-8, 10, by = 1 ))
orchard_lifestage
#| label: lifestage_contrasts
# Here we apply our custum functions
# The Generator
contra_LE <- contrast_fun(data = db,
response = lnRR,
moderator = Lifestage_exposure,
VCV = VCV)
#The Harvester
t1<-get_estimate(model = mLE, contra = contra_LE, moderator = Lifestage_exposure)
#The Cleaner
t2 <- clean_unique_contrasts(full_results_table = t1, level_count = 6)
#| label: clean_unique_contrasts_function
#| fold: TRUE
clean_unique_contrasts <- function(full_results_table, level_count = 6) {
# --- 1. Split Data ---
# Keep the single group means safe at the top
level_estimates <- full_results_table[1:level_count, ]
# Isolate the pairwise comparisons
contrast_estimates <- full_results_table[-(1:level_count), ]
# --- 2. Clean Names ---
# Parse "GroupA-GroupB" into separate columns
contrast_estimates <- contrast_estimates %>%
mutate(
Level1 = str_extract(Levels, "^(.*?)-"),
Level2 = str_extract(Levels, "-(.*?)$")
) %>%
mutate(
Level1 = str_replace_all(Level1, "-", ""),
Level2 = str_replace_all(Level2, "-", "")
)
# --- 3. Deduplicate ---
# Create a sorted key so "A_B" and "B_A" are treated as identical
unique_contrasts <- contrast_estimates %>%
mutate(
Unique_Pair_Key = paste(pmin(Level1, Level2), pmax(Level1, Level2), sep = "_")
) %>%
# Keep only the first instance of each unique pair
distinct(Unique_Pair_Key, .keep_all = TRUE) %>%
select(-Level1, -Level2, -Unique_Pair_Key)
# --- 4. Recombine ---
final_table <- bind_rows(level_estimates, unique_contrasts)
return(final_table)
}
#| label: lifestage_contrasts
# Here we apply our custum functions
# The Generator
contra_LE <- contrast_fun(data = db,
response = lnRR,
moderator = Lifestage_exposure,
VCV = VCV)
#The Harvester
t1<-get_estimate(model = mLE, contra = contra_LE, moderator = Lifestage_exposure)
#The Cleaner
t2 <- clean_unique_contrasts(full_results_table = t1, level_count = 6)
t2
#| label: save-figure_lifestage
#| eval: false
ggsave(filename = here("..","Plots", "orchard_lifestage_lnRR.pdf"),
plot = orchard_lifestage,
dpi = 300, device = cairo_pdf)
ggsave(filename = here("..","Plots", "orchard_lifestage_lnRR.jpg"),
plot = orchard_lifestage,
width = 9,
height = 7,
dpi = 300)
#| label: filter_sex
#| fold: TRUE
k_counts <- db %>%
group_by(Sex) %>%
summarise(k_es = n())
levels_to_keep <- k_counts %>%
filter(k_es >= 5) %>%
pull(Sex)
db_filtered <- db %>%
filter(Sex %in% levels_to_keep)
indices_to_keep <- which(db$Sex %in% levels_to_keep)
VCV_filtered <- VCV[indices_to_keep, indices_to_keep]
#| label: model_sex
mSX <- rma.mv(yi = lnRR,
V = VCV_filtered,
mods = ~ Sex-1,
random = list(~1 | Study_ID,
~1 | ES_ID,
~1 | Strain),
test = "t",
method = "REML",
sparse = TRUE,
data = db_filtered)
summary(mSX)
r2SX <- round(r2_ml(mSX), 4)
r2SX
#| label: orchard_sex
#| fig-width: 6
#| fig-height: 4
#| warning: false
orchard_sex<-orchard_plot(mSX,
mod = "Sex",
group = "Study_ID",
xlab = "lnRR",
flip = FALSE) +
scale_colour_brewer(palette = "Dark2") +
scale_fill_brewer(palette = "Set1")+scale_y_continuous(breaks = seq(-5, 10, by = 2),
minor_breaks = seq(-5, 10, by = 1 ))
orchard_sex
#| label: save-figure_lifestage
#| eval: false
ggsave(filename = here("..","Plots", "orchard_sex_lnRR.pdf"),
plot = orchard_sex,
dpi = 300, device = cairo_pdf)
ggsave(filename = here("..","Plots", "orchard_sex_lnRR.jpg"),
plot = orchard_sex,
width = 7,
height = 9,
dpi = 300)
mSX <- rma.mv(yi = lnRR,
V = VCV_filtered,
mods = ~ Sex,
random = list(~1 | Study_ID,
~1 | ES_ID,
~1 | Strain),
test = "t",
method = "REML",
sparse = TRUE,
data = db_filtered)
summary(mSX)
#| label: model_music_genre
mMG <- rma.mv(yi = lnRR,
V = VCV,
mods = ~ Meta_genre-1,
random = list(~1 | Study_ID,
~1 | ES_ID,
~1 | Strain),
test = "t",
method = "REML",
sparse = TRUE,
data = db)
summary(mMG)
r2MG <- round(r2_ml(mMG), 4)
r2MG
#| label: music_genre_contrasts
# The Generator
contra_mMG <- contrast_fun(data = db,
response = lnRR,
moderator = Meta_genre,
VCV = VCV)
# The Harvester
t1<-get_estimate(model = mMG, contra = contra_mMG, moderator = Meta_genre)
# The Cleaner
t2 <- clean_unique_contrasts(full_results_table = t1, level_count = 4)
t2
#| label: orchard_music_genre
#| fig-width: 6
#| fig-height: 4
#| warning: false
orchard_genre<-orchard_plot(mMG,
mod = "Meta_genre",
group = "Study_ID",
xlab = "lnRR",
flip = FALSE) +
scale_colour_brewer(palette = "Dark2") +
scale_fill_brewer(palette = "Set1")+scale_y_continuous(breaks = seq(-5, 10, by = 2),
minor_breaks = seq(-5, 10, by = 1 ))
orchard_genre
#| label: save-figure_genre
#| eval: false
ggsave(filename = here("..","Plots", "orchard_genre_lnRR.pdf"),
plot = orchard_genre,
dpi = 300, device = cairo_pdf)
ggsave(filename = here("..","Plots", "orchard_genre_lnRR.jpg"),
plot = orchard_genre,
width = 9,
height = 7,
dpi = 300)
#| label: filter_music_exposure
#| fold: TRUE
k_counts <- db %>%
group_by(Music_exposure_duration) %>%
summarise(k_es = n())
levels_to_keep <- k_counts %>%
filter(k_es >= 5) %>%
pull(Music_exposure_duration)
db_filtered <- db %>%
filter(Music_exposure_duration %in% levels_to_keep)
indices_to_keep <- which(db$Music_exposure_duration %in% levels_to_keep)
VCV_filtered <- VCV[indices_to_keep, indices_to_keep]
#| label: model_music_exposure
mMED <- rma.mv(yi = lnRR,
V = VCV_filtered,
mods = ~ Music_exposure_duration-1,
random = list(~1 | Study_ID,
~1 | ES_ID,
~1 | Strain),
test = "t",
method = "REML",
sparse = TRUE,
data = db_filtered)
summary(mMED)
r2MED <- round(r2_ml(mMED), 4)
r2MED
#| label: orchard_music_exposure
#| fig-width: 6
#| fig-height: 4
#| warning: false
orchard_plot(mMED,
mod = "Music_exposure_duration",
group = "Study_ID",
xlab = "log response ratio (lnRR)",
flip = FALSE)
#| label: orchard_music_exposure
#| fig-width: 6
#| fig-height: 4
#| warning: false
orchard_exposure<-orchard_plot(mMED,
mod = "Music_exposure_duration",
group = "Study_ID",
xlab = "log response ratio (lnRR)",
flip = FALSE)  +
scale_colour_brewer(palette = "Dark2") +
scale_fill_brewer(palette = "Set1")+scale_y_continuous(breaks = seq(-5, 10, by = 2),
minor_breaks = seq(-5, 10, by = 1 ))
orchard_exposure
#| label: save-figure_exposure
#| eval: false
ggsave(filename = here("..","Plots", "orchard_exposure_lnRR.pdf"),
plot = orchard_exposure,
dpi = 300, device = cairo_pdf)
ggsave(filename = here("..","Plots", "orchard_exposure_lnRR.jpg"),
plot = orchard_exposure,
width = 9,
height = 7,
dpi = 300)
LEVELS <- c("Acute", "Medium", "Short")
MOD_NAME <- "Music_exposure_duration"
# Model A: Reference = Acute (A vs B, A vs C)
db_filtered$moderator_relevel_A <- relevel(db_filtered$Music_exposure_duration, ref = LEVELS[1])
model_A <- rma.mv(yi = lnRR,
V = VCV_filtered,
mods = ~ moderator_relevel_A,
random = list(~1 | Study_ID, ~1 | ES_ID, ~1 | Strain),
test = "t", method = "REML", sparse = TRUE,
data = db_filtered)
model_A
# Model B: Reference = Medium (B vs C)
db_filtered$moderator_relevel_B <- relevel(db_filtered$Music_exposure_duration, ref = LEVELS[2])
model_B <- rma.mv(yi = lnRR,
V = VCV_filtered,
mods = ~ moderator_relevel_B,
random = list(~1 | Study_ID, ~1 | ES_ID, ~1 | Strain),
test = "t", method = "REML", sparse = TRUE,
data = db_filtered)
model_B
# Model C: Reference = Short (C estimate)
db_filtered$moderator_relevel_C <- relevel(db_filtered$Music_exposure_duration, ref = LEVELS[3])
model_C <- rma.mv(yi = lnRR,
V = VCV_filtered,
mods = ~ moderator_relevel_C,
random = list(~1 | Study_ID, ~1 | ES_ID, ~1 | Strain),
test = "t", method = "REML", sparse = TRUE,
data = db_filtered)
model_C
#| label: model_experimental_design
mEXD <- rma.mv(yi = lnRR,
V = VCV,
mods = ~ Experimental_design-1,
random = list(~1 | Study_ID,
~1 | ES_ID,
~1 | Strain),
test = "t",
method = "REML",
sparse = TRUE,
data = db)
summary(mEXD)
r2EXD <- round(r2_ml(mEXD), 4)
r2EXD
#| label: orchard_experimental_design
#| fig-width: 6
#| fig-height: 4
#| warning: false
orchard_design<-orchard_plot(mEXD,
mod = "Experimental_design",
group = "Study_ID",
xlab = "log response ratio (lnRR)",
flip=FALSE) +scale_y_continuous(breaks = seq(-5, 10, by = 2),
minor_breaks = seq(-5, 10, by = 1 ))
orchard_design
#| label: save-figure_design
#| eval: false
ggsave(filename = here("..","Plots", "orchard_design_lnRR.pdf"),
plot = orchard_exposure,
dpi = 300, device = cairo_pdf)
ggsave(filename = here("..","Plots", "orchard_design_lnRR.jpg"),
plot = orchard_exposure,
width = 9,
height = 7,
dpi = 300)
#| label: save-figure_design
#| eval: false
ggsave(filename = here("..","Plots", "orchard_design_lnRR.pdf"),
plot = orchard_design,
dpi = 300, device = cairo_pdf)
ggsave(filename = here("..","Plots", "orchard_design_lnRR.jpg"),
plot = orchard_design,
width = 9,
height = 7,
dpi = 300)
#| label: music_genre_contrasts
# The Generator
contra_mMG <- contrast_fun(data = db,
response = lnRR,
moderator = Experimental_design,
VCV = VCV)
# The Harvester
t1<-get_estimate(model = mMG, contra = contra_mMG, moderator = Experimental_design)
#| label: music_genre_contrasts
# The Generator
contra_mEXD <- contrast_fun(data = db,
response = lnRR,
moderator = Experimental_design,
VCV = VCV)
# The Harvester
t1<-get_estimate(model = mEXD, contra = contra_mEXD, moderator = Experimental_design)
# The Cleaner
t2 <- clean_unique_contrasts(full_results_table = t1, level_count = 3)
t2
#| label: model_induced_behaviour
mIB <- rma.mv(yi = lnRR,
V = VCV,
mods = ~ `Induced behaviour`-1,
random = list(~1 | Study_ID,
~1 | ES_ID,
~1 | Strain),
test = "t",
method = "REML",
sparse = TRUE,
data = db)
summary(mIB)
r2IB <- round(r2_ml(mIB), 4)
r2IB
#| label: orchard_INDUCED_BEHAVIOUR
#| fig-width: 6
#| fig-height: 4
#| warning: false
orchard_behaviour<-orchard_plot(mIB,
mod = "Induced behaviour",
group = "Study_ID",
xlab = "log response ratio (lnRR)",
flip = FALSE) +scale_y_continuous(breaks = seq(-5, 10, by = 2),
minor_breaks = seq(-5, 10, by = 1 ))
orchard_behaviour
#| label: save-figure_behaviour
#| eval: false
ggsave(filename = here("..","Plots", "orchard_behaviour_lnRR.pdf"),
plot = orchard_behaviour,
dpi = 300, device = cairo_pdf)
ggsave(filename = here("..","Plots", "orchard_behaviour_lnRR.jpg"),
plot = orchard_behaviour,
width = 9,
height = 7,
dpi = 300)
mIB <- rma.mv(yi = lnRR,
V = VCV,
mods = ~ `Induced behaviour`,
random = list(~1 | Study_ID,
~1 | ES_ID,
~1 | Strain),
test = "t",
method = "REML",
sparse = TRUE,
data = db)
summary(mIB)
