---
title: "Uni-moderator (lnVR)"
---
We fit uni-moderator multilevel meta-regressions for $ln VR$ to test whether study characteristics predict changes in behavioral dispersion under music exposure. Negative $ln VR$ values indicate reduced dispersion (more consistent responses), whereas positive values indicate increased dispersion. For moderators with sparse levels ($k < 5$), we removed those levels and subset the varianceâ€“covariance matrix to match the filtered dataset
```{r}
#| label: setup
#| include: false
pacman::p_load(
               DT,
               dtplyr,
               here, 
               knitr,
               tidyverse,
               patchwork,
               metafor,
               orchaRd ,multcomp
               )

db <- readr::read_csv(here("..","data","db_lnVR.csv")) %>%
  mutate(across(c(C_n, Ex_n, C_mean, Ex_mean, C_SE, Ex_SE, C_SD, Ex_SD, lnVR, lnVR_var), as.numeric)) %>%
  mutate(across(where(is.character), as.factor)) 


# CALCULATE VCV USING lnVR VARIANCE
VCV <- metafor::vcalc(
  vi = lnVR_var,       
  cluster = Cohort_ID, # The clustering variable (Study_ID + Ex_ID)
  obs = ES_ID,         # The unique observation/effect size ID
  rho = 0.5,           # Assumed correlation between outcomes from the same cohort
  data = db 
)
```



```{r}
#| label: filter_function
#| fold: TRUE

filter_low_k <- function(dat, V, moderator, min_k = 5) {
  moderator <- rlang::ensym(moderator)
  k_counts <- dat %>%
    dplyr::count(!!moderator, name = "k_es")
  keep_levels <- k_counts %>% dplyr::filter(k_es >= min_k) %>% dplyr::pull(!!moderator)
  dat_f <- dat %>% dplyr::filter((!!moderator) %in% keep_levels)
  idx <- which(dat[[rlang::as_string(moderator)]] %in% keep_levels)
  V_f <- V[idx, idx]
  list(data = dat_f, V = V_f, keep = keep_levels, k = k_counts)
}

```


# Meta-regressions

::: panel-tabset
## 1. Outcome type: Anxiety and Depression





```{r}
#| label: filter_outcome_type_application
f <- filter_low_k(db, VCV, Outcome_type, min_k = 5)
db_filtered <- f$data
VCV_filtered <- f$V
```




```{r}
#| label: model_outcome_type

mOT <- rma.mv(yi = lnVR, 
                  V = VCV_filtered, 
              mods = ~ Outcome_type,
                  random = list(~1 | Study_ID,
                                ~1 | ES_ID,
                                ~1 | Strain),
                  test = "t",
                  method = "REML", 
                  sparse = TRUE,
                  data = db_filtered)

summary(mOT)
```

```{r}
r2OT <- round(r2_ml(mOT), 4)
r2OT
```

```{r}
#| label: orchard_outcome_type
#| fig-width: 6
#| fig-height: 4
#| warning: false
orchard_outcome<-orchard_plot(mOT,
              mod = "Outcome_type",
               group = "Study_ID",
               xlab = expression(lnVR),trunk.size = 0.3,     
              branch.size = 2  ,alpha = 0.3
              ) +
            scale_colour_brewer(palette = "Set1") +
            scale_fill_brewer(palette = "Dark2")+scale_y_continuous(limits = c(-6,11),breaks = seq(-6, 10, by = 2),
                                                                    minor_breaks = seq(-6, 11, by = 1 ))
orchard_outcome
```

## 2. Lifestage of exposure

```{r}
#| label: model_lifestage_exp

mLE <- rma.mv(yi = lnVR, 
                  V = VCV, 
              mods = ~ Lifestage_exposure-1,
                  random = list(~1 | Study_ID,
                                ~1 | ES_ID,
                                ~1 | Strain),
                  test = "t",
                  method = "REML", 
                  sparse = TRUE,
                  data = db)

summary(mLE)
```

```{r}
r2LE <- round(r2_ml(mLE), 4)
r2LE
```

```{r}
summary(glht(mLE, linfct=cbind(contrMat(rep(1,6), type="Tukey"))), test=adjusted("none"))
```

```{r}
#| label: orchard_lifestage_exp
#| fig-width: 6
#| fig-height: 4
#| warning: false


lifestage_labels <- c(
  "Adolescent"  = "Adol.",
  "Adult"       = "Adult",
  "Juvenile"    = "Juv.",
  "Young adult" = "Y. adult",
  "Mixed"       = "Mixed",
  "Unclear"     = "Unclear"
)


orchard_lifestage<-orchard_plot(mLE,legend.pos = "top.left",
              mod = "Lifestage_exposure",
               group = "Study_ID",
                xlab = expression(lnVR), trunk.size = 0.3,     
              branch.size = 2 ,alpha = 0.3
              ) + scale_x_discrete(labels = lifestage_labels)+
            scale_colour_brewer(palette = "Set1") +
            scale_fill_brewer(palette = "Dark2")+scale_y_continuous(limits=c(-6,10.5),breaks = seq(-6, 10, by = 2),
                                                                    minor_breaks = seq(-6, 10, by = 1 ))+ 
  theme(legend.direction = "vertical")
orchard_lifestage
```

```{r}
#| label: save-figure_lifestage
#| eval: false

ggsave(filename = here("..","Plots", "orchard_lifestage_lnVR.pdf"), 
       plot = orchard_lifestage,
       dpi = 300, device = cairo_pdf)

ggsave(filename = here("..","Plots", "orchard_lifestage_lnVR.jpg"),
       plot = orchard_lifestage,
       width = 9,  
       height = 7,  
       dpi = 300)
```

## 3. Sex

```{r}
#| label: filter_sex
#| fold: TRUE
f <- filter_low_k(db, VCV, Sex, min_k = 5)
db_filtered <- f$data
VCV_filtered <- f$V
```

```{r}
#| label: model_sex

mSX <- rma.mv(yi = lnVR,
                  V = VCV_filtered, 
              mods = ~ Sex,
                  random = list(~1 | Study_ID,
                                ~1 | ES_ID,
                                ~1 | Strain),
                  test = "t",
                  method = "REML", 
                  sparse = TRUE,
                  data = db_filtered)

summary(mSX)

```

```{r}
r2SX <- round(r2_ml(mSX), 4)
r2SX
```

```{r}
#| label: orchard_sex
#| fig-width: 6
#| fig-height: 4
#| warning: false






orchard_sex<-orchard_plot(mSX, legend.pos = "top.left",
             mod = "Sex",
              group = "Study_ID",
             xlab = expression(lnVR), 
             flip = T,trunk.size = 0.3,     
              branch.size = 2 ,alpha = 0.3) +
            scale_colour_brewer(palette = "Set1") +
            scale_fill_brewer(palette = "Dark2")+scale_y_continuous(limits=c(-6,10.5),breaks = seq(-8, 10, by = 2),
                                                                    minor_breaks = seq(-8, 10, by = 1 ))+ 
  theme(legend.direction = "vertical")
orchard_sex
```

```{r}
#| label: save-figure_sex
#| eval: false

ggsave(filename = here("..","Plots", "orchard_sex_lnVR.pdf"),
       plot = orchard_sex,
       dpi = 300, device = cairo_pdf)

ggsave(filename = here("..","Plots", "orchard_sex_lnVR.jpg"),
       plot = orchard_sex,
       width = 7,  
       height = 9,  
       dpi = 300)

```

## 4. Music genre

Meta_genre

```{r}
#| label: model_music_genre

mMG <- rma.mv(yi = lnVR,
                  V = VCV, 
              mods = ~ Meta_genre-1 ,
                  random = list(~1 | Study_ID,
                                ~1 | ES_ID,
                                ~1 | Strain),
                  test = "t",
                  method = "REML", 
                  sparse = TRUE,
                  data = db)

summary(mMG)

```

```{r}
r2MG <- round(r2_ml(mMG), 4)
r2MG
```

```{r}
summary(glht(mMG, linfct=cbind(contrMat(rep(1,4), type="Tukey"))), test=adjusted("none"))
```



```{r}
#| label: orchard_music_genre
#| fig-width: 6
#| fig-height: 4
#| warning: false



genre_labels <- c(
  "Mixed"  = "Mixed",
  "Popular Contemporary Music"       = "Contemporary",
  "Traditional Music / Folk / World"    = "World",
  "Western Art Music / Orchestral" = "Orchestral"
)





orchard_genre<-orchard_plot(mMG,legend.pos = "top.left",
             mod = "Meta_genre",
              group = "Study_ID",
             xlab = "lnVR", 
             flip = T,trunk.size = 0.3,     
              branch.size = 2,alpha = 0.3) +  
  scale_x_discrete(labels = genre_labels)+
            scale_colour_brewer(palette = "Set1") +
            scale_fill_brewer(palette = "Dark2")+scale_y_continuous(limits=c(-6,11),breaks = seq(-8, 10, by = 2),
                                                                    minor_breaks = seq(-8, 10, by = 1 ))+ 
  theme(legend.direction = "vertical")
orchard_genre
```

```{r}
#| label: save-figure_genre
#| eval: false

ggsave(filename = here("..","Plots", "orchard_genre_lnVR.pdf"),
       plot = orchard_genre,
       dpi = 300, device = cairo_pdf)

ggsave(filename = here("..","Plots", "orchard_genre_lnVR.jpg"),
       plot = orchard_genre,
       width = 9,  
       height = 7,  
       dpi = 300)

```

## 5. Music exposure duration

Music_exposure_duration

```{r}
#| label: filter_music_exposure
#| fold: TRUE

f <- filter_low_k(db, VCV, Music_exposure_duration, min_k = 5)
db_filtered <- f$data
VCV_filtered <- f$V
```

```{r}
#| label: model_music_exposure

mMED <- rma.mv(yi = lnVR,
                  V = VCV_filtered, 
              mods = ~ Music_exposure_duration-1,
                  random = list(~1 | Study_ID,
                                ~1 | ES_ID, 
                                ~1 | Strain),
                  test = "t",
                  method = "REML", 
                  sparse = TRUE,
                  data = db_filtered)

summary(mMED)

```

```{r}
r2MED <- round(r2_ml(mMED), 4)
r2MED
```

```{r}
summary(glht(mMED, linfct=cbind(contrMat(rep(1,3), type="Tukey"))), test=adjusted("none"))
```

```{r}
#| label: orchard_music_exposure
#| fig-width: 6
#| fig-height: 4
#| warning: false




orchard_exposure<-orchard_plot( mMED,legend.pos = "top.left",
             mod = "Music_exposure_duration",
              group = "Study_ID",
              xlab = "lnVR", 
              flip = T,trunk.size = 0.3,     
              branch.size = 2, alpha = 0.3)  +
            scale_colour_brewer(palette = "Set1") +
            scale_fill_brewer(palette = "Dark2")+scale_y_continuous(limits = c(-6,11),breaks = seq(-8, 11, by = 2),
                                                                    minor_breaks = seq(-8, 11, by = 1 ))+ 
  theme(legend.direction = "vertical")
orchard_exposure
```

```{r}
#| label: save-figure_exposure
#| eval: false

ggsave(filename = here("..","Plots", "orchard_exposure_lnVR.pdf"),
       plot = orchard_exposure,
       dpi = 300, device = cairo_pdf)

ggsave(filename = here("..","Plots", "orchard_exposure_lnVR.jpg"),
       plot = orchard_exposure,
       width = 9,  
       height = 7,  
       dpi = 300)

```

## 6. Experimental design

```{r}
#| label: model_experimental_design

mEXD <- rma.mv(yi = lnVR,
                  V = VCV, 
              mods = ~ Experimental_design-1,
                  random = list(~1 | Study_ID,
                                ~1 | ES_ID, 
                                ~1 | Strain),
                  test = "t",
                  method = "REML", 
                  sparse = TRUE,
                  data = db)

summary(mEXD)

```

```{r}
r2EXD <- round(r2_ml(mEXD), 4)
r2EXD
```

```{r}
summary(glht(mEXD, linfct=cbind(contrMat(rep(1,3), type="Tukey"))), test=adjusted("none"))
```







```{r}
#| label: orchard_experimental_design
#| fig-width: 6
#| fig-height: 4
#| warning: false


design_labels<-c(
  "Factorial"="Factorial",
  "Posttest-Only Control Group"="Posttest",
  "Repeated Measures"="Repeated"
  
)


orchard_design<-orchard_plot(mEXD,legend.pos = "top.left",
             mod = "Experimental_design",
              group = "Study_ID",
              xlab = expression(lnVR), 
              flip=T,
             trunk.size = 0.3,     
              branch.size = 2,alpha = 0.3 ) +
  scale_x_discrete(labels = design_labels) +
            scale_colour_brewer(palette = "Set1") +
            scale_fill_brewer(palette = "Dark2")+scale_y_continuous(limits = c(-6,10.5),breaks = seq(-8, 10, by = 2),
                                                                    minor_breaks = seq(-8, 10, by = 1 ))+ 
  theme(legend.direction = "vertical")
orchard_design
```

```{r}
#| label: save-figure_design
#| eval: false

ggsave(filename = here("..","Plots", "orchard_design_lnRR.pdf"),
       plot = orchard_design,
       dpi = 300, device = cairo_pdf)

ggsave(filename = here("..","Plots", "orchard_design_lnRR.jpg"),
       plot = orchard_design,
       width = 9,  
       height = 7,  
       dpi = 300)

```

## 7. Induced behaviour

```{r}
#| label: model_induced_behaviour

mIB <- rma.mv(yi = lnVR,
                  V = VCV, 
              mods = ~ `Induced behaviour` ,
                  random = list(~1 | Study_ID,
                                ~1 | ES_ID, 
                                ~1 | Strain),
                  test = "t",
                  method = "REML", 
                  sparse = TRUE,
                  data = db)

summary(mIB)

```

```{r}
r2IB <- round(r2_ml(mIB), 4)
r2IB
```

```{r}
#| label: orchard_INDUCED_BEHAVIOUR
#| fig-width: 6
#| fig-height: 4
#| warning: false
orchard_behaviour<-orchard_plot(mIB,
             mod = "Induced behaviour",legend.pos = "top.left",
              group = "Study_ID",
              xlab = expression(lnVR), 
              flip = T,trunk.size = 0.3,     
              branch.size = 2,alpha = 0.3)+
            scale_colour_brewer(palette = "Set1") +
            scale_fill_brewer(palette = "Dark2")+scale_y_continuous(limits = c(-6,10.5),breaks = seq(-8, 10, by = 2),
                                                                    minor_breaks = seq(-8, 10, by = 1 ))+  theme(legend.direction = "vertical")
orchard_behaviour
```

```{r}
#| label: save-figure_behaviour
#| eval: false

ggsave(filename = here("..","Plots", "orchard_behaviour_lnVR.pdf"),
       plot = orchard_behaviour,
       dpi = 300, device = cairo_pdf)

ggsave(filename = here("..","Plots", "orchard_behaviour_lnVR.jpg"),
       plot = orchard_behaviour,
       width = 9,  
       height = 7,  
       dpi = 300)

```

## 8. Relative timing

```{r}
#| label: model+_relative_timing

mRT <- rma.mv(yi = lnVR,
                  V = VCV, 
              mods = ~ Relative_timing-1,
                  random = list(~1 | Study_ID,
                                ~1 | ES_ID, 
                                ~1 | Strain),
                  test = "t",
                  method = "REML", 
                  data = db)

summary(mRT)

```

```{r}
r2RT <- round(r2_ml(mRT), 4)
r2RT
```

```{r}
summary(glht(mRT, linfct=cbind(contrMat(rep(1,3), type="Tukey"))), test=adjusted("none"))
```

```{r}
#| label: orchard_relative_timing
#| fig-width: 6
#| fig-height: 4
#| warning: false
orchard_timing<-orchard_plot(mRT,,legend.pos = "top.left",
             mod = "Relative_timing",
              group = "Study_ID",
              xlab = expression(lnVR),trunk.size = 0.3,     
              branch.size = 1) +
            scale_colour_brewer(palette = "Set1") +
            scale_fill_brewer(palette = "Dark2")+scale_y_continuous(limits = c(-6,10.5),breaks = seq(-8, 10, by = 2),
                                                                    minor_breaks = seq(-8, 10, by = 1 ))+  theme(legend.direction = "vertical")
orchard_timing

```

## 9. Experimental procedures

```{r}
#| label: model_Experimental_procedures

mEXP <- rma.mv(yi = lnVR,
                  V = VCV, 
              mods = ~ Experimental_procedures,
                  random = list(~1 | Study_ID,
                                ~1 | ES_ID, 
                                ~1 | Strain),
                  test = "t",
                  method = "REML", 
                  data = db)

summary(mEXP)

```

```{r}
r2EXP <- round(r2_ml(mEXP), 4)
r2EXP
```

```{r}
#| label: orchard_experimental_procedures
#| fig-width: 6
#| fig-height: 4
#| warning: false
orchard_exp<-orchard_plot(mEXP,legend.pos = "top.left",
             mod = "Experimental_procedures",
              group = "Study_ID",
              xlab = expression(lnVR),trunk.size = 0.3,     
              branch.size = 2,alpha = 0.3)  +
            scale_colour_brewer(palette = "Set1") +
            scale_fill_brewer(palette = "Dark2")+scale_y_continuous(limits = c(-6,10.5),breaks = seq(-8, 10, by = 2),
                                                                    minor_breaks = seq(-8, 10, by = 1 ))+  theme(legend.direction = "vertical")
orchard_exp
```

## 10. Control condition

```{r}
#| label: model_control_condition

mCC <- rma.mv(yi = lnVR,
                  V = VCV, 
              mods = ~ Control_conditions,
                  random = list(~1 | Study_ID,
                                ~1 | ES_ID, 
                                ~1 | Strain),
                  test = "t",
                  method = "REML", 
                  data = db)

summary(mCC)

```

```{r}
r2CC <- round(r2_ml(mCC), 4)
r2CC
```

```{r}
#| label: orchard_control_condition
#| fig-width: 6
#| fig-height: 4
#| warning: false

control_labels <- c(
  "ambiet sound" = "Ambient sound",
  "Ambiet sound" = "Ambient sound",  # optional safeguard if both exist
  "White noise"   = "White noise"
)
orchard_control<-orchard_plot(mCC,legend.pos = "top.left",
             mod = "Control_conditions",
              group = "Study_ID",
              xlab = expression(lnVR),trunk.size = 0.3,     
              branch.size = 2,alpha = 0.3) +
  scale_x_discrete(labels = control_labels) +
            scale_colour_brewer(palette = "Set1") +
            scale_fill_brewer(palette = "Dark2")+scale_y_continuous(limits = c(-6,10.5),breaks = seq(-8, 10, by = 2),
                                                                    minor_breaks = seq(-8, 10, by = 1 ))+  theme(legend.direction = "vertical")
orchard_control
```

## 11. Assay type

```{r}

#| label: filter_assay_type
f <- filter_low_k(db, VCV, Assay_type, min_k = 5)
db_filtered <- f$data
VCV_filtered <- f$V
```

```{r}
#| label: model_assay_type

mAT <- rma.mv(yi = lnVR,
                  V = VCV_filtered, 
              mods = ~ Assay_type-1,
                  random = list(~1 | Study_ID,
                                ~1 | ES_ID, 
                                ~1 | Strain),
                  test = "t",
                  method = "REML", 
                  sparse = TRUE,
                  data = db_filtered)

summary(mAT)

```

```{r}
r2AT <- round(r2_ml(mAT), 4)
r2AT
```

```{r}
summary(glht(mAT, linfct=cbind(contrMat(rep(1,5), type="Tukey"))), test=adjusted("none"))
```

```{r}

```



```{r}
#| label: orchard_assay_type
#| fig-width: 6
#| fig-height: 4
#| warning: false
assay_labels <- c(
  "Elevated Plus Maze" = "EPM",
  "Open Field Test" = "OFT",
  "Light-Dark Box" = "LDB",
  "Forced Swim Test (FST)" = "FST",
  "Tail Suspension Test (TST)" = "TST",
  "Sucrose Preference Test (SPT)" = "SPT"
)

orchard_assay <- orchard_plot(
  mAT,legend.pos = "top.left",
  mod   = "Assay_type",
  group = "Study_ID",
  xlab  = expression(lnVR) ,trunk.size = 0.3,     
              branch.size = 2,alpha = 0.3
) +
  scale_colour_brewer(palette = "Set1") +
  scale_fill_brewer(palette = "Dark2") +
  scale_x_discrete(labels = assay_labels)+
  scale_y_continuous(limits = c(-6,10.5),breaks = seq(-8, 10, by = 2),
                     minor_breaks = seq(-8, 10, by = 1 ))+  
  labs(
    x = NULL,
    y = expression(lnVR),
    subtitle = "Behavioural assay"
  ) +
  theme(
    plot.subtitle = element_text(size = 10, face = "bold"),
    axis.title.y = element_text(face = "bold"),legend.direction = "vertical")
  

orchard_assay


```


:::

```{r}
#| label: patched_figure
#| 
orchard_assay     <- orchard_assay     + labs(subtitle = "Behavioral assay")
orchard_lifestage <- orchard_lifestage + labs(subtitle = "Age at exposure")

orchard_genre   <- orchard_genre  + labs(subtitle = "Music meta-genre")
orchard_design <-orchard_design + labs(subtitle = "Experimental design")




# 2) Hide legends on all but ONE panel (choose bottom-right here)
orchard_assay    <- orchard_assay    + theme(legend.position = "none")
orchard_lifestage <- orchard_lifestage + theme(legend.position = "none")


# orchard_behaviour keeps the legend

# 3) Patch with your layout
patched_figure <- ( orchard_assay+orchard_lifestage) /
                 (orchard_genre + orchard_design) +
  plot_annotation(tag_levels = "A") &
  theme(
    plot.tag = element_text(size = 12, face = "bold"),
    plot.subtitle = element_text(size = 10, face = "bold")
   )
  

# 4) Enforce identical lnRR scale and a single y-axis label across ALL panels
patched_figure <- patched_figure &
  scale_y_continuous(
    limits = c(-8, 12),                       
    breaks = seq(-8, 12, by = 2),
    minor_breaks = seq(-8, 12, by = 1)
  ) &
  labs(y = expression(lnVR), x = NULL)

patched_figure

```

```{r}
#| label: save-figure_patched
#| eval: false

ggsave(filename = here("..","Plots", "patched_lnVR.pdf"),
       plot = patched_figure,
       dpi = 300, device = cairo_pdf,width = 10,  
       height = 10)

ggsave(filename = here("..","Plots", "patched_lnVR.jpg"),
       plot = patched_figure,
       width = 10,  
       height = 10,  
       dpi = 300)

```




::: callout-note
```{r}
sessionInfo()
```

:::


