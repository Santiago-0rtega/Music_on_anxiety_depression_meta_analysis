---
title: "Overall effects"
---

```{r}
#| label: setup
#| include: false
pacman::p_load(
               DT,
               dtplyr,
               here, 
               knitr,
               tidyverse,
               patchwork,
               metafor,
               orchaRd
               )
```


```{r}
#| label: load_effectsize_db
#| message: false
#| warning: false

db <- readr::read_csv(here("..","data","db_effect_sizes.csv")) %>%
  mutate(across(where(is.character), as.factor)) %>%
  mutate(across(c(lnRR, lnRR_var, lnVR, lnVR_var, lnCVR, lnCVR_var), as.numeric))
```

After estimating effect sizes, we fit three multilevel, intercept-only meta-analytic models to estimate the overall mean effect of music exposure on:

- the mean outcome (lnRR),

- the absolute variability (lnVR),

- the relative variability (lnCVR).

Because many studies contribute multiple, non-independent outcomes (often measured on the same cohort), we use `rma.mv()` in `metafor` with a cohort-level variance–covariance (VCV) matrix built using `vcalc()`.





::: callout-note
Variable definitions:

| Variable Name | Definition |
|:-----------------------------------|:-----------------------------------|
| **`ES_ID`** | Unique row identifier for each effect size. |
| **`Study_ID`** | Identifier for the primary research paper. |
| **`Cohort_ID`** | Identifier for specific experimental groups within a study (combination of Study_ID and Experiment_ID). |
|**`lnRR`**, **`lnRR_var`** | Log response ratio and its sample variance.|
|**`lnVR`**, **`lnVR_var`** | Log variability ratio and its sample variance.|
|**`lnCVR`**, **`lnCVR_var`** | Log coefficient of variation ratio and its sample variance.|



:::

## Variance–covariance matrices (within-cohort dependence)

We assume that multiple outcomes measured on the same cohort have correlated sampling errors. We therefore construct a VCV matrix with an assumed within-cohort correlation of r = 0.5 when correlations are not reported.


## Multilevel intercept-only meta-analytic models



The code below fits the three models using the same specification:

- Random intercepts for Study (`Study_ID`)

- Random intercepts for Effect size (`ES_ID`)

- Random intercepts for Strain (`Strain`)

- REML estimation and `test = "t"`



```{r}
#| label: overall_models_all_three
#| message: false
#| warning: false

fit_overall_mv <- function(dat, yi, vi, rho = 0.5) {
  
  dat2 <- dat %>%
    filter(!is.na(.data[[yi]]), !is.na(.data[[vi]]))
  
  VCV <- metafor::vcalc(
    vi = dat2[[vi]],
    cluster = dat2$Cohort_ID,
    obs = dat2$ES_ID,
    rho = rho,
    data = dat2
  )
  
  mod <- metafor::rma.mv(
    yi = dat2[[yi]],
    V  = VCV,
    random = list(
      ~1 | Study_ID,
      ~1 | ES_ID,
      ~1 | Strain
    ),
    test = "t",
    method = "REML",
    sparse = TRUE,
    data = dat2
  )
  
  list(data = dat2, VCV = VCV, model = mod)
}

res_lnRR  <- fit_overall_mv(db, yi = "lnRR",  vi = "lnRR_var",  rho = 0.5)
res_lnVR  <- fit_overall_mv(db, yi = "lnVR",  vi = "lnVR_var",  rho = 0.5)
res_lnCVR <- fit_overall_mv(db, yi = "lnCVR", vi = "lnCVR_var", rho = 0.5)





```



:::::::: columns
:::: {.column width="49%"}
::: panel-text
## lnRR
:::
```{r}
#| label: summary_lnRR
summary(res_lnRR$model)
```
```{r}
#| label: i2_lnRR
orchaRd::i2_ml(res_lnRR$model)
```
::: card
```{r}
#| label: orchard_lnRR
p_lnRR <- orchard_plot(
  res_lnRR$model,
  group = "Study_ID",
  xlab = "lnRR",
  flip = TRUE
) +
  scale_x_discrete(labels = "Overall effect")
p_lnRR
```
:::

::::

::: {.column width="2%"}
:::


:::: {.column width="49%"}
::: panel-text
## lnVR
:::
```{r}
#| label: summary_lnVR
summary(res_lnVR$model)
```
```{r}
#| label: i2_lnVR
orchaRd::i2_ml(res_lnVR$model)
```
::: card
```{r}
#| label: orchard_lnVR
p_lnVR <- orchard_plot(
  res_lnVR$model,
  group = "Study_ID",
  xlab = "lnVR",
  flip = TRUE
) +
  scale_x_discrete(labels = "Overall effect")
p_lnVR
```
:::

:::

::::



:::::::: columns
:::: {.column width="25%"}
::::
:::: {.column width="50%"}

::: panel-text
## lnCVR
:::
```{r}
#| label: summary_lnCVR
summary(res_lnCVR$model)
```

```{r}
#| label: i2_lnCVR
orchaRd::i2_ml(res_lnCVR$model)
```
::: card
```{r}
#| label: orchard_lnCVR
p_lnCVR <- orchard_plot(
  res_lnCVR$model,
  group = "Study_ID",
  xlab = "lnCVR",
  flip = TRUE
) +
  scale_x_discrete(labels = "Overall effect")
p_lnCVR
```
:::

:::
:::: {.column width="25%"}
::::

::::::::







::: callout-note

```{r}
sessionInfo()
```

:::

