---
title: "Overall effect"
---

After estimating effect sizes, we fit a multilevel, intercept-only meta-analytic model to estimate the overall mean effect of music exposure across all studies. 

Because many studies contributed multiple, non-independent effect sizes (e.g., multiple outcomes measured within the same cohort), we use the `rma.mv()` function from the `metafor` package to account for hierarchical structure and sampling dependence.


```{r}
#| label: setup
#| include: false
pacman::p_load(
               DT,
               dtplyr,
               here, 
               knitr,
               tidyverse,
               patchwork,
               metafor,
               orchaRd
               )
```

```{r}
#| label: load_and_clean_data
db <- readr::read_csv(here("..","data","db_lnRR.csv")) %>%
mutate(across(c(C_n, Ex_n, C_mean, Ex_mean, C_SE, Ex_SE, C_SD, Ex_SD,lnRR,lnRR_var), as.numeric))%>%
  mutate(across(where(is.character), as.factor))
```

::: callout-note
Variable definitions:

| Variable Name | Definition |
|:-----------------------------------|:-----------------------------------|
| **`ES_ID`** | Unique row identifier for each $\text{lnRR}$ effect size. |
| **`Study_ID`** | Identifier for the primary research paper. |
| **`Cohort_ID`** | Identifier for specific experimental groups within a study (combination of Study_ID and Experiment_ID). |
:::

## Variance–covariance matrix

We construct a variance–covariance (VCV) matrix to model dependencies among effect sizes derived from the same experimental cohort.

When multiple outcomes are measured on the same animals, their sampling errors are correlated. Treating them as fully independent would underestimate standard errors and inflate precision. The VCV matrix explicitly incorporates this correlation structure.


We assume a within-cohort correlation of ρ = 0.5 when the true correlation is not reported. This value reflects a moderate level of dependence and is commonly used in ecological and behavioral meta-analyses when correlations are unknown.


```{r}
#| label: vcv_matrix

VCV <- metafor::vcalc(
  vi = lnRR_var,
  cluster = Cohort_ID, # The clustering variable (Study_ID + Ex_ID)
  obs = ES_ID,         # The unique observation/effect size ID
  rho = 0.5,           # Assumed correlation between outcomes from the same cohort
  data = db 
)
```

## Multilevel intercept-only meta-analytic model

We fit an intercept-only multilevel meta-analysis to estimate the grand mean lnRR across all studies.

Random effects account for:
- Study-level variation (`Study_ID`)
- Within-study effect-size variation (`ES_ID`)
- Strain-level variation (`Strain`)

This structure partitions heterogeneity across hierarchical levels while preserving appropriate uncertainty.


::: callout-note
Note that the VCV matrix models correlated sampling errors at the cohort level, whereas random effects model between-study and between-effect heterogeneity.
:::


```{r}
#| label: multilevel_meta_analysis
ma_all <- rma.mv(yi = lnRR,
                  V = VCV, 
                  random = list(~1 | Study_ID,
                                ~1 | Cohort_ID,
                                ~1 | ES_ID,
                                ~1 | Strain),
                  test = "t",
                  method = "REML", 
                  sparse = TRUE,
                  data = db)

summary(ma_all)
```

We extract multilevel $I^2$ statistics to quantify the proportion of total variance attributable to heterogeneity at each random-effect level (rather than sampling error alone).


```{r}
#| label: i2_extraction
orchaRd::i2_ml(ma_all)
```



## Model simplification

Variance partitioning indicated that `Cohort_ID` accounted for negligible additional heterogeneity beyond the VCV structure and other random effects. We therefore refit a more parsimonious model excluding `Cohort_ID` to evaluate whether model fit materially changed.


```{r}
#| label: refit_model

ma_all <- rma.mv(yi = lnRR,
                  V = VCV, 
                  random = list(~1 | Study_ID,
                                ~1 | ES_ID,
                                ~1 | Strain),
                  test = "t",
                  method = "REML", 
                  sparse = TRUE,
                  data = db)

summary(ma_all)
```

```{r}
#| label: i2_extraction2
orchaRd::i2_ml(ma_all)
```



The simplified model produced nearly identical parameter estimates and heterogeneity components, supporting the use of the more parsimonious structure.


## Visualization of the overall effect

We visualize the pooled lnRR estimate using an orchard plot. The plot displays:

- The pooled mean effect
- Its 95% confidence interval
- Study-level effect sizes
- Prediction interval (if included)

Negative values indicate reductions in anxiety- or depression-like behavior.


```{r}
#| label: orchard_plot
#| fig-width: 6
#| fig-height: 4
#| warning: false
overall_lnRR<-orchard_plot(ma_all,
              group = "Study_ID",
              xlab = "lnRR", 
              flip=T) + 
              scale_x_discrete(labels = "Overall effect") +
                scale_y_continuous(breaks = seq(-8, 10, by = 2),
                                   minor_breaks = seq(-8, 10, by = 1 ))
overall_lnRR
```

::: callout-note

```{r}
sessionInfo()
```

:::

