---
title: "Uni-moderators"
---

```{r}
#| label: setup
#| include: false
pacman::p_load(
               DT,
               dtplyr,
               here, 
               knitr,
               tidyverse,
               patchwork,
               metafor,
               orchaRd, emmeans
               )

#| label: load_and_clean_data
db <- readr::read_csv(here("data","db_effect_sizes.csv")) %>%
mutate(across(c(C_n, Ex_n, C_mean, Ex_mean, C_SE, Ex_SE, C_SD, Ex_SD), as.numeric))%>%
  mutate(across(where(is.character), as.factor))



VCV <- metafor::vcalc(
  vi = lnRR_var,
  cluster = Cohort_ID, # The clustering variable (Study_ID + Ex_ID)
  obs = ES_ID,         # The unique observation/effect size ID
  rho = 0.5,           # Assumed correlation between outcomes from the same cohort
  data = db 
)
```

::: callout-note
Variable definitions:

| Variable Name | Definition |
|:-----------------------------------|:-----------------------------------|
| **`ES_ID`** | Unique row identifier for each $\text{lnRR}$ effect size. |
| **`Study_ID`** | Identifier for the primary research paper. |
| **`Cohort_ID`** | Identifier for specific experimental groups within a study. |
| **`Outcome_type`** | The behavioral construct measured. Levels: **Anxiety**, **Depression**, **both**, **unclear**. |
| **`Lifestage_exposure`** | Animal's developmental stage during music exposure. Levels: **Adolescent**, **Juvenile**, **Young adult**, **Adult**, **Mixed**, **Unclear**. |
| **`Sex`** | Sex of the subjects. Levels: **Male**, **Female**. |
| **`Strain`** | Specific animal strain or species used. |
| **`Meta_genre`** | Categorization of the music stimulus. Levels: **Western Art Music / Orchestral**, **Popular Contemporary Music**, **Traditional Music / Folk / World**, **Mixed**, **Unclear**. |
| **`Music_exposure_duration`** | Total time subjects were exposed to music. Levels: **Acute**, **short**, **medium**, **long**. |
| **`Experimental_design`** | Study's methodological setup. Levels: **Posttest-Only Control Group**, **Randomized Block**, **Factorial**, **Repeated Measures**. |
| **`Induced behaviour`** | Whether the tested behavior was innate or experimentally induced. |
| **`Relative_timing`** | When music was administered relative to the behavioral test. Levels: **before**, **concurrent**, **both**, **not specified**. |
| **`Experimental_procedures`** | Identifies non-treatment controls for interventions. Levels: **sham**, **none**. |
:::

## Meta-regressions





::: panel-tabset
## 1. Outcome type: Anxiety and Depression

```{r}
# 1. Identify and Filter Low-K Levels

# Calculate the count of ES_ID (k) for each level of Outcome_type
k_counts <- db %>%
  group_by(Outcome_type) %>%
  summarise(k_es = n())

# Identify the levels to keep (where k_es >= 5)
levels_to_keep <- k_counts %>%
  filter(k_es >= 5) %>%
  pull(Outcome_type)

# 2. Create the Filtered Data Frame
db_filtered <- db %>%
  filter(Outcome_type %in% levels_to_keep)

# 3. Subset the VCV Matrix (CRITICAL STEP)
# Assumes VCV matrix rows/columns match the original 'db' data frame indices.
indices_to_keep <- which(db$Outcome_type %in% levels_to_keep)
VCV_filtered <- VCV[indices_to_keep, indices_to_keep]
```

```{r}
#| label: model_outcome_type

mOT <- rma.mv(yi = lnRR,
                  V = VCV_filtered, 
              mods = ~ Outcome_type-1,
                  random = list(~1 | Study_ID,
                                ~1 | ES_ID,
                                ~1 | Strain),
                  test = "t",
                  method = "REML", 
                  sparse = TRUE,
                  data = db_filtered)

summary(mOT)

```

```{r}
r2OT <- round(r2_ml(mOT), 4)
r2OT
```

```{r}
#| label: orchard_outcome_type
#| fig-width: 6
#| fig-height: 4
#| warning: false
orchard_plot(mOT,
             mod = "Outcome_type",
              group = "Study_ID",
              xlab = "log response ratio (lnRR)", 
              angle = 45) 
```



## 2. Lifestage of exposure

```{r}
#| label: model_lifestage_exp

mLE <- rma.mv(yi = lnRR,
                  V = VCV, 
              mods = ~ Lifestage_exposure-1,
                  random = list(~1 | Study_ID,
                                ~1 | ES_ID,
                                ~1 | Strain),
                  test = "t",
                  method = "REML", 
                  sparse = TRUE,
                  data = db)

summary(mLE)

```

```{r}
r2LE <- round(r2_ml(mLE), 4)
r2LE
```

```{r}
#| label: orchard_lifestage_exp
#| fig-width: 6
#| fig-height: 4
#| warning: false
orchard_plot(mLE,
             mod = "Lifestage_exposure",
              group = "Study_ID",
              xlab = "log response ratio (lnRR)", 
              angle = 45) 
```

## 3. Sex

```{r}
# 1. Identify and Filter Low-K Levels

# Calculate the count of ES_ID (k) for each level of Sex
k_counts <- db %>%
  group_by(Sex) %>%
  summarise(k_es = n())

# Identify the levels to keep (where k_es >= 5)
levels_to_keep <- k_counts %>%
  filter(k_es >= 5) %>%
  pull(Sex)

# 2. Create the Filtered Data Frame
db_filtered <- db %>%
  filter(Sex %in% levels_to_keep)

# 3. Subset the VCV Matrix (CRITICAL STEP)
# Assumes VCV matrix rows/columns match the original 'db' data frame indices.
indices_to_keep <- which(db$Sex %in% levels_to_keep)
VCV_filtered <- VCV[indices_to_keep, indices_to_keep]
```

```{r}
#| label: model_sex

mSX <- rma.mv(yi = lnRR,
                  V = VCV_filtered, 
              mods = ~ Sex-1,
                  random = list(~1 | Study_ID,
                                ~1 | ES_ID,
                                ~1 | Strain),
                  test = "t",
                  method = "REML", 
                  sparse = TRUE,
                  data = db_filtered)

summary(mSX)

```

```{r}
r2SX <- round(r2_ml(mSX), 4)
r2SX
```

```{r}
#| label: orchard_sex
#| fig-width: 6
#| fig-height: 4
#| warning: false
orchard_plot(mSX,
             mod = "Sex",
              group = "Study_ID",
              xlab = "log response ratio (lnRR)", 
              angle = 45) 
```

## 4. Music genre

Meta_genre

```{r}
#| label: model_music_genre

mMG <- rma.mv(yi = lnRR,
                  V = VCV, 
              mods = ~ Meta_genre-1,
                  random = list(~1 | Study_ID,
                                ~1 | ES_ID,
                                ~1 | Strain),
                  test = "t",
                  method = "REML", 
                  sparse = TRUE,
                  data = db)

summary(mMG)

```

```{r}
r2MG <- round(r2_ml(mMG), 4)
r2MG
```

```{r}
#| label: orchard_music_genre
#| fig-width: 6
#| fig-height: 4
#| warning: false
orchard_plot(mMG,
             mod = "Meta_genre",
              group = "Study_ID",
              xlab = "log response ratio (lnRR)", 
              angle = 30) 
```

## 5. Music exposure duration

Music_exposure_duration

```{r}
# 1. Identify and Filter Low-K Levels

# Calculate the count of ES_ID (k) for each level of Music_exposure_duration
k_counts <- db %>%
  group_by(Music_exposure_duration) %>%
  summarise(k_es = n())

# Identify the levels to keep (where k_es >= 5)
levels_to_keep <- k_counts %>%
  filter(k_es >= 5) %>%
  pull(Music_exposure_duration)

# 2. Create the Filtered Data Frame
db_filtered <- db %>%
  filter(Music_exposure_duration %in% levels_to_keep)

# 3. Subset the VCV Matrix (CRITICAL STEP)
# Assumes VCV matrix rows/columns match the original 'db' data frame indices.
indices_to_keep <- which(db$Music_exposure_duration %in% levels_to_keep)
VCV_filtered <- VCV[indices_to_keep, indices_to_keep]
```

```{r}
#| label: model_music_exposure

mMED <- rma.mv(yi = lnRR,
                  V = VCV_filtered, 
              mods = ~ Music_exposure_duration-1,
                  random = list(~1 | Study_ID,
                                ~1 | ES_ID, 
                                ~1 | Strain),
                  test = "t",
                  method = "REML", 
                  sparse = TRUE,
                  data = db_filtered)

summary(mMED)

```

```{r}
r2MED <- round(r2_ml(mMED), 4)
r2MED
```

```{r}
#| label: orchard_music_genre
#| fig-width: 6
#| fig-height: 4
#| warning: false
orchard_plot(mMED,
             mod = "Music_exposure_duration",
              group = "Study_ID",
              xlab = "log response ratio (lnRR)", 
              angle = 30) 
```


## 6. Experimental design


```{r}
#| label: model_experimental_design

mEXD <- rma.mv(yi = lnRR,
                  V = VCV, 
              mods = ~ Experimental_design-1,
                  random = list(~1 | Study_ID,
                                ~1 | ES_ID, 
                                ~1 | Strain),
                  test = "t",
                  method = "REML", 
                  sparse = TRUE,
                  data = db)

summary(mEXD)

```

```{r}
r2EXD <- round(r2_ml(mEXD), 4)
r2EXD
```

```{r}
#| label: orchard_experimental_design
#| fig-width: 6
#| fig-height: 4
#| warning: false
orchard_plot(mEXD,
             mod = "Experimental_design",
              group = "Study_ID",
              xlab = "log response ratio (lnRR)", 
              angle = 30) 
```


## 7. Induced behaviour

```{r}
#| label: model_induced_behaviour

mIB <- rma.mv(yi = lnRR,
                  V = VCV, 
              mods = ~ `Induced behaviour`-1,
                  random = list(~1 | Study_ID,
                                ~1 | ES_ID, 
                                ~1 | Strain),
                  test = "t",
                  method = "REML", 
                  sparse = TRUE,
                  data = db)

summary(mIB)

```

```{r}
r2IB <- round(r2_ml(mIB), 4)
r2IB
```

```{r}
#| label: orchard_INDUCED_BEHAVIOUR
#| fig-width: 6
#| fig-height: 4
#| warning: false
orchard_plot(mIB,
             mod = "Induced behaviour",
              group = "Study_ID",
              xlab = "log response ratio (lnRR)", 
              angle = 30) 
```
## 8. Relative timing


```{r}
#| label: model+_relative_timing

mRT <- rma.mv(yi = lnRR,
                  V = VCV, 
              mods = ~ Relative_timing-1,
                  random = list(~1 | Study_ID,
                                ~1 | ES_ID, 
                                ~1 | Strain),
                  test = "t",
                  method = "REML", 
                  sparse = TRUE,
                  data = db)

summary(mRT)

```

```{r}
r2RT <- round(r2_ml(mRT), 4)
r2RT
```

```{r}
#| label: orchard_relative_timing
#| fig-width: 6
#| fig-height: 4
#| warning: false
orchard_plot(mRT,
             mod = "Relative_timing",
              group = "Study_ID",
              xlab = "log response ratio (lnRR)", 
              angle = 30) 
```




## 9. Experimental procedures

```{r}
#| label: model+_relative_timing

mEXP <- rma.mv(yi = lnRR,
                  V = VCV, 
              mods = ~ Experimental_procedures-1,
                  random = list(~1 | Study_ID,
                                ~1 | ES_ID, 
                                ~1 | Strain),
                  test = "t",
                  method = "REML", 
                  sparse = TRUE,
                  data = db)

summary(mEXP)

```

```{r}
r2EXP <- round(r2_ml(mEXP), 4)
r2EXP
```

```{r}
#| label: orchard_experimental_procedures
#| fig-width: 6
#| fig-height: 4
#| warning: false
orchard_plot(mEXP,
             mod = "Experimental_procedures",
              group = "Study_ID",
              xlab = "log response ratio (lnRR)", 
              angle = 30) 
```


:::
